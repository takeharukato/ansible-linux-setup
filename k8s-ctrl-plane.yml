#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
- name: Configure control planes
  hosts: k8s_ctrl_plane
  remote_user: '{{ ansible_user }}'
  become: true
  roles:
    - role: selinux
      tags: selinux
    - role: repo-deb
      tags: repo-deb
      when: ansible_facts.os_family == "Debian"
    - role: repo-rpm
      tags: repo-rpm
      when: ansible_facts.os_family == "RedHat"
    - role: common
      tags: common
    - role: ntp-client
      tags: ntp-client
    - role: aide
      tags: aide
    - role: create-users
      tags: create-users
    - role: k8s-common
      tags: k8s-common
    - role: k8s-devel
      tags: k8s-devel
    - role: k8s-shared-ca
      tags: k8s-shared-ca
    - role: k8s-ctrlplane
      tags: k8s-ctrlplane
    - role: k8s-multus
      tags: k8s-multus
    - role: k8s-whereabouts
      tags: k8s-whereabouts
      # k8s-kubeconfigの呼び出し条件を満たしたタイミングで実行
      # - common / k8s-common で基本ツールやディレクトリ整備済み。
      # - k8s-shared-ca で共通 CA が配置済み。
      # - k8s-ctrlplane で kubeadm まわりの設定・スクリプト展開が完了した後に実行。
    - role: k8s-kubeconfig
      tags: k8s-kubeconfig
    - role: k8s-hubble-cli
      tags: k8s-hubble-cli
    - role: netgauge
      tags: netgauge
    - role: sbom
      tags: sbom
      when:
        - sbom_enabled | default(false) | bool
    - role: force-reboot # 最後に実行するようにすること
      tags: force-reboot
