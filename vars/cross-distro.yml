# -*- coding: utf-8 mode: yaml -*-
# cross-distro.yml — Cross‑distro variables for Debian and RHEL
# 方針:
# - タスク側は OS 非依存モジュール ( package/systemd など )＋ when 条件のみを記述し,
#   OS 差分 ( パッケージ名・リポジトリURL・サービス名・コマンド )は本ファイルに集約します。
# - 参照例:
#     name: "{{ (ansible_facts.os_family == 'Debian') | ternary(pkgs_dns_server_debian, pkgs_dns_server_rhel) }}"
#     when: ansible_facts.os_family in ['Debian','RedHat']

########################################################################################
# 共通の基本設定
########################################################################################
pkg_autoremove_handler: "pkg-autoremove"

# パッケージマネージャ検出に依存した判定をタスクで行いやすくする補助
pkg_mgr_family_map:
  apt: debian
  aptitude: debian
  dnf: rhel
  yum: rhel

pkg_mgr: "{{ ansible_pkg_mgr | default('unknown') }}"
pkg_mgr_family: "{{ pkg_mgr_family_map[pkg_mgr] | default('unknown') }}"
pkg_mgr_is_debian: "{{ pkg_mgr_family == 'debian' }}"
pkg_mgr_is_rhel: "{{ pkg_mgr_family == 'rhel' }}"

########################################################################################
# コンフィグレーションディレクトリ
########################################################################################

# OS 固有の設定ファイル配置ディレクトリ
# /etc/default or /etc/sysconfig
etc_default_dir: "{{ ((ansible_facts.os_family | default('RedHat')) == 'Debian') | ternary('/etc/default', '/etc/sysconfig') }}"

# GRUB 設定ファイルパス
grub_default_cfg_path_rhel: "/etc/default/grub"
grub_default_cfg_path_debian: "{{ etc_default_dir }}/grub"

grub_default_cfg_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(grub_default_cfg_path_debian, grub_default_cfg_path_rhel) }}"
grub_cmdline_var_name_debian: "GRUB_CMDLINE_LINUX"
grub_cmdline_var_name_rhel: "GRUB_CMDLINE_LINUX"
grub_cmdline_var_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(grub_cmdline_var_name_debian, grub_cmdline_var_name_rhel) }}"
irq_balance_package_rhel: "irqbalance"
irq_balance_package_debian: "irqbalance"
irq_balance_package: "{{ (ansible_facts.os_family == 'Debian') | ternary(irq_balance_package_debian, irq_balance_package_rhel) }}"
########################################################################################
# ユーザ・グループ関連
########################################################################################
adm_groups_debian:
  - "adm"
  - "sudo"
adm_groups_rhel:
  - "wheel"

adm_groups: "{{ (ansible_facts.os_family == 'Debian') | ternary(adm_groups_debian, adm_groups_rhel) }}"

########################################################################################
# getent passwd フィールドインデックス
########################################################################################

# getent passwd 戻り値の GECOS フィールドを指定するインデックス
# passwd データベースフォーマット: [password(0), uid(1), gid(2), gecos(3), home(4), shell(5)]
# 現在のところ Debian/RHEL で同一だが, 将来の差分に備えて分離して定義する
getent_passwd_field_gecos_debian: 3
getent_passwd_field_gecos_rhel: 3
getent_passwd_field_gecos: "{{ (ansible_facts.os_family == 'Debian') | ternary(getent_passwd_field_gecos_debian, getent_passwd_field_gecos_rhel) }}"

##################################################################################
# kubectl シェル補完
##################################################################################
kubectl_bash_completion_path_debian: "/usr/share/bash-completion/completions/kubectl"
kubectl_bash_completion_path_rhel: "/usr/share/bash-completion/completions/kubectl"
kubectl_bash_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(kubectl_bash_completion_path_debian, kubectl_bash_completion_path_rhel) }}"

kubectl_zsh_completion_path_debian: "/usr/share/zsh/vendor-completions/_kubectl"
kubectl_zsh_completion_path_rhel: "/usr/share/zsh/site-functions/_kubectl"
kubectl_zsh_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(kubectl_zsh_completion_path_debian, kubectl_zsh_completion_path_rhel) }}"

##################################################################################
# hubble CLI シェル補完
##################################################################################
hubble_cli_bash_completion_path_debian: "/etc/bash_completion.d/hubble"
hubble_cli_bash_completion_path_rhel: "/etc/bash_completion.d/hubble"
hubble_cli_bash_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(hubble_cli_bash_completion_path_debian, hubble_cli_bash_completion_path_rhel) }}"

hubble_cli_zsh_completion_path_debian: "/usr/share/zsh/vendor-completions/_hubble"
hubble_cli_zsh_completion_path_rhel: "/usr/share/zsh/site-functions/_hubble"
hubble_cli_zsh_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(hubble_cli_zsh_completion_path_debian, hubble_cli_zsh_completion_path_rhel) }}"

##################################################################################
# Helm シェル補完
##################################################################################
helm_bash_completion_path_debian: "/etc/bash_completion.d/helm"
helm_bash_completion_path_rhel: "/etc/bash_completion.d/helm"
helm_bash_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(helm_bash_completion_path_debian, helm_bash_completion_path_rhel) }}"

helm_zsh_completion_path_debian: "/usr/share/zsh/vendor-completions/_helm"
helm_zsh_completion_path_rhel: "/usr/share/zsh/site-functions/_helm"
helm_zsh_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(helm_zsh_completion_path_debian, helm_zsh_completion_path_rhel) }}"

##################################################################################
# yq コマンドパス
##################################################################################
# Ubuntu (Debian系) / RHEL系 ともにバイナリ配置された yq を使用
# (Snapの制限を回避するため、Debian系でもバイナリを使用)
yq_command_debian: "/usr/local/bin/yq"
yq_command_rhel: "/usr/bin/yq"
yq_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(yq_command_debian, yq_command_rhel) }}"

# yq バージョン設定 (Debian/Ubuntu用)
# latest を指定すると最新版を取得、特定バージョン (例: v4.40.5) も指定可能
common_yq_version_debian: "latest"

# yq ダウンロードURL設定
yq_github_base_url: "https://github.com/mikefarah/yq/releases"
yq_download_url_debian: "{{ yq_github_base_url }}/{{ common_yq_version_debian }}/download/yq_linux_amd64"
yq_download_url_rhel: ""  # RHEL系はパッケージマネージャで管理
yq_download_url: "{{ (ansible_facts.os_family == 'Debian') | ternary(yq_download_url_debian, yq_download_url_rhel) }}"

##################################################################################
# Cilium シェル補完
##################################################################################
cilium_bash_completion_path_debian: "/etc/bash_completion.d/cilium"
cilium_bash_completion_path_rhel: "/etc/bash_completion.d/cilium"
cilium_bash_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(cilium_bash_completion_path_debian, cilium_bash_completion_path_rhel) }}"

cilium_zsh_completion_path_debian: "/usr/share/zsh/vendor-completions/_cilium"
cilium_zsh_completion_path_rhel: "/usr/share/zsh/site-functions/_cilium"
cilium_zsh_completion_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(cilium_zsh_completion_path_debian, cilium_zsh_completion_path_rhel) }}"

##################################################################################
# ネットワーク設定関連
##################################################################################

# ネットワーク設定ファイル配置ディレクトリ
netconfig_prefix: "{{ (ansible_facts.os_family == 'Debian') | ternary('/etc/netplan', '/etc/NetworkManager/system-connections') }}"

# ネットワークインターフェース用 systemd .link ファイル関連
# RHELとDebianで配置先が同一だが, 将来の差分に備えて分離して定義
netif_nm_link_dir_rhel: "/etc/systemd/network"
netif_nm_link_dir_debian: "/etc/systemd/network"
netif_nm_link_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary(netif_nm_link_dir_debian, netif_nm_link_dir_rhel) }}"

# Debian系で自動ネットワーク設定ファイルを削除する際のファイル名リスト
common_autonetconfig_files_debian:
  - '00-installer-config.yaml'
  - '50-cloud-init.yaml'

##################################################################################
# RHEL系で自動ネットワーク設定ファイルを削除する際のファイル名リスト
# RHEL9では, 基本的に使用されないが, OpenStack環境などで NIC の MAC アドレスが
# インスタンス再作成時に, セキュリティグループ・ポート再作成により,
# MAC が変わる場合や PCI アドレスが仮想マシンの都度変わる場合に,
# udev が interface 名が変わったと判断し, 過去互換の persistent-net.rules を
# 生成することがあるため, 生成されたpersistent-net.rulesを削除する目的で使用する。
##################################################################################

# udev の永続ネットワークルールファイル
# (70-persistent-net.rules)のパス一覧
udev_persistent_net_rules_paths:
  - "/etc/udev/rules.d/70-persistent-net.rules"
  - "/lib/udev/rules.d/70-persistent-net.rules"
  - "/usr/lib/udev/rules.d/70-persistent-net.rules"

# udev net generator (75-persistent-net-generator.rules)の
# パス一覧 ( 70-persistent-net.rules を生成するルールファイル )
udev_net_generator_paths:
  - "/etc/udev/rules.d/75-persistent-net-generator.rules"
  - "/usr/lib/udev/rules.d/75-persistent-net-generator.rules"
  - "/lib/udev/rules.d/75-persistent-net-generator.rules"

# 管理系 NIC の単一要素から成るデフォルト netif_list を定義する。
# 静的アドレスは空とし, IPv4 は DHCP, IPv6 は SLAAC を利用する。

# 管理系 NIC の単一要素から成るデフォルト netif_list。静的アドレスは空とする。
_netif_list_default:
  - netif: "{{ (mgmt_nic | default('', true)) if (mgmt_nic | default('', true) | length) > 0 else (common_default_nic | default('', true)) }}"
    mac: ""
    static_ipv4_addr: ""
    network_ipv4_prefix_len: 0
    gateway4: "{{ gateway4 | default('', true) }}"
    static_ipv6_addr: ""
    network_ipv6_prefix_len: 0
    gateway6: "{{ gateway6 | default('', true) }}"
    ignore_auto_ipv4_dns: "{{ _mgmt_ignore_auto_ipv4_dns }}"
    ignore_auto_ipv6_dns: "{{ _mgmt_ignore_auto_ipv6_dns }}"
    name_server_ipv4_1: "{{ ipv4_name_server1 | default('', true) }}"
    name_server_ipv4_2: "{{ ipv4_name_server2 | default('', true) }}"
    name_server_ipv6_1: "{{ ipv6_name_server1 | default('', true) }}"
    name_server_ipv6_2: "{{ ipv6_name_server2 | default('', true) }}"
    dns-search: ""

# 実効 netif_list。ユーザ定義が空または未定義なら YAML のデフォルトをそのまま採用する。
_netif_list_effective: "{{ (netif_list | default([], true)) if ((netif_list | default([], true) | length) > 0) else (_netif_list_default) }}"

########################################################################################
# ルート CA / 信頼ストア
########################################################################################
ca_trust_update_debian: "update-ca-certificates"
ca_trust_update_rhel: "update-ca-trust extract"

########################################################################################
# Firewall / ネットワーク
########################################################################################
# Debian(Ubuntu) では ufw を既定, RHEL では firewalld を既定とする想定
firewall_backend_debian:
  - ufw
firewall_backend_rhel:
  - firewalld

firewall_backend: "{{ (ansible_facts.os_family == 'Debian') | ternary(firewall_backend_debian, firewall_backend_rhel) }}"

########################################################################################
# リポジトリ
########################################################################################
# リポジトリ登録時のコードネーム
# 例: noble (24.04), jammy (22.04), focal (20.04), bionic (18.04)
repo_codename_debian: "{{ ansible_lsb.codename | default('noble') }}"
repo_codename_rhel: "{{ ansible_distribution_major_version | default('9') }}"

repo_repository_path_debian: "/etc/apt/sources.list.d"
repo_repository_path_rhel: "/etc/yum.repos.d"

repo_keyring_path_debian: "/etc/apt/keyrings"

########################################################################################
# Docker CE リポジトリと鍵
########################################################################################
# Debian/Ubuntu — apt keyring 方式
docker_repo_gpg_debian: "https://download.docker.com/linux/ubuntu/gpg"
docker_repo_url_debian: "https://download.docker.com/linux/ubuntu"
docker_keyring_path_debian: "{{ repo_keyring_path_debian }}/docker.gpg"

# RHEL/AlmaLinux — yum repository 方式
docker_repo_gpg_rhel: "https://download.docker.com/linux/centos/gpg"
docker_repo_url_rhel: "https://download.docker.com/linux/centos/9/$basearch/stable"
docker_repo_name_rhel: "docker-ce-stable"

# Docker CE パッケージ群
docker_ce_remove_packages_debian:
  - docker.io
  - docker-doc
  - docker-compose
  - docker-compose-v2
  - podman-docker
  - containerd
  - runc
  - docker-ce
  - docker
  - docker-engine

docker_ce_remove_packages_rhel:
  - docker
  - docker-client
  - docker-client-latest
  - docker-common
  - docker-latest
  - docker-latest-logrotate
  - docker-logrotate
  - docker-engine
  - docker-compose
  - docker-compose-plugin
  - podman-docker
  - containerd
  - runc
  - docker-ce
  - docker-ce-cli
  - docker-doc
  - docker.io

docker_ce_prereq_packages_debian:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release

docker_ce_prereq_packages_rhel:
  - ca-certificates
  - curl
  - gnupg2


docker_ce_packages:
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-buildx-plugin
  - docker-compose-plugin

docker_ce_remove_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(docker_ce_remove_packages_debian, docker_ce_remove_packages_rhel) }}"
docker_ce_prereq_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(docker_ce_prereq_packages_debian, docker_ce_prereq_packages_rhel) }}"

########################################################################################
# Kubernetes (pkgs.k8s.io) リポジトリと鍵
########################################################################################
# 必要に応じて固定 ( 例: "1.31" )

# Kubernetes 公開鍵 URL
k8s_pubkey_url_debian: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_major_minor }}/deb/Release.key"
k8s_pubkey_url_rhel: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_major_minor }}/rpm/repodata/repomd.xml.key"
k8s_pubkey_url: "{{ (ansible_facts.os_family == 'Debian') | ternary(k8s_pubkey_url_debian, k8s_pubkey_url_rhel) }}"

# Kubernetes リポジトリ URL
k8s_repo_url_debian: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_major_minor }}/deb/"
k8s_repo_url_rhel: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_major_minor }}/rpm/"
k8s_repo_url: "{{ (ansible_facts.os_family == 'Debian') | ternary(k8s_repo_url_debian, k8s_repo_url_rhel) }}"

# kubelet 用 resolv.conf パス
kubelet_resolv_conf_path_debian: "/run/systemd/resolve/resolv.conf"
kubelet_resolv_conf_path_rhel: "/etc/resolv.conf"
kubelet_resolv_conf_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(kubelet_resolv_conf_path_debian, kubelet_resolv_conf_path_rhel) }}"

# RHEL/AlmaLinux は yum repository 方式のため不要
k8s_keyring_path_debian: "{{ repo_keyring_path_debian }}/kubernetes-apt-keyring.gpg"

k8s_prereq_debian:
  - apt-transport-https
  - ca-certificates
  - curl
  - gpg

k8s_prereq_rhel:
  - ca-certificates
  - curl
  - gnupg2

pkgs_k8s_common_common:
  - kubelet
  - kubeadm
  - kubectl

pkgs_k8s_common_rhel: "{{ pkgs_k8s_common_common }}"
pkgs_k8s_common_debian: "{{ pkgs_k8s_common_common }}"
pkgs_k8s_common: "{{ (ansible_facts.os_family == 'Debian') | ternary(pkgs_k8s_common_debian, pkgs_k8s_common_rhel) }}"

########################################################################################
# Google Chrome リポジトリと鍵
########################################################################################
google_dl_google_pubkey_file: "linux_signing_key.pub"
google_dl_google_pubkey: "https://dl.google.com/linux/{{ google_dl_google_pubkey_file }}"
google_dl_google_pubkey_path_debian: "{{ repo_keyring_path_debian }}/google-linux.gpg"

google_chrome_repo_debian: "https://dl.google.com/linux/chrome/deb/"
google_chrome_repo_rhel: "https://dl.google.com/linux/chrome/rpm/stable/x86_64"

google_chrome_repo: "{{ (ansible_facts.os_family == 'Debian') | ternary(google_chrome_repo_debian, google_chrome_repo_rhel) }}"

########################################################################################
# Terraform リポジトリと鍵
########################################################################################
# terraformのAPTリポジトリURL
terraform_repository_url_debian: https://apt.releases.hashicorp.com
terraform_repository_url_rhel: https://rpm.releases.hashicorp.com
terraform_repository_url: "{{ terraform_repository_url_debian if ansible_facts.os_family == 'Debian' else terraform_repository_url_rhel }}"
# terraformのAPTキーリング配置先
terraform_apt_keyring_debian : /etc/apt/trusted.gpg.d/hashicorp.gpg
# terraformのAPTリポジトリ
terraform_apt_repository_debian : "deb [signed-by={{ terraform_apt_keyring_debian }}] {{ terraform_repository_url_debian }} {{ ansible_distribution_release }} main"
# terraformのリポジトリリストファイル名
terraform_apt_repository_list_debian : /etc/apt/sources.list.d/hashicorp.list

########################################################################################
# iptables 永続化パッケージ
########################################################################################
iptables_persistent_package_debian: "iptables-persistent"
iptables_services_package_rhel: "iptables-services"
iptables_persistent_package: "{{ (ansible_facts.os_family == 'Debian') | ternary(iptables_persistent_package_debian, iptables_services_package_rhel) }}"

# iptables 永続化サービス名
# Debian(Ubuntu)は, systemdサービスではないが, 便宜上サービス名として扱う
iptables_persistent_service_debian: "iptables-persistent"
iptables_persistent_service_rhel: "iptables"
iptables_persistent_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(iptables_persistent_service_debian, iptables_persistent_service_rhel) }}"

# Debian(Ubuntu)は, systemdサービスではないが, 便宜上サービス名として扱う
iptables_persistent_ipv6_service_debian: "iptables-persistent"
iptables_persistent_ipv6_service_rhel: "ip6tables"
iptables_persistent_ipv6_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(iptables_persistent_ipv6_service_debian, iptables_persistent_ipv6_service_rhel) }}"

########################################################################################
# Kea DHCP サーバー
########################################################################################

# kea-dhcp4-server パッケージ (Debian)
kea_dhcp4_server_packages_debian:
  - kea-dhcp4-server
# kea-dhcp4 パッケージ (RHEL)
kea_dhcp4_server_packages_rhel:
  - kea
# kea-dhcp4-server パッケージ名のOS別確定
kea_dhcp4_server_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(kea_dhcp4_server_packages_debian, kea_dhcp4_server_packages_rhel) }}"
# kea leaseデータベース名(Debian)
kea_lease_db_name_debian: "/var/lib/kea/kea-leases4.csv"
# kea leaseデータベース名(RHEL)
kea_lease_db_name_rhel: "/var/lib/kea/kea-dhcp4.leases"
# kea leaseデータベース名
kea_lease_db_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(kea_lease_db_name_debian, kea_lease_db_name_rhel) }}"

# kea-dhcp4-server サービス名 (Debian)
kea_dhcp4_server_service_debian: "kea-dhcp4-server"
# kea-dhcp4 サービス名 (RHEL)
kea_dhcp4_server_service_rhel: "kea-dhcp4"
# kea-dhcp4-server サービス名
kea_dhcp4_server_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(kea_dhcp4_server_service_debian, kea_dhcp4_server_service_rhel) }}"

########################################################################################
# Router Advertisement Daemon (radvd)
# 相違はないが将来の差分に備えて分離して定義
########################################################################################
radvd_package_debian: "radvd"
radvd_package_rhel: "radvd"
radvd_package: "{{ (ansible_facts.os_family == 'Debian') | ternary(radvd_package_debian, radvd_package_rhel) }}"

radvd_service_name_debian: "radvd"
radvd_service_name_rhel: "radvd"
radvd_service_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(radvd_service_name_debian, radvd_service_name_rhel) }}"

radvd_config_file_path_debian: "/etc/radvd.conf"
radvd_config_file_path_rhel: "/etc/radvd.conf"
radvd_config_file_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(radvd_config_file_path_debian, radvd_config_file_path_rhel) }}"

########################################################################################
# 時刻同期 ( クライアント/サーバ )
########################################################################################
# クライアントは systemd-timesyncd か chrony を選択可能だが, chrony に統一可能にする
# サーバは chrony を使用
ntp_client_choice: "chrony"  # "systemd-timesyncd" or "chrony"
ntp_client_is_chrony: "{{ ntp_client_choice == 'chrony' }}"
ntp_client_is_systemd_timesyncd: "{{ ntp_client_choice == 'systemd-timesyncd' }}"

# 基本パス
ntp_client_chrony_conf_dir_debian: "/etc/chrony"
ntp_client_chrony_conf_dir_rhel: "/etc"
ntp_client_chrony_conf_path_debian: "{{ ntp_client_chrony_conf_dir_debian }}/chrony.conf"
ntp_client_chrony_conf_path_rhel: "{{ ntp_client_chrony_conf_dir_rhel }}/chrony.conf"

# サービス名
ntp_client_chrony_service_debian: "chrony"
ntp_client_chrony_service_rhel: "chronyd"
ntp_client_systemd_timesyncd_conf_path: "/etc/systemd/timesyncd.conf.d/99-timesyncd.conf"
ntp_client_systemd_timesyncd_service: "systemd-timesyncd"
ntp_server_service_debian: "chrony"
ntp_server_service_rhel: "chronyd"
ntp_server_chrony_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_server_service_debian, ntp_server_service_rhel) }}"
ntp_client_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_client_is_chrony | ternary(ntp_client_chrony_service_debian, ntp_client_systemd_timesyncd_service), ntp_client_chrony_service_rhel) }}"

# OS別に確定
ntp_client_chrony_conf_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_client_chrony_conf_path_debian, ntp_client_chrony_conf_path_rhel) }}"
ntp_client_chrony_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_client_chrony_service_debian, ntp_client_chrony_service_rhel) }}"
ntp_client_chrony_conf_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_client_chrony_conf_dir_debian, ntp_client_chrony_conf_dir_rhel) }}"

# drop-in ディレクトリ
ntp_chrony_conf_drop_in_dir_debian: "/etc/chrony/conf.d"
ntp_chrony_conf_drop_in_dir_rhel: "/etc/chrony.d"

ntp_client_chrony_conf_drop_in_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_chrony_conf_drop_in_dir_debian, ntp_chrony_conf_drop_in_dir_rhel) }}"
ntp_server_chrony_conf_drop_in_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_chrony_conf_drop_in_dir_debian, ntp_chrony_conf_drop_in_dir_rhel) }}"

# confdir 用に“drop-in 側”をエスケープ
ntp_client_chrony_confdir_escaped: "{{ ntp_client_chrony_conf_drop_in_dir | regex_escape() }}"

# drop-in 配下に自前ファイルを置く場合のパス
ntp_client_chrony_conf_drop_in_path: "{{ ntp_client_chrony_conf_drop_in_dir }}/99-custom.conf"

ntp_server_service: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_server_service_debian, ntp_server_service_rhel) }}"

ntp_client_packages_debian: "{{ntp_client_is_chrony | ternary(['chrony'], ['systemd-timesyncd'])}}"
ntp_client_packages_rhel:
  - chrony

ntp_client_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_client_packages_debian, ntp_client_packages_rhel) }}"

ntp_server_packages_debian:
  - chrony
ntp_server_packages_rhel:
  - chrony
ntp_server_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(ntp_server_packages_debian, ntp_server_packages_rhel) }}"

########################################################################################
# sysctl設定関連変数
#########################################################################################

# ptrace有効化設定ファイルパス
sysctl_ptrace_conf_path_debian: "/etc/sysctl.d/10-ptrace.conf"
sysctl_ptrace_conf_path_rhel: "/etc/sysctl.d/10-ptrace.conf"
sysctl_ptrace_conf_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(sysctl_ptrace_conf_path_debian, sysctl_ptrace_conf_path_rhel) }}"

# dmesg有効化設定ファイルパス
sysctl_dmesg_conf_path_debian: "/etc/sysctl.d/10-kernel-hardening.conf"
sysctl_dmesg_conf_path_rhel: "/etc/sysctl.d/10-kernel-hardening.conf"
sysctl_dmesg_conf_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(sysctl_dmesg_conf_path_debian, sysctl_dmesg_conf_path_rhel) }}"

# ファイル監視数設定ファイルパス
# 99-sysctl.conf ではなく 90-xxx.conf として, 99-sysctl.conf で上書きされるようにする。
sysctl_inotify_conf_path_debian: "/etc/sysctl.d/90-sysctl-inotify.conf"
sysctl_inotify_conf_path_rhel: "/etc/sysctl.d/90-sysctl-inotify.conf"
sysctl_inotify_conf_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(sysctl_inotify_conf_path_debian, sysctl_inotify_conf_path_rhel) }}"

########################################################################################
# ロール別パッケージ ( Debian/RHEL で名称差あり )
########################################################################################

# common ( 最低限ユーティリティ )
pkgs_common_debian:
  - ca-certificates
  - curl
  - apt-file
  - gpg
  - gnupg
  - lsb-release

pkgs_common_rhel:
  - ca-certificates
  - curl
  - gnupg2
  - redhat-lsb-core

# devel-packages ( 開発ツール )
pkgs_devel_debian: #[build-essential, git, make, gcc, g++, pkg-config, python3, python3-pip]
  - build-essential
  - git
  - make
  - gcc
  - g++
  - pkg-config
  - python3
  - python3-pip

pkgs_devel_rhel: # [gcc, gcc-c++, make, git, pkgconfig, python3, python3-pip]
  - gcc
  - gcc-c++
  - make
  - git
  - pkgconfig
  - python3
  - python3-pip

# k8s-ctrlplane / k8s-worker で追加
pkgs_k8s_ctrlplane_extra_debian: []
pkgs_k8s_ctrlplane_extra_rhel: []
pkgs_k8s_worker_extra_debian: []
pkgs_k8s_worker_extra_rhel: []

########################################################################################
# nfs-server
########################################################################################
# NFSサーバーパッケージ
pkgs_nfs_server_debian:
  - nfs-kernel-server

pkgs_nfs_server_rhel:
  - nfs-utils

########################################################################################
# DNS サーバー ( BIND )
########################################################################################

# === パッケージ名 ===
# dns-server ( BIND )
dns_bind_package_debian:
  - bind9
  - bind9-utils

dns_bind_package_rhel:
  - bind
  - bind-utils

dns_bind_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(dns_bind_package_debian, dns_bind_package_rhel) }}"

# === 実行ユーザ/グループ/サービス名 ===
dns_bind_user: "{{ (ansible_facts.os_family == 'Debian') | ternary('bind',  'named') }}"
dns_bind_group: "{{ (ansible_facts.os_family == 'Debian') | ternary('bind',  'named') }}"
dns_bind_service: "named"

# rndc 鍵関連
# RHEL 系では /etc/rndc.key, Debian 系では /etc/bind/rndc.key に配置される
# Debian 系では, Ubuntu系では bind9 パッケージの postinst が自動で /etc/bind/rndc.key を
# (`rndc-confgen -a ...`) で生成される。Debian 系では, controls ステートメントが未定義で
# 該当キーが所定パスに存在すれば, 自動的にそのキーを読み込んでデフォルトの
# ローカルコントロール (127.0.0.1:953) を有効化するようビルドされている。
# RHEL 系では, rndc.key を生成, 参照する設定が含まれていないため,
# named.conf.options.j2 テンプレートで明示的に読み込む設定を追加している。

# rndc 鍵名
dns_rndc_key_name: "rndc-key"
# rndc 鍵パス
dns_rndc_key_path: "{{ (ansible_facts.os_family == 'Debian') | ternary('/etc/bind/rndc.key', '/etc/rndc.key') }}"

# === ディレクトリ/主要ファイル ===
# 設定ディレクトリ
dns_bind_conf_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary('/etc/bind', '/etc/named') }}"
# メイン設定ファイル
dns_bind_main_conf: "{{ (ansible_facts.os_family == 'Debian') | ternary('/etc/bind/named.conf', '/etc/named.conf') }}"
# ゾーン格納ディレクトリ
dns_bind_zone_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary('/var/lib/bind', '/var/named/zone') }}"
# ランタイム ( PID 等 )ディレクトリ ( 存在しなければ作成 )
dns_bind_run_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary('/run/named', '/run/named') }}"
# キャッシュディレクトリ
dns_bind_cache_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary('/var/cache/bind', '/var/named') }}"
# オプションファイル
dns_bind_options_conf_path: "{{ dns_bind_conf_dir }}/named.conf.options"
dns_bind_options_conf_path_escaped: "{{ dns_bind_options_conf_path | regex_escape() }}"
# === systemd 関連 ===
dns_bind_systemd_dropin_dir: "/etc/systemd/system/{{ dns_bind_service }}.service.d"
dns_bind_systemd_dropin_file: "90-override.conf"

# === SELinux 関連 ( RHEL 系のみ使用 ) ===
# SELinux のゾーン用タイプ
dns_bind_selinux_type: "named_zone_t"
# SELinux fcontext を適用するパス ( RHEL 系で /var/named 配下のみ )
dns_bind_selinux_target: "/var/named(/.*)?"
########################################################################################
# rancher ( 要 Docker; Helm はバイナリ導入前提が多いため OS パッケージは任意 )
pkgs_rancher_debian: []
pkgs_rancher_rhel: []

# user-settings ( OSパッケージに依らない前提のため空 )
pkgs_user_settings_debian: []
pkgs_user_settings_rhel: []

########################################################################################
# FRR ( FRRouting )
########################################################################################
# FRR パッケージ名
frr_packages_debian:
  - frr
frr_packages_rhel:
  - frr
frr_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(frr_packages_debian, frr_packages_rhel) }}"
frr_svc_name: "frr"
frr_vtysh_group_debian: "frrvty"
frr_vtysh_group_rhel: "frrvty"
frr_vtysh_group_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(frr_vtysh_group_debian, frr_vtysh_group_rhel) }}"

frr_group_debian: "frrvty"
frr_group_rhel: "frrvty"
frr_group_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(frr_group_debian, frr_group_rhel) }}"

########################################################################################
# Advanced Intrusion Detection Environment (AIDE)
########################################################################################
aide_packages_debian:
  - aide
aide_packages_rhel:
  - aide
aide_packages: "{{ (ansible_facts.os_family == 'Debian') | ternary(aide_packages_debian, aide_packages_rhel) }}"
# AIDE 設定ファイルパス
aide_config_path_debian: "/etc/aide/aide.conf"
aide_config_path_rhel: "/etc/aide.conf"
aide_config_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(aide_config_path_debian, aide_config_path_rhel) }}"
# AIDE データベースパス
aide_database_path_debian: "/var/lib/aide/aide.db.gz"
aide_database_path_rhel: "/var/lib/aide/aide.db.gz"
aide_database_path: "{{ (ansible_facts.os_family == 'Debian') | ternary(aide_database_path_debian, aide_database_path_rhel) }}"
# AIDE drop-in ディレクトリ
# Debian系では, /etc/aide/aide.conf.d が標準の drop-in ディレクトリ
aide_config_dropin_dir_debian: "/etc/aide/aide.conf.d"
# RHEL9系では, drop-inディレクトリが存在しない
# AIDEのバージョンが0.16であるため, @@includeディレクティブで正規表現による
# ファイルインクルードが行えないことが原因。将来的にバージョンアップで対応される
# 可能性があるため, 将来の差分に備えて変数として定義しておく。
aide_config_dropin_dir_rhel: "{{ aide_config_dropin_dir_debian }}"
aide_config_dropin_dir: "{{ (ansible_facts.os_family == 'Debian') | ternary(aide_config_dropin_dir_debian, aide_config_dropin_dir_rhel) }}"
########################################################################################
# xcp-ng ( Xen Cloud Platform Next Generation )
########################################################################################
xe_linux_service_name_debian: "xe-linux-distribution"
xe_linux_service_name_rhel: "xe-linux-distribution"
xe_linux_service_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(xe_linux_service_name_debian, xe_linux_service_name_rhel) }}"

########################################################################################
# サービス名など ( 差異が出やすいもの )
########################################################################################

# SSH デーモンは両系とも "sshd" で共通だが, 明示変数として定義しておく
sshd_service_name_debian: sshd
sshd_service_name_rhel: sshd
sshd_service_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(sshd_service_name_debian, sshd_service_name_rhel) }}"

# firewall サービス名
firewalld_service_name: firewalld
ufw_service_name: ufw
firewall_service_name: "{{ (ansible_facts.os_family == 'Debian') | ternary(ufw_service_name, firewalld_service_name) }}"

# netcat コマンド名
nc_command_debian: "nc"
# RHEL 系では nmap-ncat パッケージに含まれる nc (netcatへのシンボリックリンク) を使用
nc_command_rhel: "nc"
nc_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(nc_command_debian, nc_command_rhel) }}"

# pssh コマンド名
pssh_command_debian: "parallel-ssh"
pssh_command_rhel: "pssh"
pnuke_command_debian: "parallel-nuke"
pnuke_command_rhel: "pnuke"
prync_command_debian: "parallel-rsync"
prync_command_rhel: "prync"
pscp_command_debian: "parallel-scp"
pscp_command_rhel: "pscp"
pslurp_command_debian: "parallel-slurp"
pslurp_command_rhel: "pslurp"
pssh_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(pssh_command_debian, pssh_command_rhel) }}"
pnuke_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(pnuke_command_debian, pnuke_command_rhel) }}"
prync_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(prync_command_debian, prync_command_rhel) }}"
pscp_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(pscp_command_debian, pscp_command_rhel) }}"
pslurp_command: "{{ (ansible_facts.os_family == 'Debian') | ternary(pslurp_command_debian, pslurp_command_rhel) }}"

########################################################################################
# shell 関連
########################################################################################

# nologin シェルパス
# Debian/RHEL両系とも /usr/sbin/nologin が存在するが,
# Debian系では /usr/sbin/nologin, RHEL系では /sbin/nologin が一般的であるため,
# 互換性確保のため分離して定義する。
nologin_shell_debian: "/usr/sbin/nologin"
nologin_shell_rhel: "/sbin/nologin"
nologin_shell: "{{ (ansible_facts.os_family == 'Debian') | ternary(nologin_shell_debian, nologin_shell_rhel) }}"

########################################################################################
# 便利ユーティリティ
########################################################################################
# sysctl の永続ファイル ( 両系とも /etc/sysctl.d/*.conf を利用可能 )
sysctl_dropin_path: "/etc/sysctl.d/99-custom.conf"

# 汎用テンプレートで使える OS 判定の糖衣
is_debian: "{{ ansible_facts.os_family == 'Debian' }}"
is_rhel: "{{ ansible_facts.os_family == 'RedHat' }}"
