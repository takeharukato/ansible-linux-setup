#
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# chrony.conf
# クライアント設定
# NTPサーバ
# 起動時にNTPサーバーと迅速に同期する (iburst) 設定
{% for host in (ntp_servers_list | default([], true) | select | map('trim') | reject('equalto','') | unique) %}
server {{ host }} iburst
{% endfor %}


# マシン固有の周波数偏差（drift:ppm）を保存するファイルの場所を指定
driftfile /var/lib/chrony/drift

# システム時刻が同期状態のとき,
# カーネルが約11分ごとにRTC(ハードウェア時計)を自動更新するように設定
rtcsync

# 起動時に1秒以上のずれがある場合に補正する
# 最初の3回の更新まで, 1.0秒を超えるずれがある場合,
# 即時に“step” (一気に補正)を行うように設定
# VM/クラウドのように初期ズレが出やすい環境での
# 立ち上がり時間短縮のために設定
makestep 1.0 3

# うるう秒情報を tzdata の right/UTC ( うるう秒を含むゾーン ) から取得する
leapsectz right/UTC

# ループバックのみ許可
allow 127.0.0.1
allow ::1

# ループバック以外は不許可
deny 0.0.0.0/0
deny ::/0

# 受け付けは自ホストのみ ( lo のみで待受け )
bindaddress 127.0.0.1
bindaddress ::1

# ログ関連
# ログディレクトリの指定
logdir /var/log/chrony
# ログの種類
# 現状コメント化してあるが, コメントを外すことで,
# 以下のログを出力するように設定可能
#
# 測定ログ (measurements):
# 各上位NTPソースに対して chrony が取った個々の測定値を
# 遅延・オフセット等の生データに近い粒度で記録。
#
# 追跡ログ (tracking):
# システム全体の時刻追従状態の要約
# chronyc tracking 相当の内容が更新のたびに記録。
#
# 統計ログ (statistics): chronyの統計情報の履歴
# 各ソースの統計値の推移
# ( 平均/分散やサンプル数など, 測定の品質を見るために使用 ) 。
#
# log measurements statistics tracking

# 推定オフセットの変化が指定閾値 ( 秒 ) を超えたときに,
# イベントとしてログ ( 主に syslog/journal ) へ出力
# 0.5秒を超えた場合にログ出力する。
# ネットワーク異常, 上位NTP切替, VM再開直後のステップ補正などによる
# 急激な時刻ずれを検知するために設定
logchange 0.5
