#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  Go 公式tarballからのインストール
#
---

# パッケージ版Goを削除 (Debian系)
- name: Remove go package on Debian family
  ansible.builtin.apt:
    name: "{{ go_remove_packages_debian }}"
    state: absent
    autoremove: true
  become: true
  when:
    - not (go_installation_skipped | default(false))
    - ansible_facts.os_family == 'Debian'

# パッケージ版Goを削除 (RHEL系)
- name: Remove go package on RedHat family
  ansible.builtin.dnf:
    name: "{{ go_remove_packages_rhel }}"
    state: absent
    autoremove: true
  become: true
  when:
    - not (go_installation_skipped | default(false))
    - ansible_facts.os_family == 'RedHat'

# Go tarballダウンロードURL構築
- name: Build go download URL
  ansible.builtin.set_fact:
    go_tarball_url: "{{ go_base_url }}/go{{ go_resolved_version }}.linux-{{ go_arch }}.tar.gz"
    go_tarball_dest: "/tmp/go{{ go_resolved_version }}.linux-{{ go_arch }}.tar.gz"
  when: not (go_installation_skipped | default(false))

# Go tarballをダウンロード (ローカルに一時保存)
- name: Download go tarball to localhost
  ansible.builtin.get_url:
    url: "{{ go_tarball_url }}"
    dest: "{{ go_tarball_dest }}"
    mode: '0644'
  delegate_to: localhost
  when: not (go_installation_skipped | default(false))

# 既存のGoインストールディレクトリを削除
- name: Remove existing go installation
  ansible.builtin.file:
    path: "{{ go_install_dir }}"
    state: absent
  become: true
  when: not (go_installation_skipped | default(false))

# Go tarballを展開
- name: Extract go tarball
  ansible.builtin.unarchive:
    src: "{{ go_tarball_dest }}"
    dest: "/usr/local"
    owner: root
    group: root
    mode: '0755'
  become: true
  when: not (go_installation_skipped | default(false))

# Goコマンドパスを設定
- name: Set go command path to tarball installation
  ansible.builtin.set_fact:
    go_command: "{{ go_command_tarball }}"
  when: not (go_installation_skipped | default(false))

- name: Ensure go command symlink exists
  ansible.builtin.file:
    src: "{{ go_command_tarball }}"
    dest: "{{ go_symlink_dir }}/go"
    state: link
    owner: root
    group: root
    force: true
  become: true
  when:
    - not (go_installation_skipped | default(false))
    - go_symlink_enabled | bool

# Goバージョン確認
- name: Verify go installation
  ansible.builtin.command:
    cmd: "{{ go_command }} version"
  register: go_version_check
  changed_when: false
  failed_when: false
  become: true
  when: not (go_installation_skipped | default(false))

# バージョン表示
- name: Display installed go version
  ansible.builtin.debug:
    msg: "Installed Go version: {{ go_version_check.stdout }}"
  when:
    - not (go_installation_skipped | default(false))
    - go_version_check.rc == 0

# 一時ファイル削除
- name: Clean up temporary tarball
  ansible.builtin.file:
    path: "{{ go_tarball_dest }}"
    state: absent
  delegate_to: localhost
  when: not (go_installation_skipped | default(false))
