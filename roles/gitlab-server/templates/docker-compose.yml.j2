#
#  -*- coding:utf-8 mode: yaml -*-
# This file is generated by ansible.
#
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
#
#
# GitLabサーバ用docker-compose設定ファイル
#
services:
  # GitLabコンテナ設定
  gitlab:
    # 指定されたGitLab公式Dockerイメージを使用
    image: '{{gitlab_docker_image}}'
    container_name: {{ gitlab_container_name }} # コンテナ名をgitlabに設定
    restart: always # コンテナが停止した場合に自動的に再起動するように設定
    hostname: '{{ gitlab_hostname }}' # コンテナのホスト名を設定 (URLのホスト名と一致させる)
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # GitLab WEB UIの外部URLを設定
        external_url 'https://{{ gitlab_hostname }}:{{ gitlab_https_port }}'
        # SSH接続用ポートを設定
        gitlab_rails['gitlab_shell_ssh_port'] = {{ gitlab_ssh_port }}
        # gitユーザーのUID/GIDを明示的に設定
        user['uid'] = {{ gitlab_user_id|default(998) }}
        user['gid'] = {{ gitlab_group_id|default(998) }}
        # GitLab Container Registryを有効化
        gitlab_rails['registry_enabled'] = true
        # GitLab Container Registryの外部URLを設定
        registry_external_url 'https://{{ gitlab_hostname }}:{{ gitlab_registry_port }}'
        # logrotate設定
        logging['logrotate_frequency'] = '{{ gitlab_logrotate_frequency|default("daily", true) }}'
        logging['logrotate_maxsize'] = '{{ gitlab_logrotate_maxsize|default("10M", true) }}'
        logging['logrotate_size'] = '{{ gitlab_logrotate_size|default("10M", true) }}'
        logging['logrotate_rotate'] = {{ gitlab_logrotate_rotate|default(3, true) }}
        logging['logrotate_compress'] = '{{ gitlab_logrotate_compress|default("compress", true) }}'
    ports:
      # GitLabの各種ポートをホスト側にマッピング
      # HTTPSポート, HTTPポート, SSHポート, Registryポート
      # SSHポート(22), HTTPポート(80), HTTPSポート(443)は,
      # GitLabコンテナ内で固定で使用される。
      # HTTPポート(80)はHTTPSポートにリダイレクトされるため, マッピングしない
      # HTTPSポート, SSHポート, Registryポートのみ指定されたホスト側ポートにマッピングする

      # external_urlで指定したWEB UIサービスのポートをホスト側ポートにマッピングする
      # コンテナ内でもexternal_urlで指定したポートを使用するので,
      # ホスト側とコンテナ内で同じポート番号を使用する
      - '{{ gitlab_https_port }}:{{ gitlab_https_port }}'
      - '443:443'
      # SSHポートを指定されたホスト側ポートにマッピングする
      - '{{ gitlab_ssh_port }}:22'
      # registry_external_urlで指定したRegistryポートをホスト側ポートにマッピングする
      # コンテナ内でもregistry_external_urlで指定したRegistryポートを使用するので,
      # ホスト側とコンテナ内で同じポート番号を使用する
      - '{{ gitlab_registry_port }}:{{ gitlab_registry_port }}'
    volumes:
      # GitLabデータ永続化のためのバインドマウント設定
      # GitLab公式Dockerイメージのデフォルト構成に準拠する
      - '{{ gitlab_config_dir }}:/etc/gitlab'
      - '{{ gitlab_logs_dir }}:/var/log/gitlab'
      - '{{ gitlab_data_dir }}:/var/opt/gitlab'
    # 共有メモリサイズの設定
    # GitLab公式Dockerイメージの推奨値である256MBに設定する
    shm_size: '256m'
    # GitLab用ネットワークに接続
    networks:
      - gitlab-network

  # GitLab Runnerコンテナ設定
  gitlab-runner:
    # 指定されたGitLab Runner公式Dockerイメージを使用
    image: '{{ gitlab_runner_docker_image }}'
    # GitLab Runnerコンテナ名をgitlab-runnerに設定
    container_name: {{ gitlab_runner_container_name }}
    # コンテナが停止した場合に自動的に再起動するように設定
    restart: always
    # GitLabコンテナ起動後に起動するように設定
    depends_on:
      - gitlab
    # GitLab Runner用ボリュームマウント設定
    volumes:
      # GitLab Runner設定ファイル格納ディレクトリをバインドマウント
      # GitLab Runner公式Dockerイメージのデフォルト構成に準拠する
      - '{{ gitlab_runner_config_dir }}:/etc/gitlab-runner'
      # Dockerソケットをバインドマウントして,
      # GitLab Runnerコンテナ内からホスト側のDockerデーモンにアクセス可能とする
      - '{{ gitlab_runner_docker_sock_dir }}:/var/run/docker.sock'
    # GitLab用ネットワークに接続
    networks:
      - gitlab-network

# ネットワーク設定
networks:
  # gitlab用ネットワークをgitlabコンテナとgitlab-runnerコンテナが接続するネットワーク
  # として定義
  gitlab-network:
    name: gitlab-network
