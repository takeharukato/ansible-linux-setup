#!/usr/bin/env bash
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
# {# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# Crontab用gitlab デイリーバックアップスクリプト
# crontab -eコマンドで以下のcrontabエントリを作成する。
#以下の設定では, 毎日午前3時に`/data/gitlab/backup`にバックアップファイルを生成する。
#
#```:crontab
#0 3 * * * /data/gitlab/scripts/daily-backup-gitlab.sh
#```
#

# NFSサーバマウント時のオプション (例: "nfs.example.org:/share")
NFS_SERVER_OPT="{{gitlab_backup_nfs_server|default('nfs.example.org', true)}}:{{gitlab_backup_nfs_dir|default('/share', true)}}"
# マウント先ディレクトリ (例: "/mnt")
NFS_MOUNT_POINT="{{gitlab_backup_mount_point|default('/mnt', true)}}"
# バックアップファイル配置先 (マウント後のパス 例: "/mnt/gitlab-backups")
GITLAB_BACKUP_DIR="{{gitlab_backup_output_dir|default('/mnt/gitlab-backups', true)}}"
# Gitlabバックアップスクリプト (例: "/srv/gitlab/scripts/gitlab-backup.py")
GITLAB_BACKUP_SCRIPT="{{ gitlab_scripts_dir|default('/srv/gitlab/scripts', true) }}/{{ gitlab_backup_script_file|default('gitlab-backup.py', true) }}"
# ローカルバックアップディレクトリ (バックアップスクリプト出力先: 例: "/srv/gitlab/daily-backup")
LOCAL_BACKUP_DIR="{{ gitlab_daily_backup_dir|default('/srv/gitlab/daily-backup', true) }}"
# Gitlab バックアップバンドルファイル
GITLAB_BACKUP_BUNDLE_FILE="{{ gitlab_backup_bundle_file|default('gitlab-backup.tar.gz', true) }}"
# Gitlabバックアップ実行
# 引数: なし
# 戻り値: なし
# 説明: Gitlabバックアップスクリプトを実行する。
#   Gitlabバックアップスクリプトが存在し, 実行可能な場合に実行する。
#   Gitlabバックアップスクリプトは, Gitlabのバックアップバンドルファイルを生成し,
#   変数LOCAL_BACKUP_DIRで指定されたバックアップディレクトリにバックアップする。
#
do_backup() {

    if [ -e "${GITLAB_BACKUP_SCRIPT}" -a -x "${GITLAB_BACKUP_SCRIPT}" ]; then

        # バックアップ実行
        sudo "${GITLAB_BACKUP_SCRIPT}"
    fi
}

copy_backup() {
    local output_files_path
    local gitlab_bundle_file_base
    local day
    local rotation
    local gen

    #年間通算日数を算出
    day=`date +'%j'`

    #バックアップローテーション数
    rotation=7

    #バックアップ世代番号を算出
    gen=`expr ${day} % ${rotation}`

    sudo mount -t nfs "${NFS_SERVER_OPT}" "${NFS_MOUNT_POINT}"

    if [ $? -eq 0 ]; then

        mountpoint "${NFS_MOUNT_POINT}"
        if [ $? -eq 0 ]; then

            #マウント成功
            echo "NFS mount OK: ${NFS_MOUNT_POINT}"

            # ディレクトリ作成
            sudo mkdir -p "${GITLAB_BACKUP_DIR}"
            if [ -d "${GITLAB_BACKUP_DIR}" ]; then

                sudo chmod 777 "${GITLAB_BACKUP_DIR}"
                gitlab_bundle_file_base="$(basename "${GITLAB_BACKUP_BUNDLE_FILE}" .tar.gz)"
                output_files_path="${GITLAB_BACKUP_DIR}/${gitlab_bundle_file_base}-${gen}.tgz"
                sudo cp "${LOCAL_BACKUP_DIR}/${GITLAB_BACKUP_BUNDLE_FILE}" "${output_files_path}"
                if [ $? -eq 0 ]; then
                    echo "Gitlab backup file copied to NFS: ${output_files_path}"
                else
                    echo "Gitlab backup file copy to NFS failed: ${output_files_path}"
                fi
            fi
        fi

        sudo umount "${NFS_MOUNT_POINT}"
    fi
}

main() {

    do_backup
    copy_backup
}

main $@