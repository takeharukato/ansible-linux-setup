#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  設定関連タスク
#
---

# kube-apiが使えるようになるのを待ち合わせる
- name: Wait for kube-api-server
  ansible.builtin.wait_for:
    host: "{{ k8s_ctrlplane_endpoint }}"
    port: 6443
    state: started

# Cilium CRD の存在確認
- name: Wait for Cilium CRD availability
  ansible.builtin.command: kubectl --kubeconfig /etc/kubernetes/admin.conf get crd ciliumidentities.cilium.io
  register: cilium_crd_check
  until: cilium_crd_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false
  become: true

# Hubble Relay の存在確認
- name: Check if Hubble Relay is deployed
  ansible.builtin.command: kubectl --kubeconfig /etc/kubernetes/admin.conf get deployment -n kube-system hubble-relay
  register: hubble_relay_check
  failed_when: false
  changed_when: false
  become: true

# Hubble Relay が存在しない場合は警告を表示
- name: Warn if Hubble Relay is not enabled
  ansible.builtin.debug:
    msg: "WARNING: Hubble Relay is not enabled. Hubble UI requires Hubble Relay to function properly."
  when: hubble_relay_check.rc != 0

# Hubble UI 設定ファイル格納ディレクトリを作成
- name: Create Hubble UI config directory
  ansible.builtin.file:
    path: "{{ k8s_hubble_ui_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

# Hubble UI 用 values ファイルを生成
- name: Setup Hubble UI values file
  ansible.builtin.template:
    src: hubble-ui-values.yml.j2
    dest: "{{ k8s_hubble_ui_config_dir }}/hubble-ui-values.yml"
    owner: root
    group: root
    mode: '0644'
    backup: false
  become: true

# 既存の Helm values を取得 (マージモード時)
- name: Get existing Cilium Helm values
  ansible.builtin.shell: |
    set -o pipefail
    helm get values cilium -n kube-system -o yaml
  args:
    executable: /bin/bash
  register: helm_get_values_result
  failed_when: false
  changed_when: false
  become: true
  when: hubble_ui_merge_existing_values | default(false)

# 既存 values を一時ファイルに保存 (取得成功かつ空でない場合)
- name: Save existing values to file
  ansible.builtin.copy:
    content: "{{ helm_get_values_result.stdout }}"
    dest: "{{ k8s_hubble_ui_config_dir }}/cilium-existing-values.yml"
    owner: root
    group: root
    mode: '0644'
  become: true
  when:
    - hubble_ui_merge_existing_values | default(false)
    - helm_get_values_result.rc == 0
    - helm_get_values_result.stdout | length > 0

# 既存値と新規値をマージ (yq使用)
# 新規値（Hubble UI設定）を優先するため、右側（fileIndex==1）を後にマージ
- name: Merge existing values with Hubble UI values
  ansible.builtin.shell: |
    set -o pipefail
    set -ex
    {{ yq_command }} eval-all '. as $item ireduce ({}; . * $item)' \
      "{{ k8s_hubble_ui_config_dir }}/cilium-existing-values.yml" \
      "{{ k8s_hubble_ui_config_dir }}/hubble-ui-values.yml" \
      > "{{ k8s_hubble_ui_config_dir }}/hubble-ui-values-merged.yml" 2>&1
  args:
    executable: /bin/bash
  register: yq_merge_result
  changed_when: yq_merge_result.rc == 0
  become: true
  when:
    - hubble_ui_merge_existing_values | default(false)
    - helm_get_values_result.rc == 0
    - helm_get_values_result.stdout | length > 0

# マージ結果をデバッグ表示
- name: Display yq merge result
  ansible.builtin.debug:
    var: yq_merge_result
  when:
    - hubble_ui_merge_existing_values | default(false)
    - helm_get_values_result.rc == 0
    - helm_get_values_result.stdout | length > 0

# マージ結果を確認
- name: Check merged values file
  ansible.builtin.stat:
    path: "{{ k8s_hubble_ui_config_dir }}/hubble-ui-values-merged.yml"
  register: merged_file_stat
  become: true
  when:
    - hubble_ui_merge_existing_values | default(false)
    - helm_get_values_result.rc == 0
    - helm_get_values_result.stdout | length > 0

# マージファイルが空の場合は警告を表示
- name: Warn if merged file is empty
  ansible.builtin.debug:
    msg: "WARNING: Merged values file is empty. Will use hubble-ui-values.yml instead."
  when:
    - hubble_ui_merge_existing_values | default(false)
    - helm_get_values_result.rc == 0
    - helm_get_values_result.stdout | length > 0
    - merged_file_stat.stat.exists
    - merged_file_stat.stat.size == 0

# 使用する values ファイルを決定
- name: Set Helm values file path
  ansible.builtin.set_fact:
    hubble_ui_helm_values_file: >-
      {{
        (hubble_ui_merge_existing_values | default(false) and
         helm_get_values_result.rc == 0 and
         helm_get_values_result.stdout | length > 0 and
         merged_file_stat.stat.exists and
         merged_file_stat.stat.size > 0)
        | ternary(
            k8s_hubble_ui_config_dir + '/hubble-ui-values-merged.yml',
            k8s_hubble_ui_config_dir + '/hubble-ui-values.yml'
          )
      }}
  changed_when: false

# Helm upgrade で Hubble UI を有効化
- name: Enable Hubble UI via Helm upgrade
  ansible.builtin.shell: |
    helm upgrade --install cilium cilium/cilium \
      --namespace kube-system \
      --version {{ hubble_ui_version }} \
      -f {{ hubble_ui_helm_values_file }} \
      --wait \
      --timeout 10m
  become: true
  register: _result
  changed_when: _result.rc == 0

# Hubble UI Deployment の起動を待機
- name: Wait for Hubble UI Deployment to be available
  ansible.builtin.command: kubectl --kubeconfig /etc/kubernetes/admin.conf wait deployment/hubble-ui -n kube-system --for=condition=Available --timeout=5m
  become: true
  changed_when: false
