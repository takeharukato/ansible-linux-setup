#
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# kubelet config
# 配置先: {{etc_default_dir}}/kubelet
#
# ノードのIPv6アドレスを自動検出できない問題に対応するため, node-ipをオプションを設定
# 現象: kubectl get node -o jsonpathでInternalIPを出力した際にIPv6アドレスが付いておらず,
# cilium connectivity test で"IPv6 is enabled, but Cilium cannot find the IPv6 address for this node. "
# というメッセージが出てIPv6による通信がエラーとなる
# 原因: ノードのIPv6アドレスをK8sが検出できていない
# $ kubectl get node -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{range .status.addresses[*]}{.type}:{.address}{" "}{end}{"\n"}{end}'
# k8sctrlplane01    InternalIP:192.168.20.41 Hostname:k8sctrlplane01
# k8sworker01     InternalIP:192.168.20.42 Hostname:k8sworker01
# k8sworker02     InternalIP:192.168.20.43 Hostname:k8sworker02
# 対処: kubeletサービス起動時のKUBELET_EXTRA_ARGSに``--node-ip=自ノードのIPv4アドレス,自ノードのIPv6アドレス''を明示的に指定する
# 対処後の出力:
# $ kubectl get node -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{range .status.addresses[*]}{.type}:{.address}{" "}{end}{"\n"}{end}'
# k8sctrlplane01    InternalIP:192.168.20.41 InternalIP:fdb6:6e92:3cfb:1000::41 Hostname:k8sctrlplane
#
# さらに, --node-ipオプションを指定すると先頭のIPアドレスのアドレスファミリ以外が落ちる問題が報告されているため,
# 念のため, コントロールプレインの広告アドレス順に合わせてIPアドレスを指定するようにした
# 実際に必要かは不明だが, 問題が出にくい方向に合わせた
# 参考) https://github.com/kubernetes/kubernetes/issues/125348
#
# --node-ip は値がある時だけ付与する (--node-ipの前に空白を入れる必要があることに注意)
KUBELET_EXTRA_ARGS="{{ k8s_kubelet_extra_args_common | default('') }}{% if node_ip_arg | default('') | length > 0 %} --node-ip={{ node_ip_arg }}{% endif %}"
