#
#  -*- coding:utf-8 mode:yaml -*-
# This file is generated by ansible.
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
#
# Cilium BGP Control Plane resources
#
{% set neighbors = cilium_bgp_config.neighbors | default([], true) %}
{% set include_pod_cidr_advert = cilium_bgp_config.export_pod_cidr | default(false, true) %}
{% set include_service_advert = (cilium_bgp_config.advertise_services | default(false, true)) or (cilium_bgp_config.service_selector is defined) %}
{% set include_pod_pool_advert = cilium_bgp_config.pod_ip_pool_selector is defined %}
{% set has_advertisement = include_pod_cidr_advert or include_service_advert or include_pod_pool_advert %}
{% set service_selector = cilium_bgp_config.service_selector if cilium_bgp_config.service_selector is defined else None %}
{% set pod_pool_selector = cilium_bgp_config.pod_ip_pool_selector if cilium_bgp_config.pod_ip_pool_selector is defined else None %}
{% set service_addresses_raw = cilium_bgp_config.service_addresses if cilium_bgp_config.service_addresses is defined else ['LoadBalancerIP'] %}
{% if service_addresses_raw is string %}
{% set service_addresses = [service_addresses_raw] %}
{% else %}
{% set service_addresses = service_addresses_raw %}
{% endif %}
{% set advertisement_label_key = 'bgp.cilium.io/advertisement-group' %}
{% set advertisement_label_value = cilium_bgp_advertisement_label | default(cilium_bgp_advertisement_name, true) %}
{% set families_fallback = cilium_bgp_config.address_families | default([], true) %}

{% macro sanitize_name(value, fallback) %}
{% set raw = value | default(fallback, true) %}
{% set lowered = raw | string | lower %}
{% set cleaned = lowered | regex_replace('[^a-z0-9-]', '-') | regex_replace('^-+', '') | regex_replace('-+$', '') %}
{% if cleaned | length == 0 %}
{{ fallback }}
{% else %}
{{ cleaned }}
{% endif %}
{% endmacro %}

{% macro strip_prefix(address) %}
{% if address is defined and address is not none %}
{{ address | string | regex_replace('/[0-9]+$', '') | trim }}
{% endif %}
{% endmacro %}

{% if has_advertisement %}
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  name: {{ cilium_bgp_advertisement_name }}
  labels:
    {{ advertisement_label_key }}: {{ advertisement_label_value }}
spec:
  advertisements:
{% if include_pod_cidr_advert %}
    - advertisementType: PodCIDR
{% endif %}
{% if include_pod_pool_advert %}
    - advertisementType: CiliumPodIPPool
      selector:
{{ pod_pool_selector | to_nice_yaml(indent=6) | indent(6, False) }}
{% endif %}
{% if include_service_advert %}
    - advertisementType: Service
      service:
        addresses:
{% for address in service_addresses %}
          - {{ address }}
{% endfor %}
{% if service_selector is not none %}
      selector:
{{ service_selector | to_nice_yaml(indent=6) | indent(6, False) }}
{% else %}
      selector:
        matchLabels: {}
{% endif %}
{% endif %}
{% endif %}

{% for neighbor in neighbors %}
{% set neighbor_index = loop.index %}
{% set neighbor_name = sanitize_name(neighbor.name, 'peer-' ~ neighbor_index) %}
{% set peer_config_name = cilium_bgp_peer_config_base_name ~ '-' ~ neighbor_name %}
{% set peer_secret_name = peer_config_name ~ '-auth' %}
{% set neighbor_peer_address = strip_prefix(neighbor.peer_address) %}

{% if neighbor.password is defined %}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ peer_secret_name }}
  namespace: {{ cilium_bgp_secret_namespace }}
  labels:
    cilium.io/bgp-peer: {{ peer_config_name }}
type: Opaque
data:
  password: {{ neighbor.password | string | b64encode }}
{% endif %}

---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPPeerConfig
metadata:
  name: {{ peer_config_name }}
spec:
{% set has_transport = (neighbor.peer_port is defined) or (neighbor.source_interface is defined) %}
{% if has_transport %}
  transport:
{% if neighbor.peer_port is defined %}
    peerPort: {{ neighbor.peer_port }}
{% endif %}
{% if neighbor.source_interface is defined %}
    sourceInterface: {{ neighbor.source_interface }}
{% endif %}
{% endif %}
{% set has_timers = (neighbor.connect_retry_seconds is defined) or (neighbor.hold_time_seconds is defined) or (neighbor.keepalive_seconds is defined) %}
{% if has_timers %}
  timers:
{% if neighbor.connect_retry_seconds is defined %}
    connectRetryTimeSeconds: {{ neighbor.connect_retry_seconds }}
{% endif %}
{% if neighbor.hold_time_seconds is defined %}
    holdTimeSeconds: {{ neighbor.hold_time_seconds }}
{% endif %}
{% if neighbor.keepalive_seconds is defined %}
    keepAliveTimeSeconds: {{ neighbor.keepalive_seconds }}
{% endif %}
{% endif %}
{% if neighbor.ebgp_multihop is defined %}
  ebgpMultihop: {{ neighbor.ebgp_multihop }}
{% endif %}
{% if neighbor.graceful_restart is defined %}
  gracefulRestart:
{{ neighbor.graceful_restart | to_nice_yaml(indent=2) | indent(2, False) }}
{% endif %}
{% if neighbor.password is defined %}
  authSecretRef: {{ peer_secret_name }}
{% endif %}
{% set families = neighbor.address_families | default(families_fallback, true) %}
{% if families|length > 0 %}
  families:
{% for family in families %}
{% if family is string %}
    - afi: {{ family | lower }}
      safi: unicast
{% if has_advertisement and not (neighbor.disable_default_advertisements | default(false, true)) %}
      advertisements:
        matchLabels:
          {{ advertisement_label_key }}: {{ advertisement_label_value }}
{% endif %}
{% elif family is mapping %}
    - afi: {{ family.afi | default('ipv4', true) }}
      safi: {{ family.safi | default('unicast', true) }}
{% if family.attributes is defined %}
      attributes:
{{ family.attributes | to_nice_yaml(indent=6) | indent(6, False) }}
{% endif %}
{% if family.advertisements is defined %}
      advertisements:
{{ family.advertisements | to_nice_yaml(indent=6) | indent(6, False) }}
{% elif has_advertisement and not (family.disable_default_advertisements | default(false, true)) and not (neighbor.disable_default_advertisements | default(false, true)) %}
      advertisements:
        matchLabels:
          {{ advertisement_label_key }}: {{ advertisement_label_value }}
{% endif %}
{% else %}
    - {{ family | to_nice_yaml(indent=4) | indent(4, False) }}
{% endif %}
{% endfor %}
{% elif has_advertisement and not (neighbor.disable_default_advertisements | default(false, true)) %}
  families:
    - afi: ipv4
      safi: unicast
      advertisements:
        matchLabels:
          {{ advertisement_label_key }}: {{ advertisement_label_value }}
    - afi: ipv6
      safi: unicast
      advertisements:
        matchLabels:
          {{ advertisement_label_key }}: {{ advertisement_label_value }}
{% endif %}
{% endfor %}

---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPClusterConfig
metadata:
  name: {{ cilium_bgp_cluster_config_name }}
spec:
{% if cilium_bgp_config.node_selector is defined %}
  nodeSelector:
{{ cilium_bgp_config.node_selector | to_nice_yaml(indent=2) | indent(2, False) }}
{% else %}
  nodeSelector:
    matchLabels:
      kubernetes.io/hostname: {{ cilium_bgp_node_name }}
{% endif %}
  bgpInstances:
    - name: {{ cilium_bgp_instance_name }}
{% if cilium_bgp_config.local_asn is defined %}
      localASN: {{ cilium_bgp_config.local_asn }}
{% endif %}
{% if cilium_bgp_config.local_port is defined %}
      localPort: {{ cilium_bgp_config.local_port }}
{% endif %}
      peers:
{% for neighbor in neighbors %}
{% set neighbor_index = loop.index %}
{% set neighbor_name = sanitize_name(neighbor.name, 'peer-' ~ neighbor_index) %}
{% set neighbor_peer_address = strip_prefix(neighbor.peer_address) %}
{% set peer_config_name = cilium_bgp_peer_config_base_name ~ '-' ~ neighbor_name %}
        - name: {{ neighbor_name }}
{% if neighbor_peer_address %}
          peerAddress: {{ neighbor_peer_address }}
{% endif %}
{% if neighbor.peer_asn is defined %}
          peerASN: {{ neighbor.peer_asn }}
{% endif %}
{% if neighbor.auto_discovery is defined %}
          autoDiscovery:
{{ neighbor.auto_discovery | to_nice_yaml(indent=10) | indent(10, False) }}
{% endif %}
{% if neighbor.local_address is defined %}
          localAddress: {{ strip_prefix(neighbor.local_address) }}
{% endif %}
          peerConfigRef:
            name: {{ peer_config_name }}
{% if neighbor.additional_peer_fields is defined %}
{{ neighbor.additional_peer_fields | to_nice_yaml(indent=10) | indent(10, False) }}
{% endif %}
{% endfor %}
