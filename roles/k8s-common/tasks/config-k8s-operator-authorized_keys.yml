#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#  K8sオペレータの公開鍵を authorized_keys に追加登録するタスク
---

# k8s_operator_authorized_key_list に定義された公開鍵を
# k8s_operator_user の authorized_keys に登録する

# Kubernetes オペレータユーザの authorized_keys をまとめて整備する
- name: Configure operator authorized_keys
  become: true
  when:
    - ( ( k8s_operator_authorized_key_list | default([], true) | length ) > 0 ) or
      ( ( k8s_operator_github_key_list | default([], true) | length ) > 0 )
  block:
    # .ssh ディレクトリを作成し、所有者とパーミッションを整備する
    - name: Ensure operator .ssh directory exists
      ansible.builtin.file:
        path: "{{ k8s_operator_home }}/.ssh"
        state: directory
        owner: "{{ k8s_operator_user }}"
        group: "{{ k8s_operator_user }}"
        mode: "0700"

    # authorized_keys ファイルを作成し、所有者と権限を適切に設定する
    - name: Ensure operator authorized_keys exists
      ansible.builtin.file:
        path: "{{ k8s_operator_home }}/.ssh/authorized_keys"
        state: touch
        owner: "{{ k8s_operator_user }}"
        group: "{{ k8s_operator_user }}"
        mode: "0600"

    # k8s_operator_github_key_listに設定されたGitHubアカウントを元に公開鍵を取得し
    # authorized_keyに追加する
    - name: Import authorized key from GitHub to operate K8s nodes
      ansible.posix.authorized_key:
        user: "{{ k8s_operator_user }}"
        state: present
        key: "https://github.com/{{ item.github }}.keys"
        exclusive: false
        path: "{{ k8s_operator_home }}/.ssh/authorized_keys"
      loop: "{{ k8s_operator_github_key_list | default([], true) }}"
      when:
        - k8s_operator_user is defined
        - k8s_operator_home is defined
        - item.github is defined
        - ( k8s_operator_github_key_list | default([], true) | length ) > 0
        - ( item.github | default('', true) | length ) > 0
        - ( k8s_operator_user | default('', true) | length ) > 0
        - ( k8s_operator_home | default('', true) | length ) > 0
      become: true

    # 変数に定義された公開鍵を authorized_keys に追記する
    - name: Add operator authorized keys
      ansible.posix.authorized_key:
        user: "{{ k8s_operator_user }}"
        key: "{{ item }}"
        state: present
        path: "{{ k8s_operator_home }}/.ssh/authorized_keys"
      loop: "{{ k8s_operator_authorized_key_list | default([], true) }}"
      when:
        - k8s_operator_user is defined
        - k8s_operator_home is defined
        - ( k8s_operator_authorized_key_list | default([], true) | length ) > 0
        - ( k8s_operator_user | default('', true) | length ) > 0
        - ( k8s_operator_home | default('', true) | length ) > 0
      become: true

    # 追記後にソート・重複排除を行い、所有者と権限を再確認する
    - name: Read operator authorized_keys file
      ansible.builtin.slurp:
        src: "{{ k8s_operator_home }}/.ssh/authorized_keys"
      register: k8s_operator_keys_content
      when:
        - k8s_operator_user is defined
        - k8s_operator_home is defined
        - ( k8s_operator_user | default('', true) | length ) > 0
        - ( k8s_operator_home | default('', true) | length ) > 0
      become: true

    - name: Normalize operator authorized_keys
      ansible.builtin.copy:
        content: "{{ (k8s_operator_keys_content.content | b64decode).split('\n') | select() | unique | sort | join('\n') }}\n"
        dest: "{{ k8s_operator_home }}/.ssh/authorized_keys"
        owner: "{{ k8s_operator_user }}"
        group: "{{ k8s_operator_user }}"
        mode: "0600"
      when:
        - k8s_operator_user is defined
        - k8s_operator_home is defined
        - ( k8s_operator_user | default('', true) | length ) > 0
        - ( k8s_operator_home | default('', true) | length ) > 0
        - not k8s_operator_keys_content.skipped | default(false)
      become: true

    - name: Ensure operator .ssh directory permissions
      ansible.builtin.file:
        path: "{{ k8s_operator_home }}/.ssh"
        state: directory
        owner: "{{ k8s_operator_user }}"
        group: "{{ k8s_operator_user }}"
        mode: "0700"
      when:
        - k8s_operator_user is defined
        - k8s_operator_home is defined
        - ( k8s_operator_user | default('', true) | length ) > 0
        - ( k8s_operator_home | default('', true) | length ) > 0
      become: true
