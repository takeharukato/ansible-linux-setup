#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  設定関連タスク
#

# Containerdの設定

# overlay, br_netfilter モジュールのロード
- name: load overlay, br_netfilter modules
  shell: |
    modprobe overlay
    modprobe br_netfilter
  become: true


# moduleの設定
- name: setup modules /etc/modules-load.d/k8s.conf
  template:
    src: modules-k8s.conf.j2
    dest: /etc/modules-load.d/k8s.conf
    owner: root
    group: root
    mode: 0644
    backup: no

# IPv4/IPv6フォワーディングを有効化
- name: setup containerd /etc/sysctl.d/99-k8s-cri.conf
  template:
    src: 99-k8s-cri.conf.j2
    dest: /etc/sysctl.d/99-k8s-cri.conf
    owner: root
    group: root
    mode: 0644
    backup: no
  notify: "apply_sysctl"

- name: apply sysctl immediately
  ansible.builtin.command: sysctl --system
  become: true


#
# GRUB 設定の更新 (Debian 系)
#
- include_tasks: config-grub-debian.yml
  when:
    - ansible_facts.os_family == 'Debian'

#
# GRUB 設定の更新 (RHEL 系)
#
- include_tasks: config-grub-rhel.yml
  when:
    - ansible_facts.os_family == 'RedHat'

#
# containerd の設定
#
- name: Create /etc/systemd/system/containerd.service.d
  file:
    path: "/etc/systemd/system/containerd.service.d"
    state: directory
    owner: "root"
    group: "root"
    mode: "755"

- name: Create /etc/containerd directory
  file:
    path: "/etc/containerd"
    state: directory
    owner: "root"
    group: "root"
    mode: "755"

- name: rm /etc/containerd/config.toml
  file:
    path: "/etc/containerd/config.toml"
    state: absent
  become: true

# Containerd の設定ファイルを生成
- name: "Generate containerd config"
  shell: |
    containerd config default | sudo tee /etc/containerd/config.toml
  become: true

# Containerd 側 Cgroup ドライバーとしてSystemdを選択
- name: "Set the systemd driver as containerd cgroup driver"
  lineinfile:
    path: /etc/containerd/config.toml
    state: "present"
    backrefs: "yes"
    regexp: '^\s*SystemdCgroup\s*=\s*false\s*$'
    line: 'SystemdCgroup = true'
  become: true

# containerd config
- name: setup containerd service
  template:
    src: containerd-override.conf.j2
    dest: /etc/systemd/system/containerd.service.d/override.conf
    owner: root
    group: root
    mode: 0644
    backup: no

# restart containerd
- name: restart containerd immediately
  systemd:
    name: containerd
    state: restarted
    enabled: true
  become: true

# マシンをリブートする
- name: Reboot host gracefully
  reboot:
    reboot_timeout: 600
    msg: "Reboot triggered by role: common"
    pre_reboot_delay: 2

- name: Wait for connection after reboot
  wait_for_connection:
    timeout: 300
