#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  kubectl シェル補完設定タスク

---

# kubectl 実行ファイルの場所を確認
- name: Locate kubectl executable
  ansible.builtin.command:
    cmd: which kubectl
  register: kubectl_lookup
  changed_when: false
  failed_when: false

# kubectl シェル補完スクリプトを設定
- name: Configure kubectl shell completion scripts
  become: true
  # kubectl が存在し, シェル補完が有効な場合にのみ実行
  when:
    - kubectl_completion_enabled | default(false) | bool
    - kubectl_lookup.rc == 0
  block:
    # kubectl 実行ファイルのパスを変数に設定
    - name: Ensure bash completion directory exists
      ansible.builtin.file:
        path: "{{ kubectl_bash_completion_path | dirname }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      when:
        - (kubectl_bash_completion_path | default('', true) | length) > 0

    # kubectlのbash用補完ファイルを生成
    - name: Generate kubectl bash completion content
      ansible.builtin.command:
        cmd: kubectl completion bash
      register: kubectl_bash_completion_output
      changed_when: false
      when:
        - (kubectl_bash_completion_path | default('', true) | length) > 0

    # kubectlのbash用補完ファイルを設置
    - name: Install kubectl bash completion file
      ansible.builtin.copy:
        dest: "{{ kubectl_bash_completion_path }}"
        content: "{{ kubectl_bash_completion_output.stdout }}"
        owner: root
        group: root
        mode: "0644"
      when:
        - (kubectl_bash_completion_path | default('', true) | length) > 0

    # zsh補完ディレクトリを作成
    - name: Ensure zsh completion directory exists
      ansible.builtin.file:
        path: "{{ kubectl_zsh_completion_path | dirname }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      when:
        - (kubectl_zsh_completion_path | default('', true) | length) > 0

    # kubectlのzsh用補完ファイルを生成
    - name: Generate kubectl zsh completion content
      ansible.builtin.command:
        cmd: kubectl completion zsh
      register: kubectl_zsh_completion_output
      changed_when: false
      when:
        - (kubectl_zsh_completion_path | default('', true) | length) > 0

    # kubectlのzsh用補完ファイルを設置
    - name: Install kubectl zsh completion file
      ansible.builtin.copy:
        dest: "{{ kubectl_zsh_completion_path }}"
        content: "{{ kubectl_zsh_completion_output.stdout }}"
        owner: root
        group: root
        mode: "0644"
      when:
        - (kubectl_zsh_completion_path | default('', true) | length) > 0
