#
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

{# IPv6 のときだけ [addr]:port にする #}
{% set join_endpoint = ('[' ~ k8s_ctrlplane_endpoint ~ ']:6443') if k8s_ctrlplane_is_ipv6 else (k8s_ctrlplane_endpoint ~ ':6443') %}

#
# ワーカーノード用kubeadmのコンフィグレーションファイル
#
apiVersion: kubeadm.k8s.io/v1beta4
kind: JoinConfiguration
discovery:
  bootstrapToken:
{% if k8s_join_token_from_ctrlplane.stdout is defined and k8s_join_token_from_ctrlplane.stdout|default('',true)|length %}
    token: "{{k8s_join_token_from_ctrlplane.stdout}}"
{% else %}
{% if k8s_join_token is defined and k8s_join_token|length %}
    token: "{{k8s_join_token}}"
{% endif %}
{% endif %}
    apiServerEndpoint: "{{join_endpoint}}"
    caCertHashes:
{% if k8s_join_discovery_hash_from_ctrlplane.stdout is defined and k8s_join_discovery_hash_from_ctrlplane.stdout|default('',true)|length %}
      - "sha256:{{k8s_join_discovery_hash_from_ctrlplane.stdout}}"
{% else %}
{% if k8s_join_discovery_hash is defined and k8s_join_discovery_hash|default('',true)|length %}
      - "{{k8s_join_discovery_hash}}"
{% endif %}
{% endif %}

---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: "systemd"
resolvConf: "{{ kubelet_resolv_conf_path }}"
