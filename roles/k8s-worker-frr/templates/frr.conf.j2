!
!  -*- coding:utf-8 mode:bash -*-
! This file is generated by ansible.
!
! last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
!
! /etc/frr/frr.conf (K8s Worker FRR)
!

! ==============================================================================
! 基本設定
! ==============================================================================
! デフォルト動作を traditional モードに設定
! This setting makes FRR behave like FRR versions prior to 8.0
! FRR 8.0 以前の FRR と同様の動作にする設定
!
frr defaults traditional
! ホストに設定済みのホスト名を使用
hostname {{ ansible_hostname }}
! syslog にログを出力 (情報レベル: informational以上のログを出力)
log syslog informational
! vtysh と FRR デーモン間で設定を統合管理できるようにし,
! 単一の CLI から各プロトコル設定を永続化できるようにする。
service integrated-vtysh-config

{% set worker_frr = k8s_worker_frr %}
{% set local_asn = worker_frr.local_asn | default(0) %}
{% set router_id = worker_frr.router_id | default('') %}
{% set cluster_name = worker_frr.cluster_name | default(k8s_cilium_cm_cluster_name | default('')) %}
{% set dc_frr_addresses = worker_frr.dc_frr_addresses | default({}, true) %}
{% set dc_frr_addresses_v6 = worker_frr.dc_frr_addresses_v6 | default({}, true) %}
{% set prefix_filter = worker_frr.prefix_filter | default({}, true) %}
{% set kernel_route_filter = worker_frr.kernel_route_filter | default(None) %}
{% set clusters = worker_frr.clusters | default({}, true) %}
{% set cluster_config = clusters.get(cluster_name, {}) %}
{% set advertise_host_route_ipv4 = worker_frr.advertise_host_route_ipv4 | default('') %}
{% set advertise_host_route_ipv6 = worker_frr.advertise_host_route_ipv6 | default('') %}
{% set route_adv_method = worker_frr.route_advertisement_method | default('static') %}
{% set static_route_interface = worker_frr.static_route_interface | default(mgmt_nic | default('eth0')) %}

{% if route_adv_method == 'static' and (cluster_config.get('pod_cidrs_v4', []) or cluster_config.get('service_cidrs_v4', []) or cluster_config.get('pod_cidrs_v6', []) or cluster_config.get('service_cidrs_v6', []) or advertise_host_route_ipv4 or advertise_host_route_ipv6) %}
! ==============================================================================
! Static Route 定義 (BGP 再配送用)
! ==============================================================================
{% if advertise_host_route_ipv4 %}
! ワーカーノード自身への IPv4 ホストルート
ip route {{ advertise_host_route_ipv4 }} {{ static_route_interface }}
{% endif %}
{% for cidr in cluster_config.get('pod_cidrs_v4', []) %}
! Pod ネットワーク CIDR (IPv4): Cilium が Pod に割り当てる IP アドレス範囲
! この経路を BGP で広告することで DC 間での Pod 間通信を実現
ip route {{ cidr }} {{ static_route_interface }}
{% endfor %}
{% for cidr in cluster_config.get('service_cidrs_v4', []) %}
! Service ネットワーク CIDR (IPv4): ClusterIP 等の仮想 IP アドレス範囲
! この経路を BGP で広告することで DC 間での Service への到達性を確保
ip route {{ cidr }} {{ static_route_interface }}
{% endfor %}
{% if advertise_host_route_ipv6 %}
! ワーカーノード自身への IPv6 ホストルート
ipv6 route {{ advertise_host_route_ipv6 }} {{ static_route_interface }}
{% endif %}
{% for cidr in cluster_config.get('pod_cidrs_v6', []) %}
! Pod ネットワーク CIDR (IPv6): Cilium が Pod に割り当てる IP アドレス範囲
! この経路を BGP で広告することで DC 間での Pod 間通信を実現
ipv6 route {{ cidr }} {{ static_route_interface }}
{% endfor %}
{% for cidr in cluster_config.get('service_cidrs_v6', []) %}
! Service ネットワーク CIDR (IPv6): ClusterIP 等の仮想 IP アドレス範囲
! この経路を BGP で広告することで DC 間での Service への到達性を確保
ipv6 route {{ cidr }} {{ static_route_interface }}
{% endfor %}

{% endif %}
{% if local_asn > 0 and router_id %}
! ==============================================================================
! BGP 設定 (K8s Worker FRR)
! ==============================================================================
router bgp {{ local_asn }}
 ! router-idにhost_varsで設定した値を設定
 bgp router-id {{ router_id }}
 ! eBGP セッションでインバウンド/アウトバウンドのフィルタポリシー設定を
 ! 要求する FRR 既定のガードを無効化
 no bgp ebgp-requires-policy

 ! clear等の管理的リセットでハードリセット挙動を強制しない。
 ! 運用上, ソフトリセット寄りの挙動を志向する場合に用いられる。
 no bgp hard-administrative-reset

 ! 近年のAFI/SAFI構成に合わせ, IPv4 Unicastをデフォルト自動有効化しない。
 ! address-family配下で明示的にactivateしたピアのみ, 当該AFで経路交換する。
 no bgp default ipv4-unicast

 ! Graceful Restart (GR)に関するnotification動作を無効化
 ! GRの相互運用/挙動を抑制する意図で設定。
 no bgp graceful-restart notification

 ! --- iBGP: DC 代表 FRR ノード (IPv4) ---
{% for dc_frr_host, dc_frr_addr in dc_frr_addresses.items() %}
 ! BGP ネイバーを定義し, リモート AS 番号を指定 (local_asn と同じ = iBGP)
 neighbor {{ dc_frr_addr }} remote-as {{ local_asn }}
 ! ネイバーに説明文を設定 (管理・トラブルシューティング用の識別情報)
 neighbor {{ dc_frr_addr }} description DC-FRR {{ dc_frr_host }} (IPv4)
{% if worker_frr.rfc5549_enabled | default(false) and ((cluster_config.get('pod_cidrs_v4', []) + cluster_config.get('service_cidrs_v4', [])) | length > 0 or advertise_host_route_ipv4) %}
 ! IPv6 トランスポートで IPv4 NLRI を運ぶ (RFC 5549)
 neighbor {{ dc_frr_addr }} capability extended-nexthop
{% endif %}
{% if worker_frr.ipv4_transport_ipv6_nlri_enabled | default(false) and ((cluster_config.get('pod_cidrs_v6', []) + cluster_config.get('service_cidrs_v6', [])) | length > 0 or advertise_host_route_ipv6) %}
 ! IPv4 トランスポートで IPv6 NLRI を運ぶ
 neighbor {{ dc_frr_addr }} capability extended-nexthop
{% endif %}
{% endfor %}

 ! --- iBGP: DC 代表 FRR ノード (IPv6) ---
{% for dc_frr_host, dc_frr_addr in dc_frr_addresses_v6.items() %}
 ! BGP ネイバーを定義し, リモート AS 番号を指定 (local_asn と同じ = iBGP)
 neighbor {{ dc_frr_addr }} remote-as {{ local_asn }}
 ! ネイバーに説明文を設定 (管理・トラブルシューティング用の識別情報)
 neighbor {{ dc_frr_addr }} description DC-FRR {{ dc_frr_host }} (IPv6)
{% if worker_frr.rfc5549_enabled | default(false) and ((cluster_config.get('pod_cidrs_v4', []) + cluster_config.get('service_cidrs_v4', [])) | length > 0 or advertise_host_route_ipv4) %}
 ! IPv6 トランスポートで IPv4 NLRI を運ぶ (RFC 5549)
 neighbor {{ dc_frr_addr }} capability extended-nexthop
{% endif %}
{% endfor %}

 ! ==============================================================================
 ! IPv4 ネットワーク広告設定 (address-family ipv4 unicast)
 ! ==============================================================================
 address-family ipv4 unicast
{% if route_adv_method == 'static' %}
  ! 静的経路を BGP へ再配送
  ! FRR は再配送された静的経路の ORIGIN 属性を自動的に IGP に設定
  ! IGP は最も優先度が高く, 他ノードの経路選択で有利
  redistribute static
{% else %}
{% if advertise_host_route_ipv4 %}
  ! ワーカーノード自身への /32 ホストルート広告 (DC FRR への到達性確保)
  network {{ advertise_host_route_ipv4 }}
{% endif %}
{% for cidr in cluster_config.get('pod_cidrs_v4', []) %}
  ! Pod ネットワーク CIDR: Cilium が Pod に割り当てる IP アドレス範囲を BGP で広告
  network {{ cidr }}
{% endfor %}
{% for cidr in cluster_config.get('service_cidrs_v4', []) %}
  ! Service ネットワーク CIDR: ClusterIP 等の仮想 IP アドレス範囲を BGP で広告
  network {{ cidr }}
{% endfor %}
{% endif %}
{% for dc_frr_addr in dc_frr_addresses.values() %}
  ! DC 代表 FRR (IPv4トランスポート) への IPv4 経路広告を有効化し, 送信フィルタ RM-V4-OUT を適用
  ! (Pod/Service/Host ルートのみ許可, それ以外は拒否)
  neighbor {{ dc_frr_addr }} activate
  neighbor {{ dc_frr_addr }} route-map RM-V4-OUT out
{% endfor %}
{% if worker_frr.rfc5549_enabled | default(false) %}
{% for dc_frr_addr in dc_frr_addresses_v6.values() %}
  ! DC 代表 FRR (IPv6トランスポート) への IPv4 経路広告を有効化 (RFC 5549)
  neighbor {{ dc_frr_addr }} activate
  neighbor {{ dc_frr_addr }} route-map RM-V4-OUT out
{% endfor %}
{% endif %}
 exit-address-family

 ! ==============================================================================
 ! IPv6 ネットワーク広告設定 (address-family ipv6 unicast)
 ! ==============================================================================
 address-family ipv6 unicast
{% if route_adv_method == 'static' %}
  ! 静的経路を BGP へ再配送
  ! FRR は再配送された静的経路の ORIGIN 属性を自動的に IGP に設定
  ! IGP は最も優先度が高く, 他ノードの経路選択で有利
  redistribute static
{% else %}
{% if advertise_host_route_ipv6 %}
  ! ワーカーノード自身への /128 ホストルート広告 (DC FRR への到達性確保)
  network {{ advertise_host_route_ipv6 }}
{% endif %}
{% for cidr in cluster_config.get('pod_cidrs_v6', []) %}
  ! Pod ネットワーク CIDR: Cilium が Pod に割り当てる IP アドレス範囲を BGP で広告
  network {{ cidr }}
{% endfor %}
{% for cidr in cluster_config.get('service_cidrs_v6', []) %}
  ! Service ネットワーク CIDR: ClusterIP 等の仮想 IP アドレス範囲を BGP で広告
  network {{ cidr }}
{% endfor %}
{% endif %}
{% for dc_frr_addr in dc_frr_addresses_v6.values() %}
  ! DC 代表 FRR (IPv6トランスポート) への IPv6 経路広告を有効化し, 送信フィルタ RM-V6-OUT を適用
  ! (Pod/Service/Host ルートのみ許可, それ以外は拒否)
  neighbor {{ dc_frr_addr }} activate
  neighbor {{ dc_frr_addr }} route-map RM-V6-OUT out
{% endfor %}
{% if worker_frr.ipv4_transport_ipv6_nlri_enabled | default(false) %}
{% for dc_frr_addr in dc_frr_addresses.values() %}
  ! DC 代表 FRR (IPv4トランスポート) への IPv6 経路広告を有効化 (Multiprotocol BGP)
  neighbor {{ dc_frr_addr }} activate
  neighbor {{ dc_frr_addr }} route-map RM-V6-OUT out
{% endfor %}
{% endif %}
 exit-address-family

! ==============================================================================
! Prefix-list 定義 (送信フィルタ用)
! ==============================================================================
{% if prefix_filter.get('ipv4') %}
{% set ipv4_filter = prefix_filter.ipv4 %}
! IPv4 Pod ネットワーク用 prefix-list
! プレフィックス長が /{{ ipv4_filter.get('pod_min_length', 24) }} ～ /{{ ipv4_filter.get('pod_max_length', 28) }} の範囲の IPv4 経路を許可
! (Cilium が各ノードに割り当てる Pod CIDR の分割単位に対応)
ip prefix-list PL-V4-POD-OUT permit 0.0.0.0/0 ge {{ ipv4_filter.get('pod_min_length', 24) }} le {{ ipv4_filter.get('pod_max_length', 28) }}

! IPv4 Service ネットワーク用 prefix-list
! プレフィックス長が /{{ ipv4_filter.get('service_min_length', 16) }} ～ /{{ ipv4_filter.get('service_max_length', 24) }} の範囲の IPv4 経路を許可
! (ClusterIP 等の Service CIDR の範囲に対応)
ip prefix-list PL-V4-SVC-OUT permit 0.0.0.0/0 ge {{ ipv4_filter.get('service_min_length', 16) }} le {{ ipv4_filter.get('service_max_length', 24) }}

! IPv4 ホストルート用 prefix-list
! プレフィックス長が /32 の IPv4 経路のみを許可 (ホストルートのみ広告)
! ワーカーノード単一 IP アドレスへの到達性確保用
! (ノードが所属する /24 等のネットワーク全体は広告しない)
ip prefix-list PL-V4-HOST-OUT permit 0.0.0.0/0 ge 32 le 32
{% endif %}

{% if prefix_filter.get('ipv6') %}
{% set ipv6_filter = prefix_filter.ipv6 %}
! IPv6 Pod ネットワーク用 prefix-list
! プレフィックス長が /{{ ipv6_filter.get('pod_min_length', 56) }} ～ /{{ ipv6_filter.get('pod_max_length', 64) }} の範囲の IPv6 経路を許可
! (Cilium が各ノードに割り当てる Pod CIDR の分割単位に対応)
ipv6 prefix-list PL-V6-POD-OUT permit ::/0 ge {{ ipv6_filter.get('pod_min_length', 56) }} le {{ ipv6_filter.get('pod_max_length', 64) }}

! IPv6 Service ネットワーク用 prefix-list
! プレフィックス長が /{{ ipv6_filter.get('service_min_length', 112) }} ～ /{{ ipv6_filter.get('service_max_length', 120) }} の範囲の IPv6 経路を許可
! (ClusterIP 等の Service CIDR の範囲に対応)
ipv6 prefix-list PL-V6-SVC-OUT permit ::/0 ge {{ ipv6_filter.get('service_min_length', 112) }} le {{ ipv6_filter.get('service_max_length', 120) }}

! IPv6 ホストルート用 prefix-list
! プレフィックス長が /128 の IPv6 経路のみを許可 (ホストルートのみ広告)
! ワーカーノード単一 IP アドレスへの到達性確保用
! (ノードが所属する /64 等のネットワーク全体は広告しない)
ipv6 prefix-list PL-V6-HOST-OUT permit ::/0 ge 128 le 128
{% endif %}

{% if kernel_route_filter %}
! ==============================================================================
! Prefix-list 定義 (カーネルインポート用)
! ==============================================================================
{% if kernel_route_filter.get('ipv4') %}
{% for pl_name in kernel_route_filter.ipv4 %}
! IPv4 カーネルインポート用 prefix-list (定義は別途 host_vars で指定)
! {{ pl_name }} は host_vars で定義されている必要があります
{% endfor %}
{% endif %}

{% if kernel_route_filter.get('ipv6') %}
{% for pl_name in kernel_route_filter.ipv6 %}
! IPv6 カーネルインポート用 prefix-list (定義は別途 host_vars で指定)
! {{ pl_name }} は host_vars で定義されている必要があります
{% endfor %}
{% endif %}
{% endif %}

! ==============================================================================
! Route-map 定義 (送信フィルタ)
! ==============================================================================
! IPv4 送信用 route-map (RM-V4-OUT)
! 各エントリは優先順位番号で評価され, マッチした時点で処理終了

! エントリ 10: Pod ネットワーク経路を許可
route-map RM-V4-OUT permit 10
 match ip address prefix-list PL-V4-POD-OUT

! エントリ 20: Service ネットワーク経路を許可
route-map RM-V4-OUT permit 20
 match ip address prefix-list PL-V4-SVC-OUT

! エントリ 30: ホストルート (/32) を許可
route-map RM-V4-OUT permit 30
 match ip address prefix-list PL-V4-HOST-OUT

! エントリ 100: 上記以外の全ての経路を拒否 (デフォルト拒否)
route-map RM-V4-OUT deny 100

! IPv6 送信用 route-map (RM-V6-OUT)
! 各エントリは優先順位番号で評価され, マッチした時点で処理終了

! エントリ 10: Pod ネットワーク経路を許可
route-map RM-V6-OUT permit 10
 match ipv6 address prefix-list PL-V6-POD-OUT

! エントリ 20: Service ネットワーク経路を許可
route-map RM-V6-OUT permit 20
 match ipv6 address prefix-list PL-V6-SVC-OUT

! エントリ 30: ホストルート (/128) を許可
route-map RM-V6-OUT permit 30
 match ipv6 address prefix-list PL-V6-HOST-OUT

! エントリ 100: 上記以外の全ての経路を拒否 (デフォルト拒否)
route-map RM-V6-OUT deny 100

! ==============================================================================
! Route-map 定義 (カーネルインポート用)
! ==============================================================================
{% if kernel_route_filter %}
! BGP で学習した経路をカーネルのルーティングテーブルに反映する際のフィルタ
! 各エントリは優先順位番号で評価され, マッチした時点で処理終了
{% if kernel_route_filter.get('ipv4') %}
{% for pl_name in kernel_route_filter.ipv4 %}

! エントリ {{ loop.index }}0: {{ pl_name }} に一致する IPv4 経路を許可
route-map RM-KERNEL-IMPORT permit {{ loop.index }}0
 match ip address prefix-list {{ pl_name }}
{% endfor %}

! エントリ 100: 上記以外の全ての経路を拒否 (デフォルト拒否)
route-map RM-KERNEL-IMPORT deny 100
{% elif kernel_route_filter.get('ipv6') %}
{% for pl_name in kernel_route_filter.ipv6 %}

! エントリ {{ loop.index }}0: {{ pl_name }} に一致する IPv6 経路を許可
route-map RM-KERNEL-IMPORT permit {{ loop.index }}0
 match ipv6 address prefix-list {{ pl_name }}
{% endfor %}

! エントリ 100: 上記以外の全ての経路を拒否 (デフォルト拒否)
route-map RM-KERNEL-IMPORT deny 100
{% endif %}
{% else %}
! カーネルインポート用 route-map (RM-KERNEL-IMPORT)
! フィルタ設定がないため, BGP で学習した全ての経路をカーネルに反映

! エントリ 10: 全ての BGP 経路を無条件で許可
route-map RM-KERNEL-IMPORT permit 10
{% endif %}

! ==============================================================================
! Zebra 設定 (BGP ルートをカーネルに反映)
! ==============================================================================
! BGP で学習した経路をカーネルのルーティングテーブルに反映する設定
! Zebra デーモンが BGP から受け取った経路をカーネルに自動的にインストールする

! IPv4: BGP プロトコルで学習した経路を RM-KERNEL-IMPORT でフィルタしてカーネルに反映
ip protocol bgp route-map RM-KERNEL-IMPORT

! IPv6: BGP プロトコルで学習した経路を RM-KERNEL-IMPORT でフィルタしてカーネルに反映
ipv6 protocol bgp route-map RM-KERNEL-IMPORT

{% endif %}

! vtysh での接続設定 (未設定)
line vty
!
