!
!  -*- coding:utf-8 mode:bash -*-
! This file is generated by ansible.
!
! last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
!
! /etc/frr/frr.conf
!

! デフォルト動作を traditional モードに設定
! This setting makes FRR behave like FRR versions prior to 8.0
! FRR 8.0 以前の FRR と同様の動作にする設定
!
frr defaults traditional
! ホストに設定済みのホスト名を使用
hostname {{ ansible_hostname }}
! syslog にログを出力 (情報レベル: informational以上のログを出力)
log syslog informational
! vtysh と FRR デーモン間で設定を統合管理できるようにし、
! 単一の CLI から各プロトコル設定を永続化できるようにする。
service integrated-vtysh-config

{% if frr_bgp_asn is defined and (frr_bgp_asn | int) > 0 and frr_bgp_router_id is defined and (frr_bgp_router_id | default('', true) | trim) %}
! BGP 設定
! router-idにhost_varsで設定した値(frr_bgp_router_id)を設定
! no bgp ebgp-requires-policy
! eBGP セッションでインバウンド/アウトバウンドのフィルタポリシー設定を
! 要求する FRR 既定のガードを無効化し, これにより, ポリシー定義を
! 準備する前でもピアを確立できるようにする。
router bgp {{ frr_bgp_asn }}
 bgp router-id {{ frr_bgp_router_id }}
 no bgp ebgp-requires-policy

 ! --- iBGP: K8s ノード ---
{% for n in frr_k8s_neighbors | default([], true) %}
 neighbor {{ n.addr }} remote-as {{ n.asn }}
 neighbor {{ n.addr }} description {{ n.desc }}
{% if (':' in (n.addr | string)) and ((frr_networks_v4 | default([], true)) | length > 0) %}
 ! IPv6 トランスポートで IPv4 NLRI を運ぶ場合 (RFC 5549) に備える
 neighbor {{ n.addr }} capability extended-nexthop
{% endif %}
{% endfor %}

 ! --- eBGP: 疑似外部ネットワーク側 ---
{% for n in frr_ebgp_neighbors | default([], true) %}
 neighbor {{ n.addr }} remote-as {{ n.asn }}
 neighbor {{ n.addr }} description {{ n.desc }}
{% if (':' in (n.addr | string)) and ((frr_networks_v4 | default([], true)) | length > 0) %}
 ! IPv6 トランスポートで IPv4 NLRI を運ぶ場合 (RFC 5549) に備える
 neighbor {{ n.addr }} capability extended-nexthop
{% endif %}
{% endfor %}

 ! ipv4ネットワーク広告設定
 address-family ipv4 unicast
{% for p in frr_networks_v4 | default([], true) %}
  network {{ p }}
{% endfor %}
{% for n in (frr_k8s_neighbors | default([], true)) + (frr_ebgp_neighbors | default([], true)) %}
  neighbor {{ n.addr }} activate
{% endfor %}
 exit-address-family

 ! ipv6ネットワーク広告設定
 address-family ipv6 unicast
{% for p in frr_networks_v6 | default([], true) %}
  network {{ p }}
{% endfor %}
{% for n in (frr_k8s_neighbors | default([], true)) + (frr_ebgp_neighbors | default([], true)) %}
  neighbor {{ n.addr }} activate
{% endfor %}
 exit-address-family
{% endif %}

 ! vtysh での接続設定 (未設定)
line vty
!
