#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#  ユーザごとの公開鍵を authorized_keys に追加登録するタスク
---
# users_authorized_keys から鍵リストを抽出し, 処理対象ユーザを組み立てる
- name: Build manual authorized key entries
  ansible.builtin.set_fact:
    # manual_users_with_keys: users_authorized_keys で設定された鍵を持つユーザ情報の一時リスト
    manual_users_with_keys: "{{ (manual_users_with_keys | default([])) + [ manual_user_dict | combine({'manual_keys': manual_key_list}) ] }}"
  vars:
    # manual_key_list: 該当ユーザに定義された users_authorized_keys の鍵リスト
    manual_user_name: "{{ item.name | default('', true) }}"
    manual_user_group: "{{ item.group | default(manual_user_name, true) }}"
    manual_user_home: "{{ item.home | default('/home/' ~ manual_user_name, true) }}"
    manual_user_shell: "{{ item.shell | default('/bin/bash', true) }}"
    manual_user_comment: "{{ item.comment | default(manual_user_name, true) }}"
    manual_user_dict: "{{ item | combine({'name': manual_user_name, 'group': manual_user_group, 'home': manual_user_home, 'shell': manual_user_shell, 'comment': manual_user_comment}, recursive=true) }}"
    manual_key_list: "{{ users_authorized_keys.get(manual_user_name, []) | default([], true) }}"
  loop: "{{ users_list | default([], true) }}"
  loop_control:
    label: "{{ manual_user_name | default('unknown', true) }}"
  when:
    - ( manual_user_name | length ) > 0
    - ( manual_key_list | default([], true) | length ) > 0
    - ( users_list | default([], true) | length ) > 0
  changed_when: false

# 抽出した鍵を authorized_keys に追記する
- name: Ensure manual authorized keys are present
  ansible.builtin.authorized_key:
    # item.0: users_list のユーザ情報 (辞書)
    user: "{{ item.0.name }}"
    # item.1: users_authorized_keys で定義された公開鍵文字列
    key: "{{ item.1 }}"
    state: present
    path: "{{ item.0.home }}/.ssh/authorized_keys"
  loop: "{{ manual_users_with_keys | default([], true) | subelements('manual_keys') }}"
  loop_control:
    label: "{{ item.0.name }}"
  when:
    - manual_users_with_keys | default([], true) | length > 0
    - item.0.name is defined
    - ( item.0.name | default('', true) | length ) > 0
  become: true

# 追記後にソート・重複排除と権限整備を行う
- name: Normalize authorized_keys after manual additions
  ansible.builtin.shell: |
    set -o pipefail
    cat "{{ item.home }}/.ssh/authorized_keys" | sort | uniq | sudo -u "{{ item.name }}" tee "{{ item.home }}/.ssh/authorized_keys.tmp" >/dev/null
    sudo -u "{{ item.name }}" mv "{{ item.home }}/.ssh/authorized_keys.tmp" "{{ item.home }}/.ssh/authorized_keys"
    sudo chmod 600 "{{ item.home }}/.ssh/authorized_keys"
    sudo chown "{{ item.name }}:{{ item.group }}" "{{ item.home }}/.ssh/authorized_keys"
  args:
    executable: /bin/bash
  loop: "{{ manual_users_with_keys | default([], true) }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - ( manual_users_with_keys | default([], true) | length ) > 0
    - item.name is defined
    - ( item.name | default('', true) | length ) > 0
  become: true
