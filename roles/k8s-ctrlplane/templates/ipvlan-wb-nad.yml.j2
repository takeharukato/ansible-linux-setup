#
#  -*- coding:utf-8 mode:yaml -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# Network Attachment Definition (NAD)の設定
#

apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: ipvlan-wb
  namespace: default
spec:
  config: |
    {
      {# Container Network Interface (CNI) 仕様の版数
      ipvlan, whereabouts, bridgeの各CNI, および,
      Container Runtime (containerd)のCNIライブラリが対応している版数を指定する。
      多くの CNI/IPAM ( ipvlan・whereabouts 含む）が確実に対応している版数である
      0.3.1を指定
      #}
      "cniVersion": "0.3.1",
      {# セカンダリCNIとして, ipvlanを使用
      (本playbook作成時に使用したVM上のvNICが1つしかないため)
      #}
      "type": "ipvlan",
      {# 物理IF名 #}
      "master": "{{mgmt_nic}}",
      {# L2接続 #}
      "mode": "l2",
      {# IP Address Manager (IPAM)にwhereaboutsを使用 #}
      "ipam": {
        "type": "whereabouts",
        {# ホストNIC(VM上のvNIC)のIPv4ネットワークCIDR #}
        "range": "{{network_ipv4_cidr}}",
        {#
        IPv4アドレス付与範囲
        物理サーバのIPアドレス範囲と重複しないようにする
        #}
        "range_start": "{{k8s_whereabouts_ipv4_range_start}}",
        "range_end": "{{k8s_whereabouts_ipv4_range_end}}",
        {#
        IPv4アドレス付与範囲
        IPv6 (VM側のIPv6 IPアドレスに合わせる)
        (本playbook作成時に使用したVMがIPv6リーチャブルでないため未使用)
        #}
        {#
        "range6": "{{network_ipv6_cidr}}",
        "range_start6": "{{k8s_whereabouts_ipv6_range_start}}",
        "range_end6": "{{k8s_whereabouts_ipv6_range_end}}",
        #}
        {# ログファイル出力先 #}
        "log_file": "/var/log/whereabouts.log",
        {# ログレベル #}
        "log_level": "info"
      }
    }
