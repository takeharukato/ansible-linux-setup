#
#  -*- coding:utf-8 mode:yaml -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# コントロールプレイン用kubeadmのコンフィグレーションファイル
#
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: {{k8s_ctrlplane_endpoint}}
  bindPort: 6443
nodeRegistration:
  # 念のため, kubelet の node-ip を明示(リンクローカル/複数NICでの誤設定防止)
  kubeletExtraArgs:
    - name: node-ip
      value: "{{ kubelet_node_ip }}"
---
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
networking:
  # kubeadmのIPv6コンフィグレーションについては以下を参考
  # https://zenn.dev/imksoo/articles/0ea63d451dfd01
  # 確認方法は以下を参照
  # https://zenn.dev/pyar6329/scraps/c9307f2692b46d
  #
  # API のファミリに合わせて IPv6, IPv4 か IPv4 から IPv6 に並べ替え
  # 本項目を実施しないと, kubeadm init 時にAPIサーバが起動しない
  # service IP family "IPv4アドレス" must match public address family "IPv6アドレス"
  # または
  # service IP family "IPv6アドレス" must match public address family "IPv4アドレス"
  # というエラーになる
  # 例: APIがIPv6のとき, IPv4, IPv6の順に並んでいると以下のようなエラーになる
  # service IP family "10.245.0.0/16" must match public address family "fd69:6684:61a:1::41"
  podSubnet: {{ podSubnet_ordered }}
  serviceSubnet: {{ serviceSubnet_ordered }}
apiServer:
  extraArgs:
    # IPv4/IPv6いずれのAPIでも,確実に LISTEN させる
    - name: bind-address
      value: "{{ bind_address }}"
controllerManager:
  extraArgs:
    # IPv4/IPv6いずれのAPIでも,確実に LISTEN させる
    - name: bind-address
      value: "{{ bind_address }}"
scheduler:
  extraArgs:
    # IPv4/IPv6いずれのAPIでも,確実に LISTEN させる
    - name: bind-address
      value: "{{ bind_address }}"
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: "systemd"
resolvConf: "{{ kubelet_resolv_conf_path }}"
{% if k8s_reserved_system_cpus_default is defined and k8s_reserved_system_cpus_default|default('',true)|length %}
cpuManagerPolicy: "static"
reservedSystemCPUs: "{{k8s_reserved_system_cpus_default}}"
{% else %}
cpuManagerPolicy: "static"
{% endif %}

enforceNodeAllocatable:
  - pods
