#
#  -*- coding:utf-8 mode:yaml -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# 動作確認用Podマニュフェスト
# kubectl apply -f app-pod.yml
# を実行し
# kubectl exec demo-net1 -it -- ip addr
# kubectl exec demo-net1 -it -- ip -6 addr
# kubectl exec demo-net1 -it -- ip route
# kubectl exec demo-net1 -it -- ip -6 route
# を実行し, net1というIFがあること, デフォルトルートがCiliumのPodネットワーク側に
# 設定されていることを確認する.
# 本来は, セカンダリCNIネットワークアドレスのゲートウエイを設定する必要がある
#
# 実行例:
# ip route の以下の出力から, セカンダリCNIとCiliumのCNI(eth0)とが同一リンク(同一L2)に
# あり(scope link)
#  10.244.2.99 dev eth0 scope link
#  以下の出力から, 192.168.20.0/24 (セカンダリCNIのネットワークアドレス)宛は追加IFの net1 から直接出る ( 同一L2 ),
#  その際の送信元IPは 192.168.20.50 を使う ( 明示的な src 指定があるのは, ipvlanを使用しているため,
#  同一のPod上の仮想NICに複数のIPアドレスを付与可能であり, 代表アドレスを設定する方が,
#  返信経路の安定化のため設定している ) 。
#  192.168.20.0/24 dev net1 scope link  src 192.168.20.50
#
#  通信経路の安定化:
#    192.168.20.0/24 宛に出すパケットの送信元IPを必ず 192.168.20.50 に固定し,
#    通信相手が 192.168.20.50 宛に返信を返すようにすることで, 同じセグメント(net1)
#    に戻るようにする。これにより経路対称性を保証するという意味。
#
#    ipvlan CNI使用時にCNI側で設定されると思われるが詳細未調査。
#
#ansible@k8sctrlplane01:~$ kubectl exec demo-net1 -it -- ip addr
#1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1000
#    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
#    inet 127.0.0.1/8 scope host lo
#       valid_lft forever preferred_lft forever
#    inet6 ::1/128 scope host
#       valid_lft forever preferred_lft forever
#2: net1@net1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue
#    link/ether 00:50:56:dc:46:bc brd ff:ff:ff:ff:ff:ff
#    inet 192.168.20.50/24 brd 192.168.20.255 scope global net1
#       valid_lft forever preferred_lft forever
#    inet6 fe80::c:2900:1dc:46bc/64 scope link
#       valid_lft forever preferred_lft forever
#9: eth0@if10: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue qlen 1000
#    link/ether 2a:99:7f:de:92:1a brd ff:ff:ff:ff:ff:ff
#    inet 10.244.2.69/32 scope global eth0
#       valid_lft forever preferred_lft forever
#    inet6 fdb6:6e92:3cfb:2::86f1/128 scope global flags 02
#       valid_lft forever preferred_lft forever
#    inet6 fe80::2899:7fff:fede:921a/64 scope link
#       valid_lft forever preferred_lft forever
# ansible@k8sctrlplane01:~$ kubectl exec demo-net1 -it -- ip route
# default via 10.244.2.99 dev eth0
# 10.244.2.99 dev eth0 scope link
# 192.168.20.0/24 dev net1 scope link  src 192.168.20.50
apiVersion: v1
kind: Pod
metadata:
  name: demo-net1
  namespace: default
  annotations:
    k8s.v1.cni.cncf.io/networks: |
      [
        { "name": "ipvlan-wb" }
      ]
spec:
  containers:
  - name: app
    image: busybox:1.36
    command: ["/bin/sh","-c","ip addr; echo '---'; ip route; sleep 3600"]
