#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  設定関連タスク
#

# kube-apiが使えるようになるのを待ち合わせる
- name: wait for kube-api-server
  local_action: wait_for host={{ k8s_ctrlplane_endpoint }} port=6443 state=started

# Multus CNIインストール時のインストールパラメタ設定ファイルを生成
- name: Setup multus values file
  template:
    src: multus-install.yml.j2
    dest: "{{ k8s_multus_config_dir }}/multus-install.yml"
    owner: root
    group: root
    mode: 0644
    backup: no

# Multus CNIのインストール
- name: Install Multus
  shell: |
    helm install multus-cni bitnami/multus-cni \
    --namespace kube-system \
    --version {{ k8s_multus_helm_chart_version }} \
    -f {{ k8s_multus_config_dir }}/multus-install.yml

# テスト用Podのマニュフェスト生成
- name: Setup a test pod manifest
  template:
    src: app-pod.yml.j2
    dest: "{{ k8s_multus_config_dir }}/app-pod.yml"
    owner: root
    group: root
    mode: 0644
    backup: no
