#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#  設定関連タスク

# named.conf および ゾーンファイルの配置
- name: "Deploy {{dns_bind_conf_dir}}"
  ansible.builtin.file:
    path: "{{dns_bind_conf_dir}}"
    state: directory
    owner: root
    group: root
    mode: '0755'

# ゾーンファイル格納ディレクトリの配置
- name: "Deploy {{dns_bind_zone_dir}}"
  ansible.builtin.file:
    path: "{{dns_bind_zone_dir}}"
    state: directory
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0775'

- name: "Ensure managed-keys directory exists"
  ansible.builtin.file:
    path: "{{ dns_bind_cache_dir }}/dynamic"
    state: directory
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0750'
  when:
    - dns_bind_cache_dir | default('', true) | length > 0

# RHEL 系の場合, named.conf を「最小で安全な形」に置換する前にバックアップを取得
- name: "Backup current {{ dns_bind_main_conf }}"
  become: true
  ansible.builtin.copy:
    src: "{{ dns_bind_main_conf }}"
    dest: "{{ dns_bind_main_conf }}.bak-{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: '0644'
  when:
    - ansible_facts.os_family == "RedHat"

# named.conf を「最小で安全な形」に置換 ( 裸のディレクティブを排除 )
- name: "Write clean {{dns_bind_main_conf}} (include options file first)"
  become: true
  ansible.builtin.template:
    src: rhel-named.conf.j2
    dest: "{{dns_bind_main_conf}}"
    owner: root
    group: "{{ dns_bind_group }}"
    mode: '0644'
  when:
    - ansible_facts.os_family == "RedHat"

# named.confに自ドメインのゾーンファイル定義の読込み処理を追加する
- name: "Add zone configuration line into {{ dns_bind_main_conf }}"
  ansible.builtin.lineinfile:
    path: "{{ dns_bind_main_conf }}"
    regexp: 'include .+{{dns_bind_conf_dir}}/named\.conf\.zones.+;'
    line: 'include "{{dns_bind_conf_dir}}/named.conf.zones";'

# namedの動作オプションファイルを作成する  ( Debian系専用 )
- name: "Deploy {{ dns_bind_options_conf_path }}"
  ansible.builtin.template:
    src: named.conf.options.j2
    dest: "{{ dns_bind_options_conf_path }}"
    owner: root
    group: "{{ dns_bind_group }}"
    mode: '0640'
    backup: true
  when:
    - ansible_facts.os_family == "Debian"

# namedの動作オプションファイルを作成する ( RHEL系専用 )
- name: "Deploy {{ dns_bind_options_conf_path }} (RHEL only)"
  ansible.builtin.template:
    src: rhel-named.conf.options.j2
    dest: "{{ dns_bind_options_conf_path }}"
    owner: root
    group: "{{ dns_bind_group }}"
    mode: '0640'
    backup: true
  when:
    - ansible_facts.os_family == "RedHat"

# ゾーンファイル定義を作成する
- name: "Deploy {{dns_bind_conf_dir}}/named.conf.zones"
  ansible.builtin.template:
    src: named.conf.zones.j2
    dest: "{{dns_bind_conf_dir}}/named.conf.zones"
    owner: root
    group: "{{ dns_bind_group }}"
    mode: '0640'
    backup: true

# シリアル番号が設定されていなければ日付と時刻から生成
- ansible.builtin.set_fact:
    bind_serial: "{{ '%Y%m%d%H' | strftime() }}"
  when:
    - bind_serial is not defined

# ゾーンファイルを作成する
- name: "Deploy {{dns_bind_zone_dir}}/db.{{dns_domain}}"
  ansible.builtin.template:
    src: db.forward.conf.j2
    dest: "{{dns_bind_zone_dir}}/db.{{dns_domain}}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0644'
    backup: true

# 逆引きゾーンファイルを作成する
- name: "Deploy {{dns_bind_zone_dir}}/db.{{dns_ipv4_reverse}}"
  ansible.builtin.template:
    src: db.reverse.j2
    dest: "{{dns_bind_zone_dir}}/db.{{dns_ipv4_reverse}}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0644'
    backup: true

# 逆引きIPv6ゾーンファイルを作成する
- name: "Deploy {{dns_bind_zone_dir}}/db.{{dns_network_ipv6_prefix_filename}}"
  ansible.builtin.template:
    src: db.reverse.ipv6.j2
    dest: "{{dns_bind_zone_dir}}/db.{{dns_network_ipv6_prefix_filename}}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0644'
    backup: true

# === 複数ネットワーク逆引きゾーンファイル生成 ===
# IPv4 逆引きゾーンファイルを複数ネットワーク分作成する
- name: "Deploy IPv4 reverse zone files for additional networks"
  ansible.builtin.template:
    src: db.reverse.additional.j2
    dest: "{{dns_bind_zone_dir}}/db.{{ item.ipv4 | ipv4_reverse_zone }}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0644'
    backup: true
  when:
    - has_additional_networks
    - item.ipv4 is defined
    - item.ipv4 | length > 0
    - "'/' in item.ipv4"
  with_items: "{{ internal_network_list | default([], true) }}"
  vars:
    additional_network_cidr: "{{ item.ipv4 }}"

# IPv6 逆引きゾーンファイルを複数ネットワーク分作成する
- name: "Deploy IPv6 reverse zone files for additional networks"
  ansible.builtin.template:
    src: db.reverse.additional.ipv6.j2
    dest: "{{dns_bind_zone_dir}}/db.{{ item.ipv6 | ipv6_reverse_zone((item.ipv6.split('/')[1] if '/' in item.ipv6 else 128) | int) }}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0644'
    backup: true
  when:
    - has_additional_networks
    - item.ipv6 is defined
    - item.ipv6 | length > 0
    - "'/' in item.ipv6"
  with_items: "{{ internal_network_list | default([], true) }}"
  vars:
    additional_network_cidr: "{{ item.ipv6 }}"

# named.conf に named.conf.options の include 行がなければ追加する
- name: "Ensure include for named.conf.options is present in {{ dns_bind_main_conf }}"
  become: true
  ansible.builtin.lineinfile:
    path: "{{ dns_bind_main_conf }}"
    regexp: '^\s*include\s+"{{ dns_bind_options_conf_path_escaped }}";\s*$'
    line: 'include "{{ dns_bind_options_conf_path }}";'
    insertafter: EOF
    state: present
    backup: true
  notify:
    - "named_check_conf"
    - "Reload systemd & restart named"

- name: "Check if options file {{ dns_bind_options_conf_path }} exists"
  become: true
  ansible.builtin.stat:
    path: "{{ dns_bind_options_conf_path }}"
  register: optfile
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_selinux is defined and ansible_selinux.status != "disabled"

- name: Restore SELinux context (only if file exists)
  become: true
  ansible.builtin.command: restorecon -v "{{ dns_bind_options_conf_path }}"
  changed_when: false
  when:
    - ansible_facts.os_family == "RedHat"
    - optfile.stat.exists
    - ansible_selinux is defined and ansible_selinux.status != "disabled"

# RHEL 系かつ zone ディレクトリが /var/named 配下の場合のみ SELinux fcontext を設定
- name: Persist SELinux fcontext for named zones (RHEL only)
  ansible.builtin.command:
    cmd: "semanage fcontext -a -t {{ dns_bind_selinux_type }} '{{ dns_bind_selinux_target }}'"
  register: _semanage_add
  changed_when: _semanage_add.rc == 0
  failed_when: _semanage_add.rc not in [0,1]
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_selinux is defined and ansible_selinux.status != "disabled"
    - dns_bind_zone_dir is match('^/var/named(/|$)') or dns_bind_zone_dir is match('^/var/named/.*')

- name: Ensure SELinux fcontext rule exists (modify if already present)
  ansible.builtin.command:
    cmd: "semanage fcontext -m -t {{ dns_bind_selinux_type }} '{{ dns_bind_selinux_target }}'"
  register: _semanage_mod
  changed_when: _semanage_mod.rc == 0
  failed_when: _semanage_mod.rc not in [0,1]
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_selinux is defined and ansible_selinux.status != "disabled"
    - dns_bind_zone_dir is match('^/var/named(/|$)') or dns_bind_zone_dir is match('^/var/named/.*')

- name: Apply SELinux contexts to /var/named (RHEL only)
  ansible.builtin.command:
    cmd: restorecon -Rv /var/named
  changed_when: false
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_selinux is defined and ansible_selinux.status != "disabled"

- name: Ensure rndc key exists (RHEL only)
  become: true
  ansible.builtin.command: >-
    rndc-confgen -a -k {{ dns_rndc_key_name }} -c {{ dns_rndc_key_path }} -A hmac-sha256
  args:
    creates: "{{ dns_rndc_key_path }}"
  when:
    - ansible_facts.os_family == "RedHat"

- name: Set ownership on rndc key (RHEL only)
  become: true
  ansible.builtin.file:
    path: "{{ dns_rndc_key_path }}"
    owner: "{{ dns_bind_user }}"
    group: "{{ dns_bind_group }}"
    mode: '0600'
  when:
    - ansible_facts.os_family == "RedHat"

- name: Restore SELinux context for rndc key (RHEL only)
  become: true
  ansible.builtin.command: restorecon -v "{{ dns_rndc_key_path }}"
  changed_when: false
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_selinux is defined and ansible_selinux.status != "disabled"

# named.conf の構文とゾーンをチェック
- name: Named-checkconf (syntax & zones)
  become: true
  ansible.builtin.command: named-checkconf -z
  when:
    - ansible_facts.os_family == "RedHat"
  changed_when: false

# named サービスが起動中であることを確認する
- name: "Check if {{ dns_bind_service }} is running"
  become: true
  ansible.builtin.command: systemctl is-active {{ dns_bind_service }}
  register: named_service_state
  changed_when: false
  failed_when: false

# DNS起動中の場合は, ジャーナルの同期とクリーンアップを行う
- name: Sync and clean journals before restart
  become: true
  ansible.builtin.command: rndc sync -clean
  register: rndc_sync
  changed_when: false
  failed_when: rndc_sync.rc not in [0]
  when: named_service_state.rc == 0

# namedを起動する
- block:
    - name: systemd daemon-reload
      ansible.builtin.systemd:
        daemon_reload: true
    - name: Restart named
      ansible.builtin.systemd:
        name: "{{ dns_bind_service }}"
        state: restarted
        enabled: true
  become: true

# ゾーンファイルをリロードする
- name: "Reload zone files"
  ansible.builtin.shell: |
    rndc reload
  become: true
  register: _result
  changed_when: _result.rc == 0
