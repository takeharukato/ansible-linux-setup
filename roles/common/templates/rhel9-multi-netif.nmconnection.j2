#  -*- coding:utf-8 mode:jinja2 -*-
#
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
#
# 概要: 複数インターフェース用 NetworkManager keyfile 設定ファイルテンプレート
#
# 設置先: /etc/NetworkManager/system-connections/{{ item.netif }}.nmconnection
#
# テンプレート変数:
#
#   mgmt_nic                管理用インターフェース名 (例: eth0, ens3 など)
#
#   _netif_items タスク側で設定されるネットワークインターフェース定義リスト
#                   各要素は以下のキーを持つ辞書とする
#
#      netif                   インターフェース名 (例: eth0, ens3 など)
#      mac                     インターフェースの MAC アドレス
#      static_ipv4_addr        静的 IPv4 アドレス (例: 192.168.1.100) (省略可)
#      network_ipv4_prefix_len IPv4 プレフィックス長 (例: 24) (省略可)
#      gateway4                IPv4 デフォルトゲートウェイ (例: 192.168.1.1) (省略可)
#      static_ipv6_addr        静的 IPv6 アドレス (例: 2001:db8::100) (省略可)
#      network_ipv6_prefix_len IPv6 プレフィックス長 (例: 64) (省略可)
#      gateway6                IPv6 デフォルトゲートウェイ (例: 2001:db8::1) (省略可)
#      ignore_auto_ipv4_dns    自動取得した IPv4 DNS サーバを無視するか (true/false) (省略可)
#      ignore_auto_ipv6_dns    自動取得した IPv6 DNS サーバを無視するか (true/false) (省略可)
#      name_server_ipv4_1      優先 IPv4 DNS サーバ (例: 8.8.8.8) (省略可)
#      name_server_ipv4_2      代替 IPv4 DNS サーバ (例: 1.1.1.1) (省略可)
#      name_server_ipv6_1      優先 IPv6 DNS サーバ (例: 2001:4860:4860::8888) (省略可)
#      name_server_ipv6_2      代替 IPv6 DNS サーバ (例: 2606:4700:4700::1111) (省略可)
#      dns_search              DNS サーチドメイン (カンマ区切りの文字列, セミコロン区切りの文字列, または, リスト)
#                              (例: example.com;sub.example.com) (省略可)
#
# 注意:
# - root:root, 0600 を推奨
# - 反映は nmcli connection reload && nmcli connection up "<id>" で行う
# - Jinja2 は trim_blocks=True/lstrip_blocks=True なので, ブロック構文の直前・直後の改行が折りたたまれるため,
#   改行を入れている箇所があること(dns=, dns-search,[proxy]の前)に注意
# - netif_list に定義されているインターフェースのみ設定される
# - 静的 IP アドレスが設定されていないインターフェースは DHCP で取得する
# - DNS サーバが指定されていない場合は自動取得した DNS サーバを使用する
# - DNS サーチドメインが指定されていない場合は自動取得したサーチドメインを使用する
# - グローバル変数 ipv4_name_server1, ipv4_name_server2, ipv6_name_server1, ipv6_name_server2 が
#   定義されている場合は、各インターフェースの DNS サーバ指定がない場合に使用する
# - DNSサーバ項目の出力有無については, 以下のロジックで決定する。
#   1. 各インターフェースの ignore_auto_ipv4_dns, ignore_auto_ipv6_dns フラグを確認する
#   2. フラグが true の場合は、name_server_ipv4_1, name_server_ipv4_2,
#      name_server_ipv6_1, name_server_ipv6_2 の値を確認し、設定されていれば
#      それらを v4dns, v6dns リストに追加する
#   3. すでに構築済みの v4dns, v6dns を前提に, nameservers を出すかどうかを決める処理としている。
#      v4dns, v6dnsの双方が空だった場合は, nameservers 項目は出力しない
# - DNS サーチドメインの決定ロジック
#   netif_listのdns_searchを優先し, 無ければvars/all-config.ymlで設定された
#   dns_search変数の値を採用する。どちらも無ければ設定しない。

[connection]
id={{ item.netif }}
type=ethernet
interface-name={{ item.netif }}

{% set have_mac_address = (item.mac | default('', true) | length) %}

[ethernet]
{% if have_mac_address %}
mac-address={{ item.mac }}
{% endif %}

{# ここから計算ブロック #}
{% set gw4 = (item.gateway4 | default('', true)) %}
{% set gw6 = (item.gateway6 | default('', true)) %}

{% set have_v4_addr = (item.static_ipv4_addr | default('', true) | length)
                       and (item.network_ipv4_prefix_len is defined)
                       and (1 <= (item.network_ipv4_prefix_len | int) <= 32) %}
{% set have_v6_addr = (item.static_ipv6_addr | default('', true) | length)
                       and (item.network_ipv6_prefix_len is defined)
                       and (1 <= (item.network_ipv6_prefix_len | int) <= 128) %}
{% set have_v4_gw   = (gw4 | length) %}
{% set have_v6_gw   = (gw6 | length) %}

{% set v4_never_def = (item.never_default_ipv4 | default(false)) or (have_v4_addr and (not have_v4_gw)) %}
{% set v6_never_def = (item.never_default_ipv6 | default(false)) or (have_v6_addr and (not have_v6_gw)) %}

{# DNS search 最終値のソース ( item優先, all-configのdns_search, 無設定 ) #}

{# 候補を型を保ったまま評価して最初の有効値を採用 #}
{% if item.dns_search is defined and item.dns_search is not none
      and ((item.dns_search is string and (item.dns_search|trim)|length)
           or (item.dns_search is sequence and item.dns_search is not string and (item.dns_search|length)>0)) %}
  {% set _dns_search_raw = item.dns_search %}
{% elif item['dns_search'] is defined and item['dns_search'] is not none
      and ((item['dns_search'] is string and (item['dns_search']|trim)|length)
           or (item['dns_search'] is sequence and item['dns_search'] is not string and (item['dns_search']|length)>0)) %}
  {% set _dns_search_raw = item['dns_search'] %}
{% elif dns_search is defined and dns_search is not none
      and ((dns_search is string and (dns_search|trim)|length)
           or (dns_search is sequence and dns_search is not string and (dns_search|length)>0)) %}
  {% set _dns_search_raw = dns_search %}
{% else %}
  {% set _dns_search_raw = '' %}
{% endif %}

{# --- 配列化: リストならそのまま, 文字列なら ; / , で分割しトリム, 空要素除去 --- #}

{% if _dns_search_raw is sequence and _dns_search_raw is not string %}
  {% set _dns_search_val = (_dns_search_raw
                             | select('string')
                             | map('trim')
                             | reject('equalto','')
                             | list
                             | join(';')) %}
{% else %}
  {% set _dns_search_val = (_dns_search_raw | string | replace(',', ';') | trim) %}
{% endif %}

{# ここまで計算ブロック #}

[ipv4]
method={{ 'manual' if have_v4_addr else 'auto' }}

{% if v4_never_def %}never-default=true{% endif %}

{% if have_v4_addr %}
address1={{ item.static_ipv4_addr }}/{{ item.network_ipv4_prefix_len }}{% if have_v4_gw %},{{ gw4 }}{% endif %}
{% endif %}

{% set v4_dns_list = [] %}
{% if item.ignore_auto_ipv4_dns | default(false) %}
  {% if item.name_server_ipv4_1 | default('', true) | length %}{% set _ = v4_dns_list.append(item.name_server_ipv4_1) %}{% endif %}
  {% if item.name_server_ipv4_2 | default('', true) | length %}{% set _ = v4_dns_list.append(item.name_server_ipv4_2) %}{% endif %}
  {% if not v4_dns_list and ipv4_name_server1 | default('', true) | length %}{% set _ = v4_dns_list.append(ipv4_name_server1) %}{% endif %}
  {% if not v4_dns_list and ipv4_name_server2 | default('', true) | length %}{% set _ = v4_dns_list.append(ipv4_name_server2) %}{% endif %}

  {% if v4_dns_list %}

ignore-auto-dns=true
dns={{ v4_dns_list | join(';') }}
  {% else %}
# ignore_auto_ipv4_dns=trueを指定されたが, 手動DNS未指定のため,
# 自動DNSを維持するためignore-auto-dns は出力しない
  {% endif %}
{% else %}
  {% set extra4 = [] %}
  {% if item.name_server_ipv4_1 | default('', true) | length %}{% set _ = extra4.append(item.name_server_ipv4_1) %}{% endif %}
  {% if item.name_server_ipv4_2 | default('', true) | length %}{% set _ = extra4.append(item.name_server_ipv4_2) %}{% endif %}
  {% if not extra4 and ipv4_name_server1 | default('', true) | length %}{% set _ = extra4.append(ipv4_name_server1) %}{% endif %}
  {% if not extra4 and ipv4_name_server2 | default('', true) | length %}{% set _ = extra4.append(ipv4_name_server2) %}{% endif %}
  {% if extra4 %}dns={{ extra4 | join(';') }}{% endif %}
{% endif %}

{% if _dns_search_val | length %}dns-search={{ _dns_search_val }}{% endif %}

[ipv6]
method={{ 'manual' if have_v6_addr else 'auto' }}

{% if v6_never_def %}never-default=true{% endif %}

{% if have_v6_addr %}
address1={{ item.static_ipv6_addr }}/{{ item.network_ipv6_prefix_len }}{% if have_v6_gw %},{{ gw6 }}{% endif %}
{% endif %}

{% set v6_dns_list = [] %}
{% if item.ignore_auto_ipv6_dns | default(false) %}
  {% if item.name_server_ipv6_1 | default('', true) | length %}{% set _ = v6_dns_list.append(item.name_server_ipv6_1) %}{% endif %}
  {% if item.name_server_ipv6_2 | default('', true) | length %}{% set _ = v6_dns_list.append(item.name_server_ipv6_2) %}{% endif %}
  {% if not v6_dns_list and ipv6_name_server1 | default('', true) | length %}{% set _ = v6_dns_list.append(ipv6_name_server1) %}{% endif %}
  {% if not v6_dns_list and ipv6_name_server2 | default('', true) | length %}{% set _ = v6_dns_list.append(ipv6_name_server2) %}{% endif %}

  {% if v6_dns_list %}

ignore-auto-dns=true
dns={{ v6_dns_list | join(';') }}
  {% else %}
# ignore_auto_ipv6_dns=true だが手動DNS未指定のため、自動DNSを維持
# ignore-auto-dns は出力しない
  {% endif %}
{% else %}
  {% set extra6 = [] %}
  {% if item.name_server_ipv6_1 | default('', true) | length %}{% set _ = extra6.append(item.name_server_ipv6_1) %}{% endif %}
  {% if item.name_server_ipv6_2 | default('', true) | length %}{% set _ = extra6.append(item.name_server_ipv6_2) %}{% endif %}
  {% if not extra6 and ipv6_name_server1 | default('', true) | length %}{% set _ = extra6.append(ipv6_name_server1) %}{% endif %}
  {% if not extra6 and ipv6_name_server2 | default('', true) | length %}{% set _ = extra6.append(ipv6_name_server2) %}{% endif %}
  {% if extra6 %}dns={{ extra6 | join(';') }}{% endif %}
{% endif %}

{% if _dns_search_val | length %}dns-search={{ _dns_search_val }}{% endif %}

[proxy]
