#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  yq コマンドのインストール
#

# Ubuntu/Debian: バイナリで yq をインストール (Snapの制限を回避)
- name: Download yq binary (Debian/Ubuntu)
  ansible.builtin.get_url:
    url: "{{ yq_download_url }}"
    dest: "/tmp/yq_{{ inventory_hostname }}"
    mode: '0755'
  delegate_to: localhost
  when: ansible_facts.os_family == 'Debian'

- name: Copy yq binary to remote (Debian/Ubuntu)
  ansible.builtin.copy:
    src: "/tmp/yq_{{ inventory_hostname }}"
    dest: "{{ yq_command_debian }}"
    mode: '0755'
    owner: root
    group: root
  become: true
  when: ansible_facts.os_family == 'Debian'

# RHEL: yum/dnf で yq をインストール
- name: Install yq package (RHEL/Alma)
  ansible.builtin.package:
    name: yq
    state: present
  become: true
  when: ansible_facts.os_family == 'RedHat'

# yq コマンドのパスを確認
- name: Verify yq command is available
  command: "{{ yq_command }} --version"
  register: yq_version_check
  failed_when: false
  changed_when: false
  become: true

# yq が正常にインストールされているか確認
- name: Display yq version
  debug:
    msg: "yq version: {{ yq_version_check.stdout }}"
  when: yq_version_check.rc == 0

# yq のインストールに失敗した場合は警告
- name: Warn if yq installation failed
  debug:
    msg: "WARNING: yq command is not available at {{ yq_command }}. Some features may not work."
  when: yq_version_check.rc != 0
