#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  VM/言語パッケージ関連処理
#

# multicast DNS
- name: Install multicast DNS packages
  ansible.builtin.package:
    pkg:
      '{{ common_mdns_packages }}'
    state: latest
  notify:
    - avahi_restarted_and_enabled
  when:
    - mdns_enabled | default(false) | bool

# 言語パッケージのインストール
- name: Install language packages
  ansible.builtin.package:
    pkg:
      '{{ common_langpack_packages }}'
    state: latest
  notify: disable_gui

# VMware packages
- name: Install VMware packages
  ansible.builtin.package:
    pkg:
      '{{ common_vmware_packages }}'
    state: latest
  when: use_vmware | default(false) | bool
  notify:
    - disable_gui
    - pkg-autoremove

# xcp-ng client packages
- name: Install xcp-ng packages
  ansible.builtin.shell: |
    set -e
    if [ "{{ ansible_facts.os_family }}" = "Debian" ]; then
      curl -fsSL -o /tmp/xe-guest-utilities.deb "{{ xcpng_xe_guest_utilities_deb_url }}"
      dpkg -i /tmp/xe-guest-utilities.deb || apt-get -f install -y
    else
      curl -fsSL -o /tmp/xe-guest-utilities.rpm "{{ xcpng_xe_guest_utilities_rpm_url }}"
      curl -fsSL -o /tmp/xe-guest-utilities-xenstore.rpm "{{ xcpng_xen_store_rpm_url }}"
      dnf install -y /tmp/xe-guest-utilities.rpm /tmp/xe-guest-utilities-xenstore.rpm
    fi
  when: use_xcpng | default(false) | bool
  notify:
    - disable_gui
    - pkg-autoremove
