#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  外部リポジトリ関連タスク
#

# Docker Community Editionのキーリングを配置する
- name: Docker keyring
  when: repo_enable_docker
  shell: |
    curl -fsSL "{{ docker_apt_keyring_url }}" | gpg --dearmor > "{{ docker_apt_keyring }}"
    chmod 0644 "{{ docker_apt_keyring }}"

# Docker repo (deb822)を有効にする
- name: Docker repo (deb822)
  when: repo_enable_docker
  ansible.builtin.deb822_repository:
    name: "docker"
    types:
      - "deb"
    uris: "{{ docker_apt_uri }}"
    suites: "{{ docker_apt_suite }}"
    components: "{{ docker_apt_components }}"
    architectures: "{{ docker_arch_apt }}"
    enabled: true
    signed_by: "{{ docker_apt_keyring }}"
  notify: "apt update"

# Kubernetesのキーリングを配置する
- name: Kubernetes keyring
  when: repo_enable_kubernetes
  shell: |
    curl -fsSL "{{ k8s_apt_keyring_url }}" | gpg --dearmor > "{{ k8s_apt_keyring }}"
    chmod 0644 "{{ k8s_apt_keyring }}"

# Kubernetes repo (deb822)を有効にする
- name: Kubernetes repo (deb822)
  when: repo_enable_kubernetes
  ansible.builtin.deb822_repository:
    name: "kubernetes"
    types: "deb"
    uris: "{{ k8s_apt_uri }}"
    suites: "{{ k8s_apt_suites }}"
    components: "{{ k8s_apt_components }}"
    enabled: true
    signed_by: "{{ k8s_apt_keyring }}"
  notify: "apt update"

# Google Chrome
- name: Chrome keyring
  when: repo_enable_chrome
  shell: |
    curl -fsSL "{{ chrome_keyring_url }}" | gpg --dearmor > "{{ chrome_keyring_path }}"
    chmod 0644 "{{ chrome_keyring_path }}"

# Chrome repo (deb822)を有効にする
- name: Chrome repo (deb822)
  when: repo_enable_chrome
  ansible.builtin.deb822_repository:
    name: "google-chrome"
    types: "deb"
    uris: "{{ chrome_apt_uri }}"
    suites: "{{ chrome_apt_suite }}"
    components: "{{ chrome_apt_components }}"
    architectures: "{{ chrome_arch_apt }}"
    enabled: true
    signed_by: "{{ chrome_keyring_path }}"
  notify: "apt update"

# Pinning ( 外部を下げる）
- name: Pin external origins lower than base
  ansible.builtin.copy:
    dest: "/etc/apt/preferences.d/99-external.pref"
    mode: "0644"
    content: |
      Package: *
      Pin: origin "download.docker.com"
      Pin-Priority: {{ pin_external|int }}

      Package: *
      Pin: origin "pkgs.k8s.io"
      Pin-Priority: {{ pin_external|int }}

      Package: *
      Pin: origin "dl.google.com"
      Pin-Priority: {{ pin_external|int }}
