#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  Debian/Ubuntu リポジトリ関連処理
#

# 基本パッケージのインストール
- name: Ensure base deps
  ansible.builtin.package:
    name:
    - ca-certificates
    - gpg
    state: present

# ディストリビューション固有タスクの読み込み（ディストリビューションとAnsibleバージョンに基づいた分岐）
# deb822_repository モジュールは Ansible 2.15 以降で利用可能

# Debian用
- name: Include Debian tasks (Ansible >= 2.15)
  ansible.builtin.include_tasks: debian.yml
  when:
    - ansible_distribution == "Debian"
    - ansible_version.major > 2 or (ansible_version.major == 2 and ansible_version.minor >= 15)

- name: Include Debian tasks (Ansible < 2.15)
  ansible.builtin.include_tasks: debian-on-rhel9.yml
  when:
    - ansible_distribution == "Debian"
    - ansible_version.major < 2 or (ansible_version.major == 2 and ansible_version.minor < 15)

# Ubuntu用
- name: Include Ubuntu tasks
  ansible.builtin.include_tasks: ubuntu.yml
  when: ansible_distribution == "Ubuntu"

# 外部リポジトリの読み込み（Ansible バージョンに基づいた分岐）
- name: Include external repositories (Ansible >= 2.15)
  ansible.builtin.include_tasks: external.yml
  when: ansible_version.major > 2 or (ansible_version.major == 2 and ansible_version.minor >= 15)

- name: Include external repositories (Ansible < 2.15)
  ansible.builtin.include_tasks: external-on-rhel9.yml
  when: ansible_version.major < 2 or (ansible_version.major == 2 and ansible_version.minor < 15)

# パッケージの更新情報を取得する
- name: Apt update forcefully
  ansible.builtin.command: apt-get update -o Acquire::https::Verify-Peer={{ 'true' if apt_sslverify else 'false' }}
  changed_when: true
