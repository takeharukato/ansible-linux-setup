#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  Ubuntu固有リポジトリ関連タスク
#

# Ubuntu deb822 ソースを設定する
- name: Remove legacy repo-deb deb822 sources
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/{{ item }}"
    state: absent
  loop:
    - "ubuntu-main.sources"
    - "ubuntu-updates.sources"
    - "ubuntu-security.sources"
    - "ubuntu-backports.sources"
  notify: "apt_update_repo_deb"

- name: Install consolidated ubuntu.sources
  ansible.builtin.template:
    src: "ubuntu.sources.j2"
    dest: "/etc/apt/sources.list.d/ubuntu.sources"
    owner: "root"
    group: "root"
    mode: "0644"
  notify: "apt_update_repo_deb"

# Docker Community Editionのキーリングを配置する
- name: Docker keyring
  when: repo_enable_docker
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL "{{ docker_apt_keyring_url }}" | gpg --dearmor > "{{ docker_apt_keyring }}"
    chmod 0644 "{{ docker_apt_keyring }}"
  args:
    executable: /bin/bash
  register: _result
  changed_when: _result.rc == 0

# 古いDocker repo形式を削除
- name: Remove legacy Docker repo
  when: repo_enable_docker
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/docker.list"
    state: absent
  notify: "apt_update_repo_deb"

# Docker repo (deb822)を有効にする
- name: Docker repo (deb822)
  when: repo_enable_docker
  ansible.builtin.deb822_repository:
    name: "Docker"
    types:
      - "deb"
    uris: "{{ docker_apt_uri }}"
    suites: "{{ docker_apt_suite }}"
    components: "{{ docker_apt_components }}"
    architectures: "{{ docker_arch_apt }}"
    enabled: true
    signed_by: "{{ docker_apt_keyring }}"
  notify: "apt_update_repo_deb"

# Kubernetesのキーリングを配置する
- name: Kubernetes keyring
  when: repo_enable_kubernetes
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL "{{ k8s_apt_keyring_url }}" | gpg --dearmor > "{{ k8s_apt_keyring }}"
    chmod 0644 "{{ k8s_apt_keyring }}"
  args:
    executable: /bin/bash
  register: _result
  changed_when: _result.rc == 0

# 古いKubernetes repo形式を削除
- name: Remove legacy Kubernetes repo
  when: repo_enable_kubernetes
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/kubernetes.list"
    state: absent
  notify: "apt_update_repo_deb"

# Kubernetes repo (deb822)を有効にする
- name: Kubernetes repo (deb822)
  when: repo_enable_kubernetes
  ansible.builtin.deb822_repository:
    name: "Kubernetes"
    types: "deb"
    uris: "{{ k8s_apt_uri }}"
    suites: "{{ k8s_apt_suites }}"
    components: "{{ k8s_apt_components }}"
    enabled: true
    signed_by: "{{ k8s_apt_keyring }}"
  notify: "apt_update_repo_deb"

# Google Chrome
- name: Chrome keyring
  when: repo_enable_chrome
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL "{{ chrome_keyring_url }}" | gpg --dearmor > "{{ chrome_keyring_path }}"
    chmod 0644 "{{ chrome_keyring_path }}"
  args:
    executable: /bin/bash
  register: _result
  changed_when: _result.rc == 0

# 古いChrome repo形式を削除
- name: Remove legacy Google Chrome repo
  when: repo_enable_chrome
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/google-chrome.list"
    state: absent
  notify: "apt_update_repo_deb"

# Google Chrome repo (deb822)を有効にする
- name: Google Chrome repo (deb822)
  when: repo_enable_chrome
  ansible.builtin.deb822_repository:
    name: "Google-chrome"
    types: "deb"
    uris: "{{ chrome_apt_uri }}"
    suites: "{{ chrome_apt_suite }}"
    components: "{{ chrome_apt_components }}"
    architectures: "{{ chrome_arch_apt }}"
    enabled: true
    signed_by: "{{ chrome_keyring_path }}"
  notify: "apt_update_repo_deb"

# Pinning ( 外部を下げる )
- name: Pin external origins lower than base
  ansible.builtin.copy:
    dest: "/etc/apt/preferences.d/99-external.pref"
    mode: "0644"
    content: |
      Package: *
      Pin: origin "download.docker.com"
      Pin-Priority: {{ pin_external|int }}

      Package: *
      Pin: origin "pkgs.k8s.io"
      Pin-Priority: {{ pin_external|int }}

      Package: *
      Pin: origin "dl.google.com"
      Pin-Priority: {{ pin_external|int }}
