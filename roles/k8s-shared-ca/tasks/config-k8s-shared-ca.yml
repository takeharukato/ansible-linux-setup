#  -*- coding:utf-8 mode:yaml -*-
#  Ansible role tasks for k8s-shared-ca
#
#  共通CAを生成/配布し, コントロールプレーンから利用できるようにする
---

# CA情報をコントロールノードで準備し, 各ホストに配布する
- name: Prepare shared CA info on control node
  # run_onceで制御ノード上の実行を1回に限定し並列処理でもCA生成が競合しない
  run_once: true
  delegate_to: localhost
  block:
    # 共通CA関連の作業用変数を初期化する
    - name: Initialize shared CA variables
      set_fact:
        # 利用する共通CA証明書ファイルのパスを保持する
        _shared_ca_source_cert: ""
        # 利用する共通CA秘密鍵ファイルのパスを保持する
        _shared_ca_source_key: ""
        # 共通CAの供給元種別(user/role-files/generated)を表す
        _shared_ca_source_origin: ""
        # ユーザーが外部提供する共通CA格納ディレクトリへのパス
        _shared_ca_user_dir: "{{ (k8s_common_ca | default('', true) | string | trim) }}"
        # ロール内で共通CAファイルを配置するディレクトリパス
        _shared_ca_role_dir: "{{ role_path }}/files/shared-ca"

    # 指定された証明書ファイルを確認する
    - name: Check user-provided CA certificate
      stat:
        path: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_cert_filename }}"
        follow: true
      register: _shared_ca_user_cert
      when: _shared_ca_user_dir != ""

    # 指定された秘密鍵ファイルを確認する
    - name: Check user-provided CA private key
      stat:
        path: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_key_filename }}"
        follow: true
      register: _shared_ca_user_key
      when: _shared_ca_user_dir != ""

    # 本ロールで生成される証明書が存在することを確認する
    - name: Check role bundled CA certificate
      stat:
        path: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
        follow: true
      register: _shared_ca_role_cert

    # 本ロールで生成される秘密鍵が存在することを確認する
    - name: Check role bundled CA private key
      stat:
        path: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
        follow: true
      register: _shared_ca_role_key

    # 指定されたCAの有効性を判定する
    - name: Evaluate user-provided CA validity
      set_fact:
        _shared_ca_user_valid: >-
          {{
            (_shared_ca_user_dir != "") and
            (_shared_ca_user_cert is defined and _shared_ca_user_cert.stat.exists and (_shared_ca_user_cert.stat.isreg | default(false, true)) and _shared_ca_user_cert.stat.readable) and
            (_shared_ca_user_key is defined and _shared_ca_user_key.stat.exists and (_shared_ca_user_key.stat.isreg | default(false, true)) and _shared_ca_user_key.stat.readable)
          }}

    # 指定されたCAが不正な場合に警告を出す
    - name: Warn when user-provided CA is invalid
      debug:
        msg: "Shared CA not found at k8s_common_ca='{{ _shared_ca_user_dir }}'. Using role bundled CA or generating new files."
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_user_dir != ""
        - not _shared_ca_user_valid

    # 本ロールで生成されるCAの有効性を判定する
    - name: Evaluate bundled CA validity
      set_fact:
        _shared_ca_role_valid: >-
          {{
            (_shared_ca_role_cert.stat.exists and (_shared_ca_role_cert.stat.isreg | default(false, true)) and _shared_ca_role_cert.stat.readable) and
            (_shared_ca_role_key.stat.exists and (_shared_ca_role_key.stat.isreg | default(false, true)) and _shared_ca_role_key.stat.readable)
          }}

    # 生成を無効化している場合に指定されたCAを必須にする
    - name: Require user-provided CA when creation disabled
      fail:
        msg: "When enable_create_k8s_ca is false, set k8s_common_ca to a directory containing {{ k8s_shared_ca_cert_filename }} and {{ k8s_shared_ca_key_filename }}."
      when:
        - not (enable_create_k8s_ca | default(false) | bool)
        - not _shared_ca_user_valid

    # 生成無効時に指定されたCAをソースとして採用する
    - name: Select user-provided CA source when creation disabled
      set_fact:
        _shared_ca_source_cert: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_cert_filename }}"
        _shared_ca_source_key: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_key_filename }}"
        _shared_ca_source_origin: "user"
      when: not (enable_create_k8s_ca | default(false) | bool)

    # 生成有効時は指定されたCAを優先する
    - name: Prefer user-provided CA when creation enabled
      set_fact:
        _shared_ca_source_cert: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_cert_filename }}"
        _shared_ca_source_key: "{{ _shared_ca_user_dir }}/{{ k8s_shared_ca_key_filename }}"
        _shared_ca_source_origin: "user"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""
        - _shared_ca_user_valid

    # 本ロールで生成されるCAをバックアップソースとして採用する
    - name: Fallback to bundled CA when creation enabled
      set_fact:
        _shared_ca_source_cert: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
        _shared_ca_source_key: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
        _shared_ca_source_origin: "role-files"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""
        - _shared_ca_role_valid

    # ロール内の共通CA格納ディレクトリを作成する
    - name: Create shared CA directory in role files
      file:
        path: "{{ _shared_ca_role_dir }}"
        state: directory
        mode: "0700"
        owner: "{{ lookup('env', 'USER') }}"
        group: "{{ lookup('env', 'USER') }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""

    # 共通CAの秘密鍵を生成する
    - name: Generate shared CA private key
      command: >-
        openssl genrsa -out {{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }} {{ k8s_shared_ca_key_size }}
      args:
        creates: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""

    # 共通CAの証明書を生成する
    - name: Generate shared CA certificate
      command: >-
        openssl req -x509 -new -key {{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }} -out {{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }} -days {{ k8s_shared_ca_valid_days }} -{{ k8s_shared_ca_digest }} -subj '{{ k8s_shared_ca_subject }}'
      args:
        creates: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""

    # 生成したCAファイルのパーミッションを整える
    - name: Set permissions on generated CA files
      file:
        path: "{{ item }}"
        mode: "0600"
        owner: "{{ lookup('env', 'USER') }}"
        group: "{{ lookup('env', 'USER') }}"
      loop:
        - "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
        - "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""

    # 生成したCAをソースとして登録する
    - name: Mark generated CA as source
      set_fact:
        _shared_ca_source_cert: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
        _shared_ca_source_key: "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
        _shared_ca_source_origin: "generated"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_cert == ""

    # ロール内ディレクトリの所有権を整える
    - name: Ensure shared CA role directory ownership
      file:
        path: "{{ _shared_ca_role_dir }}"
        state: directory
        mode: "0700"
        owner: "{{ lookup('env', 'USER') }}"
        group: "{{ lookup('env', 'USER') }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_origin in ["generated", "role-files"]

    # ロール内CAファイルの所有権を整える
    - name: Ensure shared CA role files ownership
      file:
        path: "{{ item }}"
        mode: "0600"
        owner: "{{ lookup('env', 'USER') }}"
        group: "{{ lookup('env', 'USER') }}"
      loop:
        - "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_key_filename }}"
        - "{{ _shared_ca_role_dir }}/{{ k8s_shared_ca_cert_filename }}"
      when:
        - enable_create_k8s_ca | default(false) | bool
        - _shared_ca_source_origin in ["generated", "role-files"]

    # 共通CAの取得に失敗した場合は中断する
    - name: Ensure shared CA source is resolved
      fail:
        msg: "Failed to obtain shared CA. Check k8s_common_ca or files/shared-ca."
      when: _shared_ca_source_cert == "" or _shared_ca_source_key == ""

    # 共通CAのソース情報をfactsで共有する
    - name: Share shared CA source facts
      set_fact:
        k8s_shared_ca_source_cert: "{{ _shared_ca_source_cert }}"
        k8s_shared_ca_source_key: "{{ _shared_ca_source_key }}"
        k8s_shared_ca_source_origin: "{{ _shared_ca_source_origin }}"
      delegate_facts: true

# 共通CAソースを保持するホスト名を決定する
- name: Determine host holding shared CA source
  set_fact:
    _shared_ca_source_host: "{{ k8s_shared_ca_source_host | default('localhost',true) }}"

# 共通CAソースホストがインベントリに存在するか検証する
- name: Validate shared CA source host exists in inventory
  fail:
    msg: "Shared CA source host {{ _shared_ca_source_host }} is not defined in hostvars."
  when: _shared_ca_source_host not in hostvars

# 共通CAソースパスをfactsから取得する
- name: Fetch shared CA source
  set_fact:
    k8s_shared_ca_source_cert: "{{ hostvars[_shared_ca_source_host].k8s_shared_ca_source_cert | default('', true) }}"
    k8s_shared_ca_source_key: "{{ hostvars[_shared_ca_source_host].k8s_shared_ca_source_key | default('', true) }}"
    k8s_shared_ca_source_origin: "{{ hostvars[_shared_ca_source_host].k8s_shared_ca_source_origin | default('unknown', true) }}"

# 共通CAソース情報が欠落していないか検証する
- name: Validate shared CA source retrieval
  fail:
    msg: "Shared CA source information is missing. Verify the run_once block in k8s-shared-ca role."
  when: k8s_shared_ca_source_cert | length == 0 or k8s_shared_ca_source_key | length == 0

# デプロイ先パスを事前に計算して保持する
- name: Precompute shared CA destination paths
  set_fact:
    k8s_shared_ca_cert_path: "{{ k8s_shared_ca_output_dir }}/{{ k8s_shared_ca_cert_filename }}"
    k8s_shared_ca_key_path: "{{ k8s_shared_ca_output_dir }}/{{ k8s_shared_ca_key_filename }}"
    k8s_embed_kubeconfig_shared_ca_path: "{{ k8s_shared_ca_output_dir }}/{{ k8s_shared_ca_cert_filename }}"

# 共通CA展開先ディレクトリを生成する
- name: Create shared CA destination directory
  file:
    path: "{{ k8s_shared_ca_output_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

# 共通CA証明書/鍵をターゲットノードへ配布する
- name: Deploy shared CA files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "0600"
    backup: false
  loop:
    - { src: "{{ k8s_shared_ca_source_cert }}", dest: "{{ k8s_shared_ca_cert_path }}" }
    - { src: "{{ k8s_shared_ca_source_key }}", dest: "{{ k8s_shared_ca_key_path }}" }
