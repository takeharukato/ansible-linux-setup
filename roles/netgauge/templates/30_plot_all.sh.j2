#!/usr/bin/env bash
#
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# gnuplotを用いたヒストグラム生成
#

set -euo pipefail

RUN_DIR=`realpath "${1:-}"`
if [[ -z "${RUN_DIR}" || ! -d "${RUN_DIR}" ]]; then
  echo "Usage: $0 RUN_DIR" >&2
  exit 1
fi

SCRIPT_DIR=$(cd $(dirname $0); pwd)
CWD=`pwd`

# 画像出力先
PLOT_DIR="${RUN_DIR}/plots"
mkdir -p "${PLOT_DIR}"

# メタ読み
# shellcheck disable=SC1091
source "${RUN_DIR}/meta.env"

# rankごとのヒストグラム
for f in "${RUN_DIR}"/rank*.val; do
  cd "${SCRIPT_DIR}"
  base="$(basename "$f" .val)"
  gnuplot -e "INFILE='${f}'; OUTPNG='${PLOT_DIR}/${base}_hist.png'; TITLE='${base} (${MODE}, Q=${QUANTUM_US}us)'; BINW=${BINW:-1}" plot_hist.gp
  cd "${CWD}"
done

# 全rank合算
if [[ -f "${RUN_DIR}/_values_all.txt" ]]; then
   cd "${SCRIPT_DIR}"
   gnuplot -e "INFILE='${RUN_DIR}/_values_all.txt'; OUTPNG='${PLOT_DIR}/all_hist.png'; TITLE='ALL RANKS (${MODE}, Q=${QUANTUM_US}us)'; BINW=${BINW:-1}" plot_hist.gp
   cd "${CWD}"
fi

echo "[OK] Plots -> ${PLOT_DIR}"
