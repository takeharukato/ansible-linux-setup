#!/usr/bin/env bash
#
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# 測定用cgroupの作成
#

set -euo pipefail

# root権限が必要
if [[ $EUID -ne 0 ]]; then
  echo "Please run as root (sudo)." >&2
  exit 1
fi

# 前段の検出結果を取り込む
if [[ ! -f .cpu_env ]]; then
  echo "Run ./00_detect_cpus.sh first." >&2
  exit 1
fi
# shellcheck disable=SC1091
source .cpu_env

CGROUP_ROOT="/sys/fs/cgroup"
SLICE_NAME="kubepods.slice"
PATH_SLICE="${CGROUP_ROOT}/${SLICE_NAME}"
PATH_APP="${PATH_SLICE}/netgauge-app"

mkdir -p "${PATH_APP}"

# メモリ/NUMA全ノードを許可
echo 0 > "${PATH_APP}/cgroup.procs" || true
echo "0" > "${PATH_APP}/cpuset.mems" || true
# cpusetは effective を見ながら順序に注意
echo "${APP_RANGE}" > "${PATH_APP}/cpuset.cpus"

echo "[OK] ${SLICE_NAME}/netgauge-app を cpuset.cpus=${APP_RANGE} で用意しました。"
echo "以後は PID を ${PATH_APP}/cgroup.procs へ書けばAPPコアに閉じ込められます。"
