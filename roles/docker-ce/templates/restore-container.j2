#!/bin/sh
# -*-mode: bash; coding:utf-8-*-
#  コンテナボリュームリストアスクリプト
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# /usr/local/bin/restore-container
#
# tar.xzアーカイブをコンテナに展開する
# 使用法:
#   restore-container コンテナ名 アーカイブファイル
#

image="{{docker_ce_backup_container_image}}"

main(){
    local container_name
    local archive_file

    if [ $# -ne 2 ]; then
	    echo "restore-container.sh container-name archive-file.tar.xz"
	    echo "This script restores archive files are generated by /etc/cron.daily/backup-containers.sh"
	    exit 1
    fi

    container_name="$1"
    archive_file="$2"

    # 1) アーカイブが存在しない場合は終了する
    if [ ! -f "${archive_file}" ]; then
	    echo "No such archive: ${archive_file}"
	    exit 1
    fi

    # 2) 指定されたコンテナが停止していることを確認する
    #    停止コンテナのみを検索対象とする
{% raw %}
    docker ps -a --filter status=exited --format "{{.Names}}"|egrep "^${container_name}$"
{% endraw %}
    if [ $? -ne 0 ]; then
    	echo "No such stopped container: ${container_name}"
    	exit 1
    fi

    # 3) アーカイブをコンテナ内に展開する
    docker run --rm \
    	   --volumes-from "${container_name}" \
	   -v $(pwd):/backup \
	   "${image}" restore "${archive_file}"
}

main $@
