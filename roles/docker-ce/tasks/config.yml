#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  Docker設定関連タスク

---

# Docker daemon.json を作成し、iptables管理を無効化
# 留意事項: router-config ロールが独自にiptablesルールを管理するため
# Dockerのiptables管理を無効化する
# ただし、userland-proxyは有効化してポートフォワーディングを機能させる
- name: "Configure Docker daemon.json with iptables disabled"
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "ipv6": true,
        "iptables": false,
        "ip6tables": false,
        "ip-forward": false,
        "ip-masq": false,
        "userland-proxy": true,
        "log-driver": "{{ docker_ce_log_driver }}",
        "log-opts": {
          "max-size": "{{ docker_ce_log_opts['max-size'] }}",
          "max-file": "{{ docker_ce_log_opts['max-file'] }}"
        }
      }
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: docker_restarted
