#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#
#  ワーカーノード向け kubeconfig 配布タスク
#
---

# 対応するコントロールプレーンを確認
- name: Ensure control plane host is specified for worker
  ansible.builtin.assert:
    that:
      - k8s_ctrlplane_host | default('') | length > 0
    fail_msg: "k8s_ctrlplane_host must be defined for worker host {{ inventory_hostname }}"

- name: Probe associated control plane host for kubeconfig distribution
  ansible.builtin.wait_for_connection:
    timeout: "{{ k8s_kubeconfig_probe_timeout | default(15) }}"
  delegate_to: "{{ k8s_ctrlplane_host }}"

# 共通で利用するローカルキャッシュディレクトリを決定
- name: Define local staging directory for kubeconfig artifacts
  ansible.builtin.set_fact:
    k8s_kubeconfig_local_cache_dir: "{{ lookup('env', 'HOME') }}/.ansible/kubeconfig-cache"
    k8s_kubeconfig_local_cache_owner: "{{ lookup('env', 'USER') }}"
    k8s_kubeconfig_local_cache_group: "{{ lookup('pipe', 'id -gn') }}"
  delegate_to: localhost
  delegate_facts: true
  run_once: true

# ローカルキャッシュディレクトリを作成
- name: Ensure local kubeconfig cache directory exists
  ansible.builtin.file:
    path: "{{ hostvars['localhost']['k8s_kubeconfig_local_cache_dir'] }}"
    state: directory
    mode: "0700"
    owner: "{{ hostvars['localhost']['k8s_kubeconfig_local_cache_owner'] }}"
    group: "{{ hostvars['localhost']['k8s_kubeconfig_local_cache_group'] }}"
    recurse: true
  delegate_to: localhost
  become: true
  run_once: true

- name: Define worker-specific kubeconfig cache file
  ansible.builtin.set_fact:
    k8s_kubeconfig_local_cache_file: "{{ hostvars['localhost']['k8s_kubeconfig_local_cache_dir'] }}/{{ k8s_ctrlplane_host }}-{{ inventory_hostname }}-{{ k8s_kubeconfig_merged_filename }}"

# コントロールプレーンから統合済み kubeconfig を取得
- name: Fetch merged kubeconfig from control plane
  ansible.builtin.fetch:
    src: "{{ k8s_kubeconfig_merged_system_path }}"
    dest: "{{ k8s_kubeconfig_local_cache_file }}"
    flat: true
  delegate_to: "{{ k8s_ctrlplane_host }}"

# 各ワーカーノードで統合済み kubeconfig を設置
- name: Deploy merged kubeconfig to worker
  ansible.builtin.copy:
    src: "{{ k8s_kubeconfig_local_cache_file }}"
    dest: "{{ k8s_kubeconfig_merged_operator_path }}"
    owner: "{{ k8s_operator_user }}"
    group: "{{ k8s_operator_user }}"
    mode: "0600"

# システムディレクトリにも配置し, root から参照可能にする
- name: Copy merged kubeconfig to system directory
  ansible.builtin.copy:
    src: "{{ k8s_kubeconfig_local_cache_file }}"
    dest: "{{ k8s_kubeconfig_merged_system_path }}"
    owner: "root"
    group: "root"
    mode: "0600"
