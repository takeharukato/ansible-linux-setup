#!/bin/sh
# -*-mode: bash; coding:utf-8-*-
#
#  /homeディレクトリバックアップスクリプト
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# 指定ユーザのホームディレクトリをtar.xzでバックアップする
#

# netcatコマンド
NC="{{ nc_command }}"

# 最大保存世代数
rotate="{{ user_settings_backup_home_rotation }}"

# NFSサーバ
nfs_server="{{ user_settings_backup_home_nfs_server }}"
# NFSサーバの共有ディレクトリ
nfs_share="{{ user_settings_backup_home_nfs_dir }}"
# NASのnfsディレクトリ
nfs_dir="${nfs_server}:${nfs_share}"
#マウントポイント
mnt_point="{{ user_settings_backup_home_mount_point }}"
# バックアップディレクトリ
backup_dir="{{ user_settings_backup_output_dir }}"
# ユーザ一覧
backup_users="{{ user_settings_backup_users_list| join(" ") }}"

main(){
    local day
    local gen
    local user_home
    local user
    local container_name
    local hostname

    #年間通算日数を算出
    day=`date +'%j'`

    #世代数算出
    gen=`expr ${day} % ${rotate}`

    # ホスト名
    hostname=`hostname`

    # 接続を確認
    ${NC} -v -w 5 ${nfs_server} nfs

    if [ $? -ne 0 ]; then
	echo "${nfs_server} is not available"
	exit 1
    fi

    # NASをマウント
    sudo mount -t nfs "${nfs_dir}" "${mnt_point}"
    echo "Mounted ${nfs_dir} on ${mnt_point}"

    # 1) ディレクトリを作成する
    sudo mkdir -p "${backup_dir}"


    # 世代数を表示
    echo "generation: ${gen}"
    echo "NFS directory: ${nfs_dir}"

    for user in `echo ${backup_users}`
    do
	# 2) ホームディレクトリのパスを取得する
	user_home=$(awk -v u="${user}" -v FS=':' '$1==u {print $6}' /etc/passwd);
	if [  -d "${user_home}" -o "x${user_home}" = "x" ]; then
	    echo "backup: ${user_home}"
	    # 3) ホームディレクトリをアーカイブする
	    sudo tar cJvf "${backup_dir}/home-${user}-${hostname}-${gen}.tar.xz" "${user_home}"
	else
	    echo "${user} does not have a home directory, skipped."
	fi
    done

    # 4) 削除可能にする
    sudo chmod -R o+rwX "${backup_dir}"

    # 5) NASをアンマウント
    echo "Unmount ${mnt_point}"
    sudo umount "${mnt_point}"
}

main $@
