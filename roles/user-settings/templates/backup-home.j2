#!/usr/bin/env bash
# -*-mode: bash; coding:utf-8-*-
# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2025 TAKEHARU KATO
# This file is distributed under the two-clause BSD license.
# For the full text of the license, see the LICENSE file in the project root directory.
# このファイルは2条項BSDライセンスの下で配布されています。
# ライセンス全文はプロジェクト直下の LICENSE を参照してください。
#
# OpenAI's ChatGPT partially generated this code.
# Author has modified some parts.
# OpenAIのChatGPTがこのコードの一部を生成しました。
# 著者が修正している部分があります。
#
#  /homeディレクトリバックアップスクリプト
#
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# 指定ユーザのホームディレクトリをtar.xzでバックアップする
#
# - NFSサーバにバックアップすることを想定している
# - バックアップ世代数は, 年間通算日数を最大保存世代数で割った余りで算出する
# - バックアップ対象ユーザは, 変数user_settings_backup_users_listで指定する
# - nc_command変数で指定されたnetcatコマンドを使用して, NFSサーバへの接続を確認する
# - ファイル名は, ホスト名, 世代数を含む形式で, home-<ユーザ名>-<ホスト名>-<世代数>.tar.xz とする
# - バックアップファイルは, 変数user_settings_backup_output_dirで指定されたディレクトリに保存する
# - バックアップファイルのパーミッションは, 誰でも読み書き可能にする
# 事前条件:
# - NFSサーバが稼働していること
# - NFSサーバの共有ディレクトリが設定されていること
# - バックアップ対象ユーザが存在すること
# - netcatコマンドがインストールされていること
# - バックアップスクリプトを実行するユーザが, NFSサーバの共有ディレクトリに書き込み可能であること
# - バックアップスクリプトを実行するユーザが, バックアップ対象ユーザのホームディレクトリにアクセス可能であること
# - cron.dailyに以下のように登録して, 一日1回バックアップを実行することを想定している
# cron.daily/backup-home
#
#   MAILTO="" # バックアップスクリプトの出力をメールで送信しないようにする
#   0 3 * * * sudo {{ user_settings_backup_bin_dir|default('/usr/local/bin', true) }}/backup-home
#
# 使用するansible変数の説明:
# - nc_command: netcatコマンド (例: "nc" または "ncat")
# - user_settings_backup_home_rotation: バックアップの最大保存世代数 (例: 7)
# - user_settings_backup_home_nfs_server: NFSサーバのホスト名またはIPアドレス (例: "nfs.example.com")
# - user_settings_backup_home_nfs_dir: NFSサーバの共有ディレクトリ (例: "/export/backups")
# - user_settings_backup_home_mount_point: NFSサーバの共有ディレクトリをマウントするローカルのディレクトリ (例: "/mnt/backups")
# - user_settings_backup_output_dir: バックアップファイルを保存するローカルのディレクトリ (例: "/mnt/backups/home")
# - user_settings_backup_users_list: バックアップ対象ユーザのリスト (例: ["user1", "user2"])
# シェル変数の説明:
# - NC: netcatコマンド
# - rotate: バックアップの最大保存世代数
# - nfs_server: NFSサーバのホスト名またはIPアドレス
# - nfs_share: NFSサーバの共有ディレクトリ
# - nfs_dir: NFSサーバの共有ディレクトリを表す文字列 (例: "nfs.example.com:/export/backups")
# - mnt_point: NFSサーバの共有ディレクトリをマウントするローカルのディレクトリ
# - backup_dir: バックアップファイルを保存するローカルのディレクトリ
# - backup_users: バックアップ対象ユーザのリストを表す文字列 (例: "user1 user2")

# netcatコマンド
NC="{{ nc_command }}"

# 最大保存世代数
rotate="{{ user_settings_backup_home_rotation }}"

# NFSサーバ
nfs_server="{{ user_settings_backup_home_nfs_server }}"
# NFSサーバの共有ディレクトリ
nfs_share="{{ user_settings_backup_home_nfs_dir }}"
# NASのnfsディレクトリ
nfs_dir="${nfs_server}:${nfs_share}"
#マウントポイント
mnt_point="{{ user_settings_backup_home_mount_point }}"
# バックアップディレクトリ
backup_dir="{{ user_settings_backup_output_dir }}"
# ユーザ一覧
backup_users="{{ user_settings_backup_users_list| join(" ") }}"

main(){
    local day
    local gen
    local user_home
    local user
    local hostname
    local mounted=false
    local SUDO

    set -euo pipefail

    if [[ -z "${NC}" ]]; then
        echo "NC command is not set" >&2
        exit 1
    fi

    if [[ -z "${nfs_server}" || -z "${nfs_share}" || -z "${mnt_point}" || -z "${backup_dir}" ]]; then
        echo "NFS settings are incomplete" >&2
        exit 1
    fi

    if ! [[ "${rotate}" =~ ^[0-9]+$ ]] || [[ "${rotate}" -le 0 ]]; then
        echo "rotate must be a positive integer" >&2
        exit 1
    fi

    if [[ -z "${backup_users}" ]]; then
        echo "backup_users is empty" >&2
        exit 1
    fi

    if [[ "$(id -u)" -eq 0 ]]; then
        SUDO=""
    else
        SUDO="sudo"
    fi

    cleanup() {
        if [[ "${mounted}" == "true" ]]; then
            echo "Unmount ${mnt_point}"
            ${SUDO} umount "${mnt_point}"
        fi
    }

    trap cleanup EXIT

    #年間通算日数を算出
    day=$(date +'%j')

    #世代数算出
    gen=$((day % rotate))

    # ホスト名
    hostname=$(hostname)

    # 接続を確認
    ${NC} -v -w 5 "${nfs_server}" nfs

    # NASをマウント
    ${SUDO} mount -t nfs "${nfs_dir}" "${mnt_point}"
    mounted=true
    echo "Mounted ${nfs_dir} on ${mnt_point}"

    # 1) ディレクトリを作成する
    ${SUDO} mkdir -p "${backup_dir}"

    # 世代数を表示
    echo "generation: ${gen}"
    echo "NFS directory: ${nfs_dir}"

    for user in ${backup_users}; do
        # 2) ホームディレクトリのパスを取得する
        user_home=$(awk -v u="${user}" -v FS=':' '$1==u {print $6}' /etc/passwd)
        if [[ -n "${user_home}" && -d "${user_home}" ]]; then
            echo "backup: ${user_home}"
            # 3) ホームディレクトリをアーカイブする
            ${SUDO} tar cJvf "${backup_dir}/home-${user}-${hostname}-${gen}.tar.xz" "${user_home}"
        else
            echo "${user} does not have a home directory, skipped."
        fi
    done

    # 4) 削除可能にする
    ${SUDO} chmod -R o+rwX "${backup_dir}"
}

main "$@"
