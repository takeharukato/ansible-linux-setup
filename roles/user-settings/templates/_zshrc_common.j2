# Common settings for zsh

# Emacsキーバインドを使用
bindkey -e

# ------------------------------------------------
# プロンプト設定
# ------------------------------------------------
RPROMPT=""
PROMPT="[%n@%m %c] [%h] "
#プロンプトの自動改行を抑制する
unsetopt promptcr

# プロンプトのカラー表示を有効
autoload -U colors
colors

# ------------------------------------------------------
# 補完処理
# ------------------------------------------------------

# -------------------------------------------------
# コマンドライン補完基本設定
# -------------------------------------------------

#
# fpath に必要な site-functions を追加する
# /opt/share => /usr/local/share => /usr/share の順で確認し, 未登録なら先頭に追加
#
zsh_site_function_dirs=(
    /opt/share/zsh/site-functions
    /usr/local/share/zsh/site-functions
    /usr/share/zsh/site-functions
)

for _zf_dir in ${zsh_site_function_dirs[@]}; do
    if [ -d "${_zf_dir}" ]; then
        if (( ${fpath[(Ie)${_zf_dir}]} == 0 )); then
            fpath=("${_zf_dir}" ${fpath})
        fi
    fi
done
unset _zf_dir zsh_site_function_dirs

# 補完の zstyle 設定
zstyle :compinstall filename "${HOME}/.zshrc"

# 補完侯補をEmacsのキーバインドで動き回る
zstyle ':completion:*:default' menu select=1

# 補完の時に大文字小文字を区別しない
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# ^Iで補完可能な一覧を表示する。(曖昧補完)
setopt auto_list

# 補完時にスペルチェックをする。
setopt correct

# 補完時に履歴を自動的に展開する。
setopt hist_expand

# 圧縮済み補完リストの表示
setopt list_packed

# 補完リスト表示時にビープ音を鳴らさない。
setopt nolistbeep

# 補完前にエイリアスを展開する
# ( ファイル/ディレクトリ補完のために, 後述のlsのエイリアスを展開する必要があるため )
setopt complete_aliases

# --------------------------------------------------
# sshの補完設定
# --------------------------------------------------

__ssh_hosts() {
  local files
  files=()

  # ~/.ssh/config があれば追加
  [[ -f ${HOME}/.ssh/config ]] && files+="${HOME}/.ssh/config"

  # ~/.ssh/conf.d/*.conf が存在する場合だけ展開する
  # (N) を付けることでマッチしなければ空扱いにし, エラーにしない
  files+=(${HOME}/.ssh/conf.d/*.conf(N))

  # 1個もファイルが無ければ何もしない
  (( $#files )) || return 0

  grep -hEi '^[[:space:]]*Host[[:space:]]+' "${files[@]}" 2>/dev/null \
    | sed -E 's/^[[:space:]]*Host[[:space:]]*//' \
    | tr ' ' '\n' \
    | grep -v '[*?]' \
    | sort -u
}

# ssh, scp, sftpコマンドのホスト名補完設定
typeset -a __ssh_completion_hosts
__ssh_completion_hosts=(${(@f)$(__ssh_hosts)})
if (( $#__ssh_completion_hosts )); then
    zstyle ':completion:*:(ssh|scp|sftp):*' hosts "${__ssh_completion_hosts[@]}"
fi

# -------------------------------------------------
# シェル動作のカスタマイズ
# -------------------------------------------------

# C-s, C-qを無効にする。
setopt no_flow_control

# リダイレクトで上書きする事を許可しない。
setopt no_clobber

# ベルを鳴らさない。
setopt no_beep

# cdでpushdする。
setopt auto_pushd

# pushdで同じディレクトリを重複してpushしない。
setopt pushd_ignore_dups

# globを拡張する。
setopt extended_glob

# pushd を引数無しで実行した時に pushd ~ とする。
setopt pushd_to_home

# ディレクトリ名だけで移動できる。
setopt auto_cd

# rm * を実行する前に確認される。
unsetopt rmstar_wait

# コマンドラインの最後のスラッシュを自動的に削除しない。
setopt noautoremoveslash

# -------------------------------------------------
# 履歴の設定
# -------------------------------------------------

# 履歴ファイル
HISTFILE=~/.histfile
# 履歴サイズ
HISTSIZE=100000
# 履歴保存サイズ
SAVEHIST=100000

# 履歴ファイルに時刻を記録
setopt extended_history

# 履歴をインクリメンタルに追加
setopt inc_append_history

# 履歴の共有
setopt share_history

# 履歴に追加されるコマンド行が古いものと同じなら古いものを削除
setopt hist_ignore_all_dups

# 直前と同じコマンドラインは履歴に追加しない
setopt hist_ignore_dups

# スペースで始まるコマンド行は履歴リストから削除
setopt hist_ignore_space

# 履歴を呼び出してから実行する間に一旦編集可能
setopt hist_verify

# ------------------------------------------------
# 環境設定
# ------------------------------------------------

# coreのサイズ
#limit coredumpsize 0

# ------------------------------------------------
# lsコマンドのカラー表示設定
# ------------------------------------------------

#
# lsコマンドのカラー表示設定
#
case "${OSTYPE}" in
    freebsd*|darwin*)
        alias ls="ls -G -w"
        ;;
    linux*)
        alias ls="ls --color"
        ;;
esac

# ------------------------------------------------
# コマンドエイリアスの設定
# ------------------------------------------------

#
# ls エイリアス
#

alias ll='ls -lh'
alias la="ls -a"
alias lf="ls -F"
alias ll="ls -l"

# du/df エイリアス例
alias du="du -h"
alias df="df -h"

# -------------------------------------
# where コマンド
# -------------------------------------
alias where="command -v"

# -------------------------------------
# su コマンド
# -------------------------------------
alias su="su -l"

# ------------------------------------
# コマンドエイリアスの終わり
# ------------------------------------