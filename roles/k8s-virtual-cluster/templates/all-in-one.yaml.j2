# -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#
# All-in-one manifest from kubernetes-retired/cluster-api-provider-nested
# Contains vc-manager, syncer, vn-agent component manifests
---
# APIバージョン。
apiVersion: v1
# リソース種別。
kind: ServiceAccount
# メタデータ定義。
metadata:
  # ServiceAccount名。
  name: vc-manager
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRole
# メタデータ定義。
metadata:
  # ClusterRole名。
  name: vc-manager
# 権限ルール。
rules:
  # Core APIの権限。
  - apiGroups: [""]
    # 対象リソース。
    resources: ["namespaces", "pods", "services", "configmaps", "secrets"]
    # 許可動作。
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # apps APIの権限。
  - apiGroups: ["apps"]
    # 対象リソース。
    resources: ["deployments", "statefulsets", "daemonsets"]
    # 許可動作。
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Virtual Cluster APIの権限。
  - apiGroups: ["{{ virtualcluster_api_group }}"]
    # 対象リソース。
    resources: ["virtualclusters", "clusterversions"]
    # 許可動作。
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Webhook APIの権限。
  - apiGroups: ["admissionregistration.k8s.io"]
    # 対象リソース。
    resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
    # 許可動作。
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Leader Election APIの権限。
  - apiGroups: ["coordination.k8s.io"]
    # 対象リソース。
    resources: ["leases"]
    # 許可動作。
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # イベント記録の権限。
  - apiGroups: [""]
    # 対象リソース。
    resources: ["events"]
    # 許可動作。
    verbs: ["create", "patch"]
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRoleBinding
# メタデータ定義。
metadata:
  # ClusterRoleBinding名。
  name: vc-manager
# 参照するRole。
roleRef:
  # APIグループ。
  apiGroup: rbac.authorization.k8s.io
  # 参照種別。
  kind: ClusterRole
  # 参照名。
  name: vc-manager
# 対象ServiceAccount。
subjects:
  # ServiceAccountの指定。
  - kind: ServiceAccount
    # ServiceAccount名。
    name: vc-manager
    # Namespace名。
    namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: apps/v1
# リソース種別。
kind: Deployment
# メタデータ定義。
metadata:
  # Deployment名。
  name: vc-manager
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
  # ラベル定義。
  labels:
    # appラベル。
    app: vc-manager
# Deployment仕様。
spec:
  # レプリカ数。
  replicas: 1
  # セレクタ定義。
  selector:
    # マッチ条件。
    matchLabels:
      # appラベル。
      app: vc-manager
  # Podテンプレート。
  template:
    # メタデータ定義。
    metadata:
      # ラベル定義。
      labels:
        # appラベル。
        app: vc-manager
        # webhook serviceのselectorに一致させるラベル。
        virtualcluster-webhook: "true"
    # Pod仕様。
    spec:
      # ServiceAccount名。
      serviceAccountName: vc-manager
      # コンテナ定義。
      containers:
        # コンテナの指定。
        - name: vc-manager
          # コンテナイメージ。
          image: {{ virtualcluster_manager_image }}
          # 取得ポリシー。
          imagePullPolicy: IfNotPresent
          # コマンド指定。
          command:
            # 実行バイナリ。
            - "/app"
          # 引数指定。
          args:
            # Webhook有効化。
            - "-enable-webhook=true"
            # ヘルスエンドポイント。
            - "-health-addr=:8080"
            # メトリクスエンドポイント。
            - "-metrics-addr=:8000"
            # Leader Election有効化。
            - "-leader-election=true"
            # プロビジョナ指定。
            - "-provisioner=native"
          # ポート定義。
          ports:
            # Webhookポート。
            - containerPort: 9443
              # ポート名。
              name: webhook
            # ヘルスポート。
            - containerPort: 8080
              # ポート名。
              name: health
            # メトリクスポート。
            - containerPort: 8000
              # ポート名。
              name: metrics
          # 環境変数設定。
          env:
            # etcdスキーム制御。
            - name: VIRTUALCLUSTER_ETCD_SCHEME
              # 値指定。
              value: "http"
          # リソース設定。
          resources:
            # リクエスト設定。
            requests:
              # CPUリクエスト。
              cpu: {{ virtualcluster_pod_resource_requests.cpu }}
              # メモリリクエスト。
              memory: {{ virtualcluster_pod_resource_requests.memory }}
            # リミット設定。
            limits:
              # CPUリミット。
              cpu: {{ virtualcluster_pod_resource_limits.cpu }}
              # メモリリミット。
              memory: {{ virtualcluster_pod_resource_limits.memory }}
          # ボリュームマウント。
          volumeMounts:
            # Webhook証明書。
            - name: webhook-certs
              # マウントパス。
              mountPath: /tmp/k8s-webhook-server
              # 読み取り専用フラグ。
              readOnly: false
      # ボリューム定義。
      volumes:
        # Webhook証明書。
        - name: webhook-certs
          # emptyDir指定。
          emptyDir: {}
---
# APIバージョン。
apiVersion: v1
# リソース種別。
kind: ServiceAccount
# メタデータ定義。
metadata:
  # ServiceAccount名。
  name: vc-syncer
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRole
# メタデータ定義。
metadata:
  # ClusterRole名。
  name: vc-syncer
# 権限ルール。
rules:
  # Core API リソースの管理権限。
  - apiGroups: [""]
    # 対象リソース。
    resources:
      - configmaps
      - endpoints
      - namespaces
      - pods
      - secrets
      - services
      - serviceaccounts
      - persistentvolumeclaims
    # 許可動作。
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
      - deletecollection
  # extensions APIの管理権限。
  - apiGroups: ["extensions"]
    # 対象リソース。
    resources:
      - ingresses
    # 許可動作。
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
      - deletecollection
  # scheduling APIの管理権限。
  - apiGroups: ["scheduling.k8s.io"]
    # 対象リソース。
    resources:
      - priorityclasses
    # 許可動作。
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  # クラスタスコープリソースの参照権限。
  - apiGroups: ["", "storage.k8s.io"]
    # 対象リソース。
    resources:
      - events
      - nodes
      - persistentvolumes
      - storageclasses
    # 許可動作。
    verbs:
      - get
      - list
      - watch
  # イベント作成権限。
  - apiGroups: ["", "storage.k8s.io"]
    # 対象リソース。
    resources:
      - events
    # 許可動作。
    verbs:
      - create
      - patch
  # ステータスサブリソースの参照権限。
  - apiGroups: [""]
    # 対象リソース。
    resources:
      - namespaces/status
      - pods/status
      - services/status
      - nodes/status
      - persistentvolumes/status
      - persistentvolumeclaims/status
    # 許可動作。
    verbs:
      - get
  # Virtual Cluster APIの参照権限。
  - apiGroups: ["{{ virtualcluster_api_group }}"]
    # 対象リソース。
    resources:
      - virtualclusters
    # 許可動作。
    verbs:
      - get
      - list
      - watch
  # Virtual Cluster ステータス参照権限。
  - apiGroups: ["{{ virtualcluster_api_group }}"]
    # 対象リソース。
    resources:
      - virtualclusters/status
    # 許可動作。
    verbs:
      - get
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRoleBinding
# メタデータ定義。
metadata:
  # ClusterRoleBinding名。
  name: vc-syncer
# 参照するRole。
roleRef:
  # APIグループ。
  apiGroup: rbac.authorization.k8s.io
  # 参照種別。
  kind: ClusterRole
  # 参照名。
  name: vc-syncer
# 対象ServiceAccount。
subjects:
  # ServiceAccountの指定。
  - kind: ServiceAccount
    # ServiceAccount名。
    name: vc-syncer
    # Namespace名。
    namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: apps/v1
# リソース種別。
kind: Deployment
# メタデータ定義。
metadata:
  # Deployment名。
  name: vc-syncer
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
  # ラベル定義。
  labels:
    # アプリケーション識別ラベル。
    app: vc-syncer
# Deploymentの仕様定義。
spec:
  # レプリカ数。
  replicas: 1
  # Pod選択条件。
  selector:
    # マッチするラベル条件。
    matchLabels:
      # アプリケーション識別ラベル。
      app: vc-syncer
  # Podテンプレート定義。
  template:
    # メタデータ定義。
    metadata:
      # ラベル定義。
      labels:
        # アプリケーション識別ラベル。
        app: vc-syncer
    # Pod仕様定義。
    spec:
      # ServiceAccount名。
      serviceAccountName: vc-syncer
      # コンテナ定義。
      containers:
        # コンテナ名。
        - name: vc-syncer
          # コンテナイメージ。
          image: {{ virtualcluster_syncer_image }}
          # イメージプルポリシー。
          imagePullPolicy: Always
          # コンテナ起動コマンド。
          command:
            - syncer
          # 活性確認プローブ定義。
          livenessProbe:
            # 失敗と判定するまでの連続失敗回数。
            failureThreshold: 3
            # 初回プローブまでの遅延時間 (単位: 秒)。
            initialDelaySeconds: 30
            # プローブ実行間隔 (単位: 秒)。
            periodSeconds: 20
            # 成功と判定するまでの連続成功回数。
            successThreshold: 1
            # TCPソケット接続プローブ設定。
            tcpSocket:
              # 接続先ポート番号。
              port: 8080
            # プローブタイムアウト時間 (単位: 秒)。
            timeoutSeconds: 1
---
# APIバージョン。
apiVersion: v1
# リソース種別。
kind: ServiceAccount
# メタデータ定義。
metadata:
  # ServiceAccount名。
  name: vn-agent
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRole
# メタデータ定義。
metadata:
  # ClusterRole名。
  name: vn-agent
# 権限ルール。
rules:
  # Core APIの参照権限。
  - apiGroups: [""]
    # 対象リソース。
    resources: ["pods", "nodes"]
    # 許可動作。
    verbs: ["get", "list", "watch"]
---
# APIバージョン。
apiVersion: rbac.authorization.k8s.io/v1
# リソース種別。
kind: ClusterRoleBinding
# メタデータ定義。
metadata:
  # ClusterRoleBinding名。
  name: vn-agent
# 参照するRole。
roleRef:
  # APIグループ。
  apiGroup: rbac.authorization.k8s.io
  # 参照種別。
  kind: ClusterRole
  # 参照名。
  name: vn-agent
# 対象ServiceAccount。
subjects:
  # ServiceAccountの指定。
  - kind: ServiceAccount
    # ServiceAccount名。
    name: vn-agent
    # Namespace名。
    namespace: {{ virtualcluster_namespace }}
---
# APIバージョン。
apiVersion: apps/v1
# リソース種別。
kind: DaemonSet
# メタデータ定義。
metadata:
  # DaemonSet名。
  name: vn-agent
  # Namespace名。
  namespace: {{ virtualcluster_namespace }}
  # ラベル定義。
  labels:
    # appラベル。
    app: vn-agent
# DaemonSet仕様。
spec:
  # セレクタ定義。
  selector:
    # マッチ条件。
    matchLabels:
      # appラベル。
      app: vn-agent
  # Podテンプレート。
  template:
    # メタデータ定義。
    metadata:
      # ラベル定義。
      labels:
        # appラベル。
        app: vn-agent
    # Pod仕様。
    spec:
      # ServiceAccount名。
      serviceAccountName: vn-agent
      # ホストネットワーク使用。
      hostNetwork: true
      # ノードアフィニティ。
      affinity:
        # ノードアフィニティ設定。
        nodeAffinity:
          # 必須条件。
          requiredDuringSchedulingIgnoredDuringExecution:
            # ノードセレクタ条件。
            nodeSelectorTerms:
              # セレクタ式。
              - matchExpressions:
                  # 条件の指定。
                  - key: node-role.kubernetes.io/control-plane
                    # 条件演算子。
                    operator: DoesNotExist
      # コンテナ定義。
      containers:
        # コンテナの指定。
        - name: vn-agent
          # コンテナイメージ。
          image: {{ virtualcluster_vn_agent_image }}
          # 取得ポリシー。
          imagePullPolicy: IfNotPresent
          # セキュリティ設定。
          securityContext:
            # 特権モード。
            privileged: true
          # リソース設定。
          resources:
            # リクエスト設定。
            requests:
              # CPUリクエスト。
              cpu: "100m"
              # メモリリクエスト。
              memory: "128Mi"
            # リミット設定。
            limits:
              # CPUリミット。
              cpu: "500m"
              # メモリリミット。
              memory: "512Mi"
          # ボリュームマウント。
          volumeMounts:
            # kubelet設定。
            - name: kubelet-config
              # マウントパス。
              mountPath: /etc/kubernetes
              # 読み取り専用フラグ。
              readOnly: true
      # ボリューム定義。
      volumes:
        # kubelet設定。
        - name: kubelet-config
          # hostPath指定。
          hostPath:
            # ホスト側パス。
            path: /etc/kubernetes
            # パスタイプ。
            type: Directory
      # 許容条件。
      tolerations:
        # 許容設定。
        - operator: "Exists"
