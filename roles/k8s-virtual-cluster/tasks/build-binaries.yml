#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  Virtual Cluster バイナリのビルド
#
---

# make build-images でバイナリとDockerイメージをビルド
- name: "Build Virtual Cluster binaries and Docker images"
  ansible.builtin.shell:
    cmd: |
      set -e
      make build-images
    chdir: "{{ virtualcluster_source_dir }}/virtualcluster"
  delegate_to: "{{ virtualcluster_build_host }}"
  become: false
  register: result_build
  changed_when: true
  timeout: "{{ virtualcluster_build_timeout }}"
  run_once: true

# ビルド結果を表示
- name: "Display build result"
  ansible.builtin.debug:
    var: result_build.stdout_lines
  when: result_build.stdout_lines is defined
  run_once: true

# ビルドされたバイナリの存在確認
- name: "Verify built binaries exist"
  ansible.builtin.stat:
    path: "{{ virtualcluster_source_dir }}/virtualcluster/_output/release/{{ item }}"
  loop: "{{ virtualcluster_build_components }}"
  delegate_to: "{{ virtualcluster_build_host }}"
  become: false
  register: result_binaries
  failed_when: not result_binaries.stat.exists
  run_once: true

# 検証結果を表示
- name: "Display binary verification result"
  ansible.builtin.debug:
    msg: "All binaries built successfully: {{ virtualcluster_build_components | join(', ') }}"
  run_once: true
