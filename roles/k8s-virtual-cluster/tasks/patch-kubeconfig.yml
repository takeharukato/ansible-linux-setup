# -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#
# kubeconfig.go パッチ適用
# generateKubeconfigUseCertAndKey 関数でドメイン名(非IPアドレス)を渡した場合に
# IPv6形式の "[domain]:6443" となるバグを修正する。
# net.ParseIP が nil を返す(= ドメイン名)場合は IPv6 形式ではなく通常の
# "https://domain:6443" 形式を使用する。
#
---

- name: "Patch kubeconfig.go to handle hostname/domain correctly in URL generation"
  block:
    - name: "Apply hostname/domain URL fix patch to kubeconfig.go"
      ansible.posix.patch:
        src: "kubeconfig.patch"
        basedir: "{{ virtualcluster_source_dir }}"
        strip: 1
      delegate_to: "{{ virtualcluster_build_host }}"
      become: false
