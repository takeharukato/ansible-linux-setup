#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  スーパークラスタから現在稼働中のコンテナイメージを動的に検出し,
#  Virtual Clusterのテナントコントロールプレーンで使用するイメージバージョンを決定する。
#  K8sクラスタの実際の運用バージョンに合わせることで, バージョンズレを防止する。
#
---

# etcdのイメージをスーパークラスタから検出して変数にセット
- name: Detect etcd image from Super Cluster
  become: true
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} \
      -n kube-system get pod \
      -l component=etcd \
      -o jsonpath='{.items[0].spec.containers[0].image}' \
      2>/dev/null || echo ""
  register: detected_etcd_image_result
  failed_when: false
  changed_when: false

# kube-apiserverのイメージをスーパークラスタから検出して変数にセット
- name: Detect kube-apiserver image from Super Cluster
  become: true
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} \
      -n kube-system get pod \
      -l component=kube-apiserver \
      -o jsonpath='{.items[0].spec.containers[0].image}' \
      2>/dev/null || echo ""
  register: detected_apiserver_image_result
  failed_when: false
  changed_when: false

# kube-controller-managerのイメージをスーパークラスタから検出して変数にセット
- name: Detect kube-controller-manager image from Super Cluster
  become: true
  ansible.builtin.shell: |
    kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} \
      -n kube-system get pod \
      -l component=kube-controller-manager \
      -o jsonpath='{.items[0].spec.containers[0].image}' \
      2>/dev/null || echo ""
  register: detected_controller_manager_image_result
  failed_when: false
  changed_when: false

# etcdの検出結果をもとにVirtual Clusterで使用するイメージを決定して変数にセット
- name: Set detected etcd image as fact (successful detection)
  ansible.builtin.set_fact:
    virtualcluster_etcd_image: "{{ detected_etcd_image_result.stdout | trim }}"
  when: (detected_etcd_image_result.stdout | trim) != ''

# etcdのイメージ検出に失敗した場合は、k8s_etcd_major_minor 変数を使用してフォールバック値をセット
- name: Set etcd image fallback (detection failed)
  ansible.builtin.set_fact:
    virtualcluster_etcd_image: "registry.k8s.io/etcd:{{ k8s_etcd_major_minor }}.0"
  when: (detected_etcd_image_result.stdout | trim) == ''

# kube-apiserverの検出結果をもとにVirtual Clusterで使用するイメージを決定して変数にセット
- name: Set detected kube-apiserver image as fact (successful detection)
  ansible.builtin.set_fact:
    virtualcluster_apiserver_image: "{{ detected_apiserver_image_result.stdout | trim }}"
  when: (detected_apiserver_image_result.stdout | trim) != ''

# kube-apiserverのイメージ検出に失敗した場合は、k8s_major_minor 変数を使用してフォールバック値をセット
- name: Set kube-apiserver image fallback (detection failed)
  ansible.builtin.set_fact:
    virtualcluster_apiserver_image: "registry.k8s.io/kube-apiserver:v{{ k8s_major_minor }}.0"
  when: (detected_apiserver_image_result.stdout | trim) == ''

# kube-controller-managerの検出結果をもとにVirtual Clusterで使用するイメージを決定して変数にセット
- name: Set detected kube-controller-manager image as fact (successful detection)
  ansible.builtin.set_fact:
    virtualcluster_controller_manager_image: "{{ detected_controller_manager_image_result.stdout | trim }}"
  when: (detected_controller_manager_image_result.stdout | trim) != ''

# kube-controller-managerのイメージ検出に失敗した場合は、k8s_major_minor 変数を使用してフォールバック値をセット
- name: Set kube-controller-manager image fallback (detection failed)
  ansible.builtin.set_fact:
    virtualcluster_controller_manager_image: "registry.k8s.io/kube-controller-manager:v{{ k8s_major_minor }}.0"
  when: (detected_controller_manager_image_result.stdout | trim) == ''

# 検出/フォールバックされたイメージを表示
- name: Display detected/fallback images
  ansible.builtin.debug:
    msg: |
      Super Cluster container images (detected or fallback):
        etcd: {{ virtualcluster_etcd_image }}
        kube-apiserver: {{ virtualcluster_apiserver_image }}
        kube-controller-manager: {{ virtualcluster_controller_manager_image }}
