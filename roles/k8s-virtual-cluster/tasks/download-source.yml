#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  Virtual Cluster ソースコードのダウンロード
#
---

# Virtual Cluster リポジトリをクローン/更新
# virtualcluster_clean_build が true の場合は force: true でローカル変更を破棄して取得
# (パッチ適用済みファイルが残っている場合でもクリーンな状態に戻してから更新する)
- name: "Clone or update Virtual Cluster source repository"
  ansible.builtin.git:
    repo: "{{ virtualcluster_source_repo }}"
    dest: "{{ virtualcluster_source_dir }}"
    version: "{{ virtualcluster_source_version }}"
    update: true
    force: "{{ virtualcluster_clean_build | bool }}"
  delegate_to: "{{ virtualcluster_build_host }}"
  become: false
  register: result_git_clone
  run_once: true

# クローン結果を表示
- name: "Display git clone result"  # noqa: no-handler
  ansible.builtin.debug:
    msg: >
      Source repository cloned/updated at {{ virtualcluster_source_dir }}
      on {{ virtualcluster_build_host }}
  changed_when: false
  when: result_git_clone.changed
  run_once: true
