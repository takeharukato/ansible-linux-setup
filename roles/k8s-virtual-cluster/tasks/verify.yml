#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  Verify Virtual Cluster deployment
#
---

# vc-manager namespace, CRD, Podの存在を確認し, デプロイメントの成功を検証

# 1. vc-manager namespace の存在確認
- name: "Verify vc-manager namespace exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get namespace {{ virtualcluster_namespace }}"
  register: result_namespace
  changed_when: false
  failed_when: false
  become: true

# 2. ClusterVersion CRD の存在確認
- name: "Verify ClusterVersion CRD exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get crd clusterversions.{{ virtualcluster_api_group }}"
  register: result_clusterversion_crd_final
  changed_when: false
  failed_when: false
  become: true

# 3. VirtualCluster CRD の存在確認
- name: "Verify VirtualCluster CRD exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get crd virtualclusters.{{ virtualcluster_api_group }}"
  register: result_virtualcluster_crd_final
  changed_when: false
  failed_when: false
  become: true

# 4. vc-manager Deployment (Pod) が正常に稼働していることを確認
- name: "Verify vc-manager Pods are running"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get pods -n {{ virtualcluster_namespace }} -l app=vc-manager --no-headers"
  register: result_vc_manager_pods
  changed_when: false
  failed_when: false
  become: true

# 5. vn-agent Deployment (Pod) が正常に稼働していることを確認
- name: "Verify vn-agent Pods are running"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get pods -n {{ virtualcluster_namespace }} -l app=vn-agent --no-headers"
  register: result_vn_agent_pods
  changed_when: false
  failed_when: false
  become: true

# 6. デプロイメントのイベントを確認して, 問題がないことを検証
- name: "Display deployment completion summary"
  ansible.builtin.debug:
    msg: |
      Virtual Cluster Deployment Complete
      ====================================

      Namespace exists: {{ (result_namespace.rc == 0) | ternary('Yes', 'No') }}
      ClusterVersion CRD exists: {{ (result_clusterversion_crd_final.rc == 0) | ternary('Yes', 'No') }}
      VirtualCluster CRD exists: {{ (result_virtualcluster_crd_final.rc == 0) | ternary('Yes', 'No') }}
      vc-manager Pods: {{ result_vc_manager_pods.stdout_lines | length }}
      vn-agent Pods: {{ result_vn_agent_pods.stdout_lines | length }}

      You can verify resources with these commands:
        kubectl get namespace {{ virtualcluster_namespace }}
        kubectl get crd | grep virtualcluster
        kubectl -n {{ virtualcluster_namespace }} get pods
