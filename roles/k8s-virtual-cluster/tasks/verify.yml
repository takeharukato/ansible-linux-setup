#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  Verify Virtual Cluster deployment
#
---

# vc-manager namespace, CRD, Podの存在を確認し, デプロイメントの成功を検証

# 1. vc-manager namespace の存在確認
- name: "Verify vc-manager namespace exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get namespace {{ virtualcluster_namespace }}"
  register: result_namespace
  changed_when: false
  failed_when: false
  become: true

# 2. ClusterVersion CRD の存在確認
- name: "Verify ClusterVersion CRD exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get crd clusterversions.{{ virtualcluster_api_group }}"
  register: result_clusterversion_crd_final
  changed_when: false
  failed_when: false
  become: true

# 3. VirtualCluster CRD の存在確認
- name: "Verify VirtualCluster CRD exists"
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get crd virtualclusters.{{ virtualcluster_api_group }}"
  register: result_virtualcluster_crd_final
  changed_when: false
  failed_when: false
  become: true

# 4. vc-manager Deployment の詳細確認
- name: "Verify vc-manager Deployment status"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get deployment vc-manager -n {{ virtualcluster_namespace }}
      -o jsonpath='{.spec.replicas},{.status.readyReplicas}'
  register: result_vc_manager_deployment
  changed_when: false
  failed_when: false
  become: true

- name: "Parse vc-manager Deployment status"
  ansible.builtin.set_fact:
    vc_manager_replicas: "{{ result_vc_manager_deployment.stdout.split(',')[0] | default('0') }}"
    vc_manager_ready: "{{ result_vc_manager_deployment.stdout.split(',')[1] | default('0') }}"
  when: result_vc_manager_deployment.rc == 0

# 5. vc-syncer Deployment の詳細確認
- name: "Verify vc-syncer Deployment status"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get deployment vc-syncer -n {{ virtualcluster_namespace }}
      -o jsonpath='{.spec.replicas},{.status.readyReplicas}'
  register: result_vc_syncer_deployment
  changed_when: false
  failed_when: false
  become: true

- name: "Parse vc-syncer Deployment status"
  ansible.builtin.set_fact:
    vc_syncer_replicas: "{{ result_vc_syncer_deployment.stdout.split(',')[0] | default('0') }}"
    vc_syncer_ready: "{{ result_vc_syncer_deployment.stdout.split(',')[1] | default('0') }}"
  when: result_vc_syncer_deployment.rc == 0

# 6. vn-agent DaemonSet の詳細確認
- name: "Verify vn-agent DaemonSet status"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get daemonset vn-agent -n {{ virtualcluster_namespace }}
      -o jsonpath='{.status.desiredNumberScheduled},{.status.numberReady}'
  register: result_vn_agent_daemonset
  changed_when: false
  failed_when: false
  become: true

- name: "Parse vn-agent DaemonSet status"
  ansible.builtin.set_fact:
    vn_agent_desired: "{{ result_vn_agent_daemonset.stdout.split(',')[0] | default('0') }}"
    vn_agent_ready: "{{ result_vn_agent_daemonset.stdout.split(',')[1] | default('0') }}"
  when: result_vn_agent_daemonset.rc == 0

# 7. vc-manager Pods のステータス確認
- name: "Verify vc-manager Pods are running"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get pods -n {{ virtualcluster_namespace }} -l app=vc-manager
      -o jsonpath='{range .items[*]}{.metadata.name},{.status.phase},{.status.conditions[?(@.type=="Ready")].status}{"\n"}{end}'
  register: result_vc_manager_pods
  changed_when: false
  failed_when: false
  become: true

# 8. vc-syncer Pods のステータス確認
- name: "Verify vc-syncer Pods are running"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get pods -n {{ virtualcluster_namespace }} -l app=vc-syncer
      -o jsonpath='{range .items[*]}{.metadata.name},{.status.phase},{.status.conditions[?(@.type=="Ready")].status}{"\n"}{end}'
  register: result_vc_syncer_pods
  changed_when: false
  failed_when: false
  become: true

# 9. vn-agent Pods のステータス確認
- name: "Verify vn-agent Pods are running"
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }}
      get pods -n {{ virtualcluster_namespace }} -l app=vn-agent
      -o jsonpath='{range .items[*]}{.metadata.name},{.status.phase},{.status.conditions[?(@.type=="Ready")].status}{"\n"}{end}'
  register: result_vn_agent_pods
  changed_when: false
  failed_when: false
  become: true

# 10. デプロイメントの検証結果を表示
- name: "Display deployment verification summary"
  ansible.builtin.debug:
    msg: |
      Virtual Cluster Infrastructure Verification
      ============================================

      Namespace: {{ (result_namespace.rc == 0) | ternary('Exists', 'Missing') }}

      CRDs:
        ClusterVersion: {{ (result_clusterversion_crd_final.rc == 0) | ternary('Exists', 'Missing') }}
        VirtualCluster: {{ (result_virtualcluster_crd_final.rc == 0) | ternary('Exists', 'Missing') }}

      Components:
        vc-manager:  {{ vc_manager_ready | default('N/A') }}/{{ vc_manager_replicas | default('N/A') }} ready
        vc-syncer:   {{ vc_syncer_ready | default('N/A') }}/{{ vc_syncer_replicas | default('N/A') }} ready
        vn-agent:    {{ vn_agent_ready | default('N/A') }}/{{ vn_agent_desired | default('N/A') }} ready

      Verification commands:
        kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get namespace {{ virtualcluster_namespace }}
        kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} get crd | grep virtualcluster
        kubectl --kubeconfig {{ virtualcluster_supercluster_kubeconfig_path }} -n {{ virtualcluster_namespace }} get all
# 11. テナント操作補助スクリプトの存在確認
- name: "Verify tenant management scripts are deployed"
  ansible.builtin.stat:
    path: "{{ virtualcluster_tenant_tools_install_dir }}/{{ item }}"
  register: result_tenant_script_check
  loop:
    - vc-tenant-apply.sh
    - vc-tenant-get.sh
    - vc-tenant-delete.sh
    - vc-tenant-exec.sh
    - vc-tenant-logs.sh
  when: virtualcluster_tenant_tools_enabled | bool
  become: true

# 12. テナント操作補助スクリプトのヘルプ表示確認
- name: "Verify tenant management script functionality"
  ansible.builtin.command:
    cmd: "{{ virtualcluster_tenant_tools_install_dir }}/vc-tenant-apply.sh --help"
  register: result_tenant_script_help
  changed_when: false
  failed_when: false
  when: virtualcluster_tenant_tools_enabled | bool
  become: true

# 13. テナント操作補助スクリプドのデプロイ結果表示
- name: "Display tenant management tools verification"
  ansible.builtin.debug:
    msg: |
      Tenant Management Tools Verification
      ====================================

      Installation directory: {{ virtualcluster_tenant_tools_install_dir }}

      Scripts status:
      {% for script_check in result_tenant_script_check.results %}
        {{ script_check.item }}: {{ (script_check.stat.exists and script_check.stat.executable) | ternary('OK', 'MISSING or NOT EXECUTABLE') }}
      {% endfor %}

      Functionality test:
        vc-tenant-apply.sh --help: {{ (result_tenant_script_help.rc == 0) | ternary('OK', 'FAILED') }}

      Usage examples:
        vc-tenant-apply.sh <tenant-name> -f <manifest-file>
        vc-tenant-get.sh <tenant-name> pods
        vc-tenant-delete.sh <tenant-name> pod <pod-name>
        vc-tenant-exec.sh <tenant-name> <pod-name> -- <command>
        vc-tenant-logs.sh <tenant-name> <pod-name>
  when: virtualcluster_tenant_tools_enabled | bool

# 14. bash補完ファイルの存在確認
- name: "Verify bash completion file is deployed"
  ansible.builtin.stat:
    path: "{{ vc_tenant_bash_completion_path }}"
  register: result_bash_completion_check
  when:
    - virtualcluster_tenant_tools_enabled | bool
    - virtualcluster_tenant_tools_bash_completion_enabled | bool
  become: true

# 15. zsh補完ファイルの存在確認
- name: "Verify zsh completion file is deployed"
  ansible.builtin.stat:
    path: "{{ vc_tenant_zsh_completion_path }}"
  register: result_zsh_completion_check
  when:
    - virtualcluster_tenant_tools_enabled | bool
    - virtualcluster_tenant_tools_zsh_completion_enabled | bool
  become: true

# 16. シェル補完のデプロイ結果表示
- name: "Display shell completion verification"
  ansible.builtin.debug:
    msg: |
      Shell Completion Verification
      ==============================

      bash completion:
        Path: {{ vc_tenant_bash_completion_path }}
        Status: {{ (result_bash_completion_check.stat.exists | default(false)) | ternary('OK', 'MISSING or DISABLED') }}

      zsh completion:
        Path: {{ vc_tenant_zsh_completion_path }}
        Status: {{ (result_zsh_completion_check.stat.exists | default(false)) | ternary('OK', 'MISSING or DISABLED') }}

      Notes:
        - 新しいシェルセッションを開始すると補完が有効化されます
        - bash: source {{ vc_tenant_bash_completion_path }}
        - zsh: 新しいターミナルセッションを開始
  when: virtualcluster_tenant_tools_enabled | bool
