#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  kubectl-vc プラグインのビルド
#
---

# kubectl-vc をビルド
- name: "Build kubectl-vc plugin"
  ansible.builtin.shell:
    cmd: |
      set -e
      make build WHAT=cmd/kubectl-vc
    chdir: "{{ virtualcluster_source_dir }}/virtualcluster"
  delegate_to: "{{ virtualcluster_build_host }}"
  become: false
  register: result_build_kubectl_vc
  changed_when: true
  timeout: "{{ virtualcluster_build_timeout }}"
  run_once: true

# ビルド結果を表示
- name: "Display kubectl-vc build result"
  ansible.builtin.debug:
    var: result_build_kubectl_vc.stdout_lines
  when: result_build_kubectl_vc.stdout_lines is defined
  run_once: true

# ビルドされたバイナリの存在確認
- name: "Verify kubectl-vc binary exists"
  ansible.builtin.stat:
    path: "{{ virtualcluster_source_dir }}/virtualcluster/_output/bin/kubectl-vc"
  delegate_to: "{{ virtualcluster_build_host }}"
  become: false
  register: result_kubectl_vc_binary
  failed_when: not result_kubectl_vc_binary.stat.exists
  run_once: true

# kubectl-vcバイナリをコントロールプレーンノードにコピー
- name: "Copy kubectl-vc to control plane node"
  ansible.builtin.copy:
    src: "{{ virtualcluster_source_dir }}/virtualcluster/_output/bin/kubectl-vc"
    dest: "{{ virtualcluster_kubectl_vc_install_dir }}/{{ virtualcluster_kubectl_vc_binary }}"
    mode: '0755'
    owner: root
    group: root
  become: true
  when: inventory_hostname in groups['k8s_management']

# kubectl-vcのインストール確認
- name: "Verify kubectl-vc installation"
  ansible.builtin.command:
    cmd: "{{ virtualcluster_kubectl_vc_install_dir }}/{{ virtualcluster_kubectl_vc_binary }} --version"
  register: result_kubectl_vc_version
  changed_when: false
  failed_when: result_kubectl_vc_version.rc != 0
  when: inventory_hostname in groups['k8s_management']

# インストール確認結果を表示
- name: "Display kubectl-vc version"
  ansible.builtin.debug:
    var: result_kubectl_vc_version.stdout
  when:
    - inventory_hostname in groups['k8s_management']
    - result_kubectl_vc_version.stdout is defined
