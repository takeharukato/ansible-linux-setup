#  -*- mode: yaml; coding: utf-8; line-endings: unix -*-
#  SPDX-License-Identifier: BSD-2-Clause
#
#  Copyright (c) 2025 TAKEHARU KATO
#  This file is distributed under the two-clause BSD license.
#  For the full text of the license, see the LICENSE file in the project root directory.
#  このファイルは2条項BSDライセンスの下で配布されています。
#  ライセンス全文はプロジェクト直下の LICENSE を参照してください。

#
#  ロール固有変数のデフォルト値
#  group_vars/all/all.yml やhost_varsで上書き可能とするため,
#  ロール名/defaults/main.yml に定義している
#
---

#
# Virtual Cluster デプロイメント有効化フラグ
#
# デフォルトは無効, host_vars で true に設定すると有効化
k8s_virtualcluster_enabled: false

#
# ソースからVirtual Clusterのコンテナイメージをビルドするためのフラグ
#
# true: ソースダウンロードからビルドまで実行, false: 既存バイナリ/イメージを使用
# 既存のバイナリ/イメージは存在しないので, 実質的には常に true を設定
virtualcluster_build_from_source: true

#
# クリーンビルドの有効化フラグ
#
# true: 既存テナント/ClusterVersion/CRD/vc-manager名前空間を削除してから構築
# false: 既存リソースを残したまま構築(差分適用)
# デフォルトは true (毎回クリーンな状態から構築することを推奨)
virtualcluster_clean_build: true

# テナント名前空間 (vc-manager-*) の消滅を待機する最大時間 (単位: 秒)
# VirtualCluster 削除後, コントローラがテナント名前空間を後始末するまでの猶予時間
virtualcluster_tenant_ns_wait_timeout: 60

# テナント名前空間消滅待機時のポーリング間隔 (単位: 秒)
virtualcluster_tenant_ns_wait_delay: 5

# ビルド実行先ホスト
# Docker, Go, Make がインストール済みのホストを指定
virtualcluster_build_host: "localhost"

# Virtual Cluster ソースリポジトリ
virtualcluster_source_repo: "https://github.com/kubernetes-retired/cluster-api-provider-nested"

# ソースのバージョン/ブランチ/タグ
virtualcluster_source_version: "main"

# ソースダウンロード先ディレクトリ
virtualcluster_source_dir: "/tmp/cluster-api-provider-nested"

# ビルド対象コンポーネントリスト
virtualcluster_build_components:
  - manager
  - syncer
  - vn-agent

# ビルドタイムアウト(単位: 秒)
virtualcluster_build_timeout: 1800

# localhost(Ansibleコントローラー)上のイメージキャッシュディレクトリ
virtualcluster_local_cache_dir: "{{ lookup('env', 'HOME') }}/.ansible/vc-images-cache"

# コントロールプレーン上のイメージキャッシュディレクトリ
virtualcluster_ctrlplane_cache_dir: "/tmp/vc-images"

# Kubeadmで生成される設定保存ディレクトリパス
k8s_kubeadm_config_store: "{{ ansible_home_dir }}/kubeadm"

# K8sクラスタ(スーパークラスタ)操作に使用するkubeconfigのパス
virtualcluster_supercluster_kubeconfig_path: "/etc/kubernetes/admin.conf"

# Virtual Cluster 管理コンポーネント用 namespace
virtualcluster_namespace: "vc-manager"

# Virtual Cluster 設定ファイル格納ディレクトリパス
virtualcluster_config_dir: "{{ k8s_kubeadm_config_store }}/virtual-cluster"

# スーパークラスタから現在稼働中のetcd, kube-apiserver, kube-controller-managerイメージ版数を実行時に検出するかどうか
# true: スーパークラスタの実行中Podから検出（推奨）, false: 下記のフォールバック値を使用
virtualcluster_auto_detect_supercluster_images: true

#
# Virtual Cluster manager related images
#
# Virtual Clusterの管理コンポーネントである vc-manager, syncer, vn-agent のイメージ
# Docker Hubの公式レジストリからイメージが提供されている場合は, Docker Hubのイメージを
# 使用することが推奨されることからプレースホルダとして記載。
# 実際上は, Docker Hubの公式レジストリにはvirtual clusterの最新のイメージが
# 提供されていないため, ソースからビルドして構築する。
#
# vc-manager image (from Docker Hub official registry)
virtualcluster_manager_image: "virtualcluster/manager-amd64:latest"
# syncer image (from Docker Hub official registry)
virtualcluster_syncer_image: "virtualcluster/syncer-amd64:latest"
# vn-agent image (from Docker Hub official registry)
virtualcluster_vn_agent_image: "virtualcluster/vn-agent-amd64:latest"

# テナントコントロールプレイン Pod のリソースリクエスト
virtualcluster_pod_resource_requests:
  cpu: "500m"
  memory: "512Mi"

# テナントコントロールプレイン Pod のリソースリミット
virtualcluster_pod_resource_limits:
  cpu: "1000m"
  memory: "1Gi"

# virtual cluster etcd StatefulSet のレプリカ数
virtualcluster_etcd_replicas: 1

# virtual cluster apiserver StatefulSet のレプリカ数
virtualcluster_apiserver_replicas: 1

# virtual cluster controller-manager StatefulSet のレプリカ数
virtualcluster_controller_manager_replicas: 1

#
# kube-api待機設定
#
# Kubernetes APIサーバの待ち合わせ先(接続先)ホスト名/IPアドレス
k8s_api_wait_host: "{{ k8s_ctrlplane_endpoint }}"
# Kubernetes APIサーバの待ち合わせ先ポート番号
k8s_api_wait_port: "{{ k8s_ctrlplane_port }}"
# Kubernetes APIサーバ待ち合わせ時間(単位: 秒)
k8s_api_wait_timeout: 600
# Kubernetes APIサーバ待ち合わせる際の開始遅延時間(単位: 秒)
k8s_api_wait_delay: 2
# Kubernetes APIサーバ待ち合わせる際の待機間隔(単位: 秒)
k8s_api_wait_sleep: 1
# Kubernetes APIサーバ待ち合わせる際の接続元ホスト名/IPアドレス
k8s_api_wait_delegate_to: "localhost"

#
# kubectl-vc plugin settings
#
# kubectl-vcプラグインのインストール先ディレクトリ
virtualcluster_kubectl_vc_install_dir: "/usr/local/bin"
# kubectl-vcプラグインのバイナリ名
virtualcluster_kubectl_vc_binary: "kubectl-vc"
# kubectl-vcプラグインをビルドするかどうか
# true: ソースからビルド, false: ビルドをスキップ
virtualcluster_build_kubectl_vc: true

#
# テナント操作補助スクリプト設定
#
# テナント操作補助スクリプトの配置を有効化するフラグ
# true: スクリプト配置を実行, false: スキップ
virtualcluster_tenant_tools_enabled: true
# テナント操作補助スクリプトのインストール先ディレクトリ
virtualcluster_tenant_tools_install_dir: "/usr/local/bin"
# bash補完の有効化フラグ
# true: bash補完を配置, false: スキップ
virtualcluster_tenant_tools_bash_completion_enabled: true
# zsh補完の有効化フラグ
# true: zsh補完を配置, false: スキップ
virtualcluster_tenant_tools_zsh_completion_enabled: true

#
# PersistentVolume 設定 (オプション)
#
# host_vars で定義することで、任意のPVを作成できる
#
# 例:
#
# virtualcluster_persistent_volumes:
#   - name: "pv-etcd-alpha"
#     capacity: "10Gi"
#     storage_class: "default-sc"
#     host_path: "/mnt/etcd-data/alpha"
#     node_name: "k8sworker0101"
#     access_modes: ["ReadWriteOnce"]
#     reclaim_policy: "Delete"
#     labels:
#       type: "local"
#       purpose: "etcd"
#   - name: "pv-etcd-beta"
#     capacity: "10Gi"
#     storage_class: "default-sc"
#     host_path: "/mnt/etcd-data/beta"
#     node_name: "k8sworker0102"
