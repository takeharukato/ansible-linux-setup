# Docker composeを使用したOpenLDAPサーバ

osixia/openldapを使用してOpenLDAPサーバを構築。

## phpLDAPadminでのログイン

インストール先ホストにWEBブラウザから以下のようにアクセスする
ポート番号は, `group_vars/all.yml`に記載されている`ldap_admin_port`の値(デフォルトは, `10443`)を指定する。

```
https://ホスト名:10443/
```

ログイン時は, commonName (cn) に`admin`を指定, ドメイン名を元にDomain Component(dc)を指定する。

'.' で区切られたドメイン名の各要素をdc=要素名,dc=要素名として並べてDomain Component(dc)を指定する。

ドメイン名がexample.comの場合, 以下を`login`名に入力する
```
cn=admin,dc=elliptic-curve,dc=net
```

パスワードは, `group_vars/all.yml`に記載されている`ldap_admin_password`の値(デフォルトは, `ldap`)を入力する。

## バックアップ方法

以下のバックアップスクリプトを実行すると, LDAPの設定・データベースをカレントディレクトリにバックアップする。

- config-backup.tar LDAPの設定
- data-backup.tar   LDAPのデータベース
- phpadmin-backup.tar phpldapadminのデータ

事前に,

```
cd /data/openldap/docker
docker-compose pause
```

を実行してコンテナ内のプロセスを停止してから
`/data/openldap/scripts/backup-ldap-data.sh`スクリプトを実行する。
`backup-ldap-data.sh`スクリプトは, 以下の処理を行う。

- カレントディレクトリをコンテナの/backupディレクトリにマウント
- busyboxのコンテナを起動
- tar コマンドで/etc/ldap/slapd.d, /var/lib/ldapディレクトリを, それぞれ, config-backup.tar, data-backup.tar, phpadmin-backup.tarに保存
- コンテナを破棄

```:backup-ldap-data.sh
#!/bin/sh
#  -*- coding:utf-8 mode:bash -*-
#
# busyboxのコンテナイメージを使用して, 以下の内容をopenldapコンテナ内
# の以下のファイルをカレントディレクトリにtar形式で保存する
#
# a) openldapの設定ファイル(openldapのコンテナ中の/etc/ldap/slapd.d ディレクトリの内容)
# b) openldapのデータベース(openldapのコンテナ中の/var/lib/ldap ディレクトリの内容)
# c) phpldapadminの設定 (phpldapadminのコンテナ中の/var/www/phpldapadmin ディレクトリの内容)
#

# 1) openldapのコンテナIDを取得する
ldap_container_id=`docker ps|grep osixia/openldap:|awk -F ' ' '{print $1;}'`

# 2) phpldapadminのコンテナIDを取得する
phpadmin_container_id=`docker ps|grep osixia/phpldapadmin:|awk -F ' ' '{print $1;}'`

# 3) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, openldapコンテナ内のボリュームを参照し,
# openldapの設定ファイルディレクトリ(/etc/ldap/slapd.d)の内容をカレントディ
# レクトリのconfig-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${ldap_container_id}" -v `pwd`:/backup busybox tar cvf /backup/config-backup.tar /etc/ldap/slapd.d

# 4) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, openldapコンテナ内のボリュームを参照し,
# openldapのデータベースディレクトリ(/var/lib/ldap)の内容をカレントディ
# レクトリのconfig-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${ldap_container_id}" -v `pwd`:/backup busybox tar cvf /backup/data-backup.tar /var/lib/ldap

# 5) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, phpldapadminコンテナ内のボリュームを参照し,
# phpladpadminの設定ファイルディレクトリ(/var/www/phpldapadmin)の内容をカレントディ
# レクトリのphpadmin-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${phpadmin_container_id}" -v `pwd`:/backup busybox tar cvf /backup/phpadmin-backup.tar /var/www/phpldapadmin
```

上記が完了したら以下のコマンドを実行して, コンテナを再開する。

```
cd /data/openldap/docker
docker-compose unpause
```

## リストア方法

以下のリストアスクリプトを実行すると, LDAPの設定・データベースをカレントディレクトリのconfig-backup.tar, data-backup.tar, phpadmin-backup.tar からリストアする。

事前に,

```
cd /data/openldap/docker
docker-compose pause
```

を実行してコンテナ内のプロセスを停止してから
`/data/openldap/scripts/restore-ldap-data.sh`スクリプトを実行する。
`restore-ldap-data.sh`スクリプトは, 以下の処理を行う。

- カレントディレクトリをコンテナの/backupディレクトリにマウント
- busyboxのコンテナを起動
- tar コマンドで/etc/ldap/slapd.d, /var/lib/ldapディレクトリを, それぞれ, config-backup.tar, data-backup.tar, phpadmin-backup.tarから展開
- コンテナを破棄

```:restore-ldap-data.sh
#!/bin/sh
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
#
# busyboxのコンテナイメージを使用して, ホスト上のカレントディレクトリにあるtarファイルの
# 内容をopenldapコンテナ内で定義されているボリュームに展開する
#

# 1) openldapのコンテナIDを取得する
container_id=`docker ps|grep osixia/openldap:|awk -F ' ' '{print $1;}'`

# 2) phpldapadminのコンテナIDを取得する
phpadmin_container_id=`docker ps|grep osixia/phpldapadmin:|awk -F ' ' '{print $1;}'`

# 3) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントした上で,
# openldapコンテナのボリュームを参照可能にして, busyboxのコンテナを生成し,
# カレントディレクトリにあるconfig-backup.tarの内容をopenldapのコンテナ内に展開する
docker run --rm --volumes-from "${container_id}" -v `pwd`:/backup busybox tar xvf /backup/config-backup.tar -C /

# 4) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントした上で,
# openldapコンテナのボリュームを参照可能にして, busyboxのコンテナを生成し,
# カレントディレクトリにあるdata-backup.tarの内容をopenldapのコンテナ内に展開する
docker run --rm --volumes-from "${container_id}" -v `pwd`:/backup busybox tar xvf /backup/data-backup.tar -C /

# 4) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントした上で,
# phpldapadminコンテナのボリュームを参照可能にして, busyboxのコンテナを生成し,
# カレントディレクトリにあるphpadmin-backup.tarの内容をopenldapのコンテナ内に展開する
docker run --rm --volumes-from "${phpadmin_container_id}" -v `pwd`:/backup busybox tar xvf /backup/phpadmin-backup.tar -C /
```


上記が完了したら以下のコマンドを実行して, コンテナを再開する。

```
cd /data/openldap/docker
docker-compose unpause
```
