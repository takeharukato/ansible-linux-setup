#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  サービス関連処理
#
- name: Stop openldap container
  ansible.builtin.shell: |
    cd "{{ openldap_docker_dir }}"
    docker compose down
  ignore_errors: true
  register: _result
  changed_when: _result.rc == 0

# コンテナの停止を待ち合わせる
- name: Wait for stop LDAP container
  ansible.builtin.wait_for:
    host: "{{ openldap_wait_host_stopped }}"
    port: "{{ openldap_service_port }}"
    state: stopped
    timeout: "{{ openldap_wait_timeout }}"
    delay: "{{ openldap_wait_delay }}"
    sleep: "{{ openldap_wait_sleep }}"
  delegate_to: "{{ openldap_wait_delegate_to }}"

- name: Start openldap container
  ansible.builtin.shell: |
    cd "{{ openldap_docker_dir }}"
    docker compose up -d
  ignore_errors: true
  register: _result
  changed_when: _result.rc == 0

# コンテナの開始を待ち合わせる
- name: Wait for start LDAP container
  ansible.builtin.wait_for:
    host: "{{ openldap_wait_host_started }}"
    port: "{{ openldap_service_port }}"
    state: started
    timeout: "{{ openldap_wait_timeout }}"
    delay: "{{ openldap_wait_delay }}"
    sleep: "{{ openldap_wait_sleep }}"
  delegate_to: "{{ openldap_wait_delegate_to }}"
