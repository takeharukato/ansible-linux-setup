#!/bin/sh
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}
#
# busyboxのコンテナイメージを使用して, 以下の内容をopenldapコンテナ内
# の以下のファイルをカレントディレクトリにtar形式で保存する
#
# a) openldapの設定ファイル(openldapのコンテナ中の/etc/ldap/slapd.d ディレクトリの内容)
# b) openldapのデータベース(openldapのコンテナ中の/var/lib/ldap ディレクトリの内容)
# c) phpldapadminの設定 (phpldapadminのコンテナ中の/var/www/phpldapadmin ディレクトリの内容)
#

# 1) openldapのコンテナIDを取得する
ldap_container_id=`docker ps|grep osixia/openldap:|awk -F ' ' '{print $1;}'`

# 2) phpldapadminのコンテナIDを取得する
phpadmin_container_id=`docker ps|grep osixia/phpldapadmin:|awk -F ' ' '{print $1;}'`

# 3) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, openldapコンテナ内のボリュームを参照し,
# openldapの設定ファイルディレクトリ(/etc/ldap/slapd.d)の内容をカレントディ
# レクトリのconfig-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${ldap_container_id}" -v `pwd`:/backup busybox tar cvf /backup/config-backup.tar /etc/ldap/slapd.d

# 4) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, openldapコンテナ内のボリュームを参照し,
# openldapのデータベースディレクトリ(/var/lib/ldap)の内容をカレントディ
# レクトリのconfig-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${ldap_container_id}" -v `pwd`:/backup busybox tar cvf /backup/data-backup.tar /var/lib/ldap

# 5) ホストのカレントディレクトリをコンテナ内の/backupディレクトリにマウントして
# busyboxのコンテナを生成, phpldapadminコンテナ内のボリュームを参照し,
# phpladpadminの設定ファイルディレクトリ(/var/www/phpldapadmin)の内容をカレントディ
# レクトリのphpadmin-backup.tarにtar形式で保存する
docker run --rm --volumes-from "${phpadmin_container_id}" -v `pwd`:/backup busybox tar cvf /backup/phpadmin-backup.tar /var/www/phpldapadmin
