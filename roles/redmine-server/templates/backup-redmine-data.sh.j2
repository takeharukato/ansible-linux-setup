#!/bin/bash
#  -*- coding:utf-8 mode:bash -*-
# This file is generated by ansible.
{# 日付の取得 #}
# last update: {{ '%Y-%m-%d %H:%M:%S %Z' | strftime(ansible_date_time.epoch) }}

#
# Redmine用バックアップスクリプト
#

# alpineの最新版を使用して一時的なコンテナを起動
TEMPORARY_IMAGE="alpine:latest"

# バックアップ置き場
mkdir -p {{redmine_backup_dir|default('/data/redmine/backup', true)}}

if [ -d "{{redmine_docker_dir|default('/data/redmine/docker', true)}}" ]; then

    pushd "{{redmine_docker_dir|default('/data/redmine/docker', true)}}"

    # Redmine の files をアーカイブ
    # 一時コンテナ ( Alpine Linux イメージ ) を起動し, 終了時に自動削除(`--rm`)。
    # ボリューム `{{redmine_files_volume|default('redmine_vol_files', true)}}` をコンテナ内 `/from` に,
    # バックアップ先ディレクトリ `{{redmine_backup_dir|default('/data/redmine/backup', true)}}` を `/to` に,
    # 読み書きマウント ( `-v`）。
    # コンテナ内で `/from`(=バックアップ元のボリュームマウント)へ移動し, `tar czf` で,
    # `/to/{{redmine_files_backup_name|default('redmine_files.tgz', true)}}` (バックアップアーカイブ)へアーカイブ。
    # (`c` (作成), `z` (gzip 圧縮), `f`(ファイル指定) )。
    docker run --rm -v {{redmine_files_volume|default('redmine_vol_files', true)}}:/from -v "{{redmine_backup_dir|default('/data/redmine/backup', true)}}:/to" "${TEMPORARY_IMAGE}" \
        sh -c 'cd /from && tar czf "/to/{{redmine_files_backup_name|default('redmine_files.tgz', true)}}" .'

    # Redmine の データベースをバックアップ
    # `docker compose exec -T {{redmine_db_service|default('redmine-db', true)}}` で, 対話型端末を割り当てずに (`-T`), コマンドを実行。
    # {{redmine_db_service|default('redmine-db', true)}} サービスのコンテナ内で,
    # `pg_dump` コマンドを実行し, 出力をリダイレクト(`>`)で,
    # `{{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_name|default('redmine.dump', true)}}` へ保存。
    sudo sh -c "docker compose exec -T {{redmine_db_service|default('redmine-db', true)}} pg_dump -U {{redmine_db_user|default('redmine_user', true)}} -d {{redmine_db_name|default('redmine', true)}} -Fc > {{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_name|default('redmine.dump', true)}}"

    if [ -f "{{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_name|default('redmine.dump', true)}}" ]; then

        if [ -f "{{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_gzip|default('redmine.dump.gz', true)}}" ]; then

            sudo rm -f "{{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_gzip|default('redmine.dump.gz', true)}}"
        fi

        sudo gzip -9 "{{redmine_backup_dir|default('/data/redmine/backup', true)}}/{{redmine_dbdata_backup_name|default('redmine.dump', true)}}"
    fi

    popd

fi
