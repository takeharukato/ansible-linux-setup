#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  サービス関連処理
#
- name: Stop redmine container
  ansible.builtin.shell: |
    cd "{{ redmine_docker_dir }}"
    docker compose down
  ignore_errors: true
  register: _result
  changed_when: _result.rc == 0

# コンテナの停止を待ち合わせる
- name: Wait for stop redmine container
  ansible.builtin.wait_for:
    host: "{{ redmine_wait_host_stopped }}"
    port: "{{ redmine_service_port }}"
    state: stopped
    timeout: "{{ redmine_wait_timeout }}"
    delay: "{{ redmine_wait_delay }}"
    sleep: "{{ redmine_wait_sleep }}"

- name: Start redmine container
  ansible.builtin.shell: |
    cd "{{ redmine_docker_dir }}"
    docker compose up -d
  ignore_errors: true
  register: _result
  changed_when: _result.rc == 0

# コンテナの開始を待ち合わせる
- name: Wait for start redmine container
  ansible.builtin.wait_for:
    host: "{{ redmine_wait_host_started }}"
    port: "{{ redmine_service_port }}"
    state: started
    timeout: "{{ redmine_wait_timeout }}"
    delay: "{{ redmine_wait_delay }}"
    sleep: "{{ redmine_wait_sleep }}"

# redmine管理者パスワード設定
- name: Ensure Redmine admin password
  ansible.builtin.shell: |
    set -o pipefail
    cd "{{ redmine_docker_dir }}"
    admin_user="{{ redmine_admin_user | default('admin', true) }}"
    admin_password="{{ redmine_admin_password | default('admin', true) }}"
    docker compose exec -T \
      -e ADMIN_USER="$admin_user" \
      -e ADMIN_PASSWORD="$admin_password" \
      "{{ redmine_service }}" \
      bash -lc "bundle exec rails runner \"u=User.find_by(login: ENV['ADMIN_USER']); if u; pw=ENV['ADMIN_PASSWORD'].to_s; u.password=pw; u.password_confirmation=pw; u.admin=true; if pw.length < 8; u.save!(validate: false); else u.save!; end; end\""
  args:
    executable: /bin/bash
  ignore_errors: true
  register: _result
  changed_when: _result.rc == 0
