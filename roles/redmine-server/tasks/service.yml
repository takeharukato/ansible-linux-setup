#  -*- coding:utf-8 mode:yaml -*-
#  Ansible playbook
#  Copyright 2020 Takeharu KATO All Rights Reserved.
#
#  サービス関連処理
#
- name: Stop redmine container
  shell: |
    cd "{{ redmine_docker_dir }}"
    docker compose down
  ignore_errors: true

# コンテナの停止を待ち合わせる
- name: Wait for stop redmine container
  local_action: wait_for host={{ inventory_hostname }} port={{ redmine_service_port }} state=stopped

- name: Start redmine container
  shell: |
    cd "{{ redmine_docker_dir }}"
    docker compose up -d
  ignore_errors: true

# コンテナの開始を待ち合わせる
- name: Wait for start redmine container
  local_action: wait_for host={{ inventory_hostname }} port={{ redmine_service_port }} state=started

# redmine管理者パスワード設定
- name: Ensure Redmine admin password
  shell: |
    cd "{{ redmine_docker_dir }}"
    admin_user="{{ redmine_admin_user | default('admin', true) }}"
    admin_password="{{ redmine_admin_password | default('admin', true) }}"
    docker compose exec -T \
      -e ADMIN_USER="$admin_user" \
      -e ADMIN_PASSWORD="$admin_password" \
      "{{ redmine_service }}" \
      bash -lc "bundle exec rails runner \"u=User.find_by(login: ENV['ADMIN_USER']); if u; pw=ENV['ADMIN_PASSWORD'].to_s; u.password=pw; u.password_confirmation=pw; u.admin=true; if pw.length < 8; u.save!(validate: false); else u.save!; end; end\""
  ignore_errors: true
